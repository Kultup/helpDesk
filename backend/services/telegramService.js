const TelegramBot = require('node-telegram-bot-api');
const mongoose = require('mongoose');
const User = require('../models/User');
const Ticket = require('../models/Ticket');
const City = require('../models/City');
const Position = require('../models/Position');
const TicketTemplate = require('../models/TicketTemplate');
const PendingRegistration = require('../models/PendingRegistration');
const logger = require('../utils/logger');
const fs = require('fs');
const path = require('path');
const https = require('https');
const Category = require('../models/Category');
const BotSettings = require('../models/BotSettings');
const { formatFileSize } = require('../utils/helpers');
const ticketWebSocketService = require('./ticketWebSocketService');

class TelegramService {
  constructor() {
    this.bot = null;
    this.isInitialized = false; // –î–æ–¥–∞—î–º–æ —Ñ–ª–∞–≥ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó
    this.userSessions = new Map();
    this.userStates = new Map();
    this.stateStack = new Map();
    this.categoryCache = new Map(); // –ö–µ—à –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä—ñ–π
    this.botSettings = null; // –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –±–æ—Ç–∞ –∑ –ë–î
    this.loadCategories(); // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó –ø—Ä–∏ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó
    this.loadBotSettings(); // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –±–æ—Ç–∞
  }

  async initialize() {
    try {
      const token = process.env.TELEGRAM_BOT_TOKEN;
      if (!token) {
        logger.error('TELEGRAM_BOT_TOKEN –Ω–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
        this.isInitialized = false;
        return;
      }

      this.bot = new TelegramBot(token, { polling: false });
      this.isInitialized = true; // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ —Ñ–ª–∞–≥ –ø—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ—ó —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó
      logger.info('‚úÖ Telegram –±–æ—Ç —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ');

      // –û–Ω–æ–≤–ª—é—î–º–æ –∫–µ—à –∫–∞—Ç–µ–≥–æ—Ä—ñ–π –ø—ñ—Å–ª—è —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó –±–æ—Ç–∞
      try {
        await this.loadBotSettings();
        await this.loadCategories();
        logger.info('‚úÖ –ö–∞—Ç–µ–≥–æ—Ä—ñ—ó –æ–Ω–æ–≤–ª–µ–Ω–æ –ø—ñ—Å–ª—è —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó');
      } catch (catErr) {
        logger.warn('‚ö†Ô∏è –ù–µ –≤–¥–∞–ª–æ—Å—è –æ–Ω–æ–≤–∏—Ç–∏ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó –ø—ñ—Å–ª—è —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó:', catErr);
      }
    } catch (error) {
      logger.error('–ü–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó Telegram –±–æ—Ç–∞:', error);
      this.isInitialized = false;
    }
  }

  async sendMessage(chatId, text, options = {}) {
    try {
      if (!this.bot) {
        logger.error('Telegram –±–æ—Ç –Ω–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ');
        return;
      }
      // –î–æ–¥–∞—î–º–æ –ø—ñ–¥—Ç—Ä–∏–º–∫—É Markdown —Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º
      const defaultOptions = { parse_mode: 'Markdown', ...options };
      logger.debug(`–í—ñ–¥–ø—Ä–∞–≤–ª—è—é –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤ —á–∞—Ç ${chatId}`, { text: text?.substring(0, 50) });
      const result = await this.bot.sendMessage(chatId, text, defaultOptions);
      logger.debug(`–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —É—Å–ø—ñ—à–Ω–æ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ —á–∞—Ç ${chatId}`, { messageId: result.message_id });
      return result;
    } catch (error) {
      logger.error('–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è:', {
        chatId,
        error: error.message,
        stack: error.stack,
        response: error.response?.data
      });
      throw error;
    }
  }

  async deleteMessage(chatId, messageId) {
    try {
      if (!this.bot) {
        logger.error('Telegram –±–æ—Ç –Ω–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ');
        return;
      }
      return await this.bot.deleteMessage(chatId, messageId);
    } catch (error) {
      logger.error('–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è:', error);
      throw error;
    }
  }

  async handleMessage(msg) {
    try {
      const chatId = msg.chat.id;
      const userId = msg.from.id;
      
      logger.info(`–û—Ç—Ä–∏–º–∞–Ω–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤—ñ–¥ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ ${userId} –≤ —á–∞—Ç—ñ ${chatId}`, {
        text: msg.text?.substring(0, 100),
        hasPhoto: !!msg.photo,
        hasContact: !!msg.contact
      });

      // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞, —á–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤–∂–µ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–∏–π
      // –ö–æ–Ω–≤–µ—Ä—Ç—É—î–º–æ userId –≤ —Ä—è–¥–æ–∫, –æ—Å–∫—ñ–ª—å–∫–∏ telegramId –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è —è–∫ String
      const existingUser = await User.findOne({ 
        $or: [
          { telegramId: String(userId) },
          { telegramId: userId }
        ]
      })
        .populate('position', 'name')
        .populate('city', 'name');
      
      // –Ø–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤–∂–µ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–∏–π, –ø–æ–∫–∞–∑—É—î–º–æ –≥–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é
      if (existingUser && !msg.text?.startsWith('/')) {
        // –û–±—Ä–æ–±–∫–∞ —Ñ–æ—Ç–æ –¥–ª—è –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤
        if (msg.photo) {
          await this.handlePhoto(msg);
          return;
        }

        // –û–±—Ä–æ–±–∫–∞ –∫–æ–Ω—Ç–∞–∫—Ç—ñ–≤ –¥–ª—è –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤
        if (msg.contact) {
          await this.handleContact(msg);
          return;
        }

        // –Ø–∫—â–æ —Ü–µ –Ω–µ –∫–æ–º–∞–Ω–¥–∞, –ø–æ–∫–∞–∑—É—î–º–æ –≥–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é –∞–±–æ –æ–±—Ä–æ–±–ª—è—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
        if (!msg.text?.startsWith('/')) {
          // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ —î –∞–∫—Ç–∏–≤–Ω–∞ —Å–µ—Å—ñ—è –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç—ñ–∫–µ—Ç—É
          const session = this.userSessions.get(chatId);
          if (session) {
            await this.handleTextMessage(msg);
            return;
          }
          // –Ø–∫—â–æ –Ω–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–æ—ó —Å–µ—Å—ñ—ó, –ø–æ–∫–∞–∑—É—î–º–æ –≥–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é
          await this.showUserDashboard(chatId, existingUser);
          return;
        }
      }

      // –û–±—Ä–æ–±–∫–∞ —Ñ–æ—Ç–æ
      if (msg.photo) {
        await this.handlePhoto(msg);
        return;
      }

      // –û–±—Ä–æ–±–∫–∞ –∫–æ–Ω—Ç–∞–∫—Ç—ñ–≤ (–ø–æ–¥—ñ–ª–∏—Ç–∏—Å—è –Ω–æ–º–µ—Ä–æ–º)
      if (msg.contact) {
        await this.handleContact(msg);
        return;
      }

      // –û–±—Ä–æ–±–∫–∞ –∫–æ–º–∞–Ω–¥
      if (msg.text && msg.text.startsWith('/')) {
        logger.info(`–û–±—Ä–æ–±–∫–∞ –∫–æ–º–∞–Ω–¥–∏: ${msg.text}`);
        await this.handleCommand(msg);
        return;
      }

      // –û–±—Ä–æ–±–∫–∞ –∑–≤–∏—á–∞–π–Ω–∏—Ö –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
      await this.handleTextMessage(msg);
    } catch (error) {
      logger.error('–ü–æ–º–∏–ª–∫–∞ –æ–±—Ä–æ–±–∫–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è:', {
        error: error.message,
        stack: error.stack,
        chatId: msg.chat?.id,
        userId: msg.from?.id
      });
      try {
        await this.sendMessage(msg.chat.id, '–í–∏–Ω–∏–∫–ª–∞ –ø–æ–º–∏–ª–∫–∞. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.');
      } catch (sendError) {
        logger.error('–ù–µ –≤–¥–∞–ª–æ—Å—è –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –ø–æ–º–∏–ª–∫—É:', sendError);
      }
    }
  }

  async handleCommand(msg) {
    const chatId = msg.chat.id;
    const userId = msg.from.id;
    const command = msg.text.split(' ')[0];

    try {
      // –ö–æ–Ω–≤–µ—Ä—Ç—É—î–º–æ userId –≤ —Ä—è–¥–æ–∫ –¥–ª—è –ø–æ—à—É–∫—É
      const user = await User.findOne({ 
        $or: [
          { telegramId: String(userId) },
          { telegramId: userId }
        ]
      });

      switch (command) {
        case '/start':
          await this.handleStartCommand(chatId, userId, msg);
          break;
        default:
          if (!user) {
            await this.sendMessage(chatId, 
              `üö´ *–ü–æ–º–∏–ª–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó*\n\n` +
              `–í–∏ –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ñ –≤ —Å–∏—Å—Ç–µ–º—ñ.\n\n` +
              `üîë –í–∏–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ /start –¥–ª—è –ø–æ—á–∞—Ç–∫—É —Ä–æ–±–æ—Ç–∏.`
            );
            return;
          }
          await this.sendMessage(chatId, 
            `‚ùì *–ù–µ–≤—ñ–¥–æ–º–∞ –∫–æ–º–∞–Ω–¥–∞*\n\n` +
            `–ö–æ–º–∞–Ω–¥–∞ –Ω–µ —Ä–æ–∑–ø—ñ–∑–Ω–∞–Ω–∞ —Å–∏—Å—Ç–µ–º–æ—é.\n\n` +
            `üí° –í–∏–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ /start –¥–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É –¥–æ—Å—Ç—É–ø–Ω–∏—Ö –æ–ø—Ü—ñ–π.`
          );
      }
    } catch (error) {
      logger.error('–ü–æ–º–∏–ª–∫–∞ –æ–±—Ä–æ–±–∫–∏ –∫–æ–º–∞–Ω–¥–∏:', error);
      await this.sendMessage(chatId, 
        `‚ùå *–°–∏—Å—Ç–µ–º–Ω–∞ –ø–æ–º–∏–ª–∫–∞*\n\n` +
        `–í–∏–Ω–∏–∫–ª–∞ –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ–±—Ä–æ–±—Ü—ñ –∫–æ–º–∞–Ω–¥–∏.\n\n` +
        `üîÑ –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑ –∞–±–æ –∑–≤–µ—Ä–Ω—ñ—Ç—å—Å—è –¥–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞: [@Kultup](https://t.me/Kultup)`,
        { parse_mode: 'Markdown' }
      );
    }
  }

  async handleStartCommand(chatId, userId, msg) {
    try {
      // –ö–æ–Ω–≤–µ—Ä—Ç—É—î–º–æ userId —Ç–∞ chatId –≤ —Ä—è–¥–∫–∏ –¥–ª—è –ø–æ—à—É–∫—É
      const userIdString = String(userId);
      const chatIdString = String(chatId);
      const usernameFromMsg = msg?.from?.username
        ? msg.from.username.replace(/^@/, '').toLowerCase()
        : null;
      
      // –°–ø–æ—á–∞—Ç–∫—É —à—É–∫–∞—î–º–æ –∑–∞ telegramId
      let user = await User.findOne({ 
        $or: [
          { telegramId: userIdString },
          { telegramId: userId }
        ]
      })
        .populate('position', 'name')
        .populate('city', 'name');
      
      // –î–æ–¥–∞—Ç–∫–æ–≤–∏–π –ø–æ—à—É–∫: —è–∫—â–æ telegramId –∑–±–µ—Ä–µ–∂–µ–Ω–∏–π —ñ–∑ –ø—Ä–µ—Ñ—ñ–∫—Å–æ–º '@' –∞–±–æ –ø—Ä–æ–±—ñ–ª–∞–º–∏
      if (!user) {
        const prefixedId = `@${userIdString}`;
        const spacedId = ` ${userIdString} `;
        user = await User.findOne({
          telegramId: {
            $in: [prefixedId, spacedId, `@ ${userIdString}`, `${userIdString} `]
          }
        })
        .populate('position', 'name')
        .populate('city', 'name');
      
      if (user) {
          logger.info('–ó–Ω–∞–π–¥–µ–Ω–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∑ telegramId —É —Ñ–æ—Ä–º–∞—Ç—ñ –∑ –ø—Ä–µ—Ñ—ñ–∫—Å–æ–º –∞–±–æ –ø—Ä–æ–±—ñ–ª–∞–º–∏. –û–Ω–æ–≤–ª—é—î–º–æ –∑–Ω–∞—á–µ–Ω–Ω—è.', {
            userId: user._id,
            email: user.email,
            storedTelegramId: user.telegramId,
            sanitizedTelegramId: userIdString
          });
          user.telegramId = userIdString;
          await user.save();
        }
      }
      
      // –Ø–∫—â–æ –¥–æ—Å—ñ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ, –ø—Ä–æ–±—É—î–º–æ –∑–Ω–∞–π—Ç–∏ –∑–∞ telegramChatId
      if (!user) {
        logger.info('–ü—Ä–æ–±—É—î–º–æ –∑–Ω–∞–π—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∑–∞ telegramChatId:', {
          chatIdString,
          chatId
        });

        user = await User.findOne({
          $or: [
            { telegramChatId: chatIdString },
            { telegramChatId: String(chatId) }
          ]
        })
          .populate('position', 'name')
          .populate('city', 'name');

        if (user) {
          logger.info('–ó–Ω–∞–π–¥–µ–Ω–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∑–∞ telegramChatId, –æ–Ω–æ–≤–ª—é—î–º–æ –¥–∞–Ω—ñ Telegram:', {
            userId: user._id,
            email: user.email,
            oldTelegramId: user.telegramId,
            newTelegramId: userIdString,
            oldTelegramChatId: user.telegramChatId,
            newTelegramChatId: chatIdString
          });

          user.telegramId = userIdString;
          user.telegramChatId = chatIdString;
          if (usernameFromMsg && user.telegramUsername !== usernameFromMsg) {
            user.telegramUsername = usernameFromMsg;
          }
          await user.save();
        }
      }

      // –Ø–∫—â–æ –¥–æ—Å—ñ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ, –ø—Ä–æ–±—É—î–º–æ –∑–Ω–∞–π—Ç–∏ –∑–∞ telegramUsername
      // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –≤ telegramUsername –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è ID —É —Ñ–æ—Ä–º–∞—Ç—ñ @1234567890
      if (!user) {
        logger.info('–ü—Ä–æ–±—É—î–º–æ –∑–Ω–∞–π—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∑–∞ telegramUsername (–º–æ–∂–µ –º—ñ—Å—Ç–∏—Ç–∏ ID):');
        
        // –®—É–∫–∞—î–º–æ –±–µ–∑–ø–æ—Å–µ—Ä–µ–¥–Ω—å–æ –∑–∞ –∑–Ω–∞—á–µ–Ω–Ω—è–º @userIdString
        const idInUsername = `@${userIdString}`;
        user = await User.findOne({
          telegramUsername: idInUsername
        })
          .populate('position', 'name')
          .populate('city', 'name');

        if (user) {
          logger.info('–ó–Ω–∞–π–¥–µ–Ω–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∑–∞ telegramUsername, –¥–µ –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è ID:', {
            userId: user._id,
            email: user.email,
            telegramUsername: user.telegramUsername,
            extractedId: userIdString,
            expectedId: userIdString
          });

          logger.info('–û–Ω–æ–≤–ª—é—î–º–æ –¥–∞–Ω—ñ Telegram –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ (ID –±—É–≤ –≤ telegramUsername):', {
            userId: user._id,
            email: user.email,
            oldTelegramId: user.telegramId,
            newTelegramId: userIdString,
            oldTelegramChatId: user.telegramChatId,
            newTelegramChatId: chatIdString,
            oldTelegramUsername: user.telegramUsername
          });

          user.telegramId = userIdString;
          user.telegramChatId = chatIdString;
          // –û–Ω–æ–≤–ª—é—î–º–æ telegramUsername –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π username, —è–∫—â–æ –≤—ñ–Ω —î
          if (usernameFromMsg && user.telegramUsername !== usernameFromMsg) {
            user.telegramUsername = usernameFromMsg;
          }
          // –Ø–∫—â–æ username –≤—ñ–¥—Å—É—Ç–Ω—ñ–π, –∑–∞–ª–∏—à–∞—î–º–æ ID –≤ telegramUsername (–¥–ª—è —Å—É–º—ñ—Å–Ω–æ—Å—Ç—ñ)
          await user.save();
        }
      }

      // –Ø–∫—â–æ –¥–æ—Å—ñ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ —ñ —î usernameFromMsg, –ø—Ä–æ–±—É—î–º–æ –∑–Ω–∞–π—Ç–∏ –∑–∞ –∑–≤–∏—á–∞–π–Ω–∏–º telegramUsername
      if (!user && usernameFromMsg) {
        logger.info('–ü—Ä–æ–±—É—î–º–æ –∑–Ω–∞–π—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∑–∞ telegramUsername (–∑–≤–∏—á–∞–π–Ω–∏–π –ø–æ—à—É–∫):', {
          usernameFromMsg,
          originalUsername: msg.from.username
        });

        user = await User.findOne({
          telegramUsername: { $regex: new RegExp(`^${usernameFromMsg}$`, 'i') }
        })
          .populate('position', 'name')
          .populate('city', 'name');

        if (user) {
          logger.info('–ó–Ω–∞–π–¥–µ–Ω–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∑–∞ telegramUsername, –æ–Ω–æ–≤–ª—é—î–º–æ –¥–∞–Ω—ñ Telegram:', {
            userId: user._id,
            email: user.email,
            oldTelegramId: user.telegramId,
            newTelegramId: userIdString,
            oldTelegramChatId: user.telegramChatId,
            newTelegramChatId: chatIdString,
            storedTelegramUsername: user.telegramUsername
          });

          user.telegramId = userIdString;
          user.telegramChatId = chatIdString;
          if (user.telegramUsername !== usernameFromMsg) {
            user.telegramUsername = usernameFromMsg;
          }
          await user.save();
        }
      }
      
      // –î—ñ–∞–≥–Ω–æ—Å—Ç–∏—á–Ω–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è
      logger.info('–ü–æ—à—É–∫ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∑–∞ telegramId:', {
        userId,
        userIdString,
        chatId,
        chatIdString,
        usernameFromMsg,
        userFound: !!user,
        userIdType: typeof userId,
        userTelegramId: user?.telegramId,
        userTelegramIdType: typeof user?.telegramId,
        userTelegramChatId: user?.telegramChatId,
        userTelegramChatIdType: typeof user?.telegramChatId,
        isActive: user?.isActive,
        registrationStatus: user?.registrationStatus,
        email: user?.email,
        userId_db: user?._id
      });
      
      if (user) {
        // –û–Ω–æ–≤–ª—é—î–º–æ telegramChatId —è–∫—â–æ –≤—ñ–Ω –≤—ñ–¥—Ä—ñ–∑–Ω—è—î—Ç—å—Å—è –∞–±–æ –≤—ñ–¥—Å—É—Ç–Ω—ñ–π
        if (user.telegramChatId !== chatIdString) {
          logger.info('–û–Ω–æ–≤–ª—é—î–º–æ telegramChatId –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞:', {
            userId: user._id,
            email: user.email,
            oldChatId: user.telegramChatId,
            newChatId: chatIdString
          });
          user.telegramChatId = chatIdString;
          await user.save();
        }
        
        // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –∞–∫—Ç–∏–≤–Ω–∏–π
        if (!user.isActive) {
          await this.sendMessage(chatId, 
            `üö´ *–î–æ—Å—Ç—É–ø –æ–±–º–µ–∂–µ–Ω–æ*\n\n` +
            `–í–∞—à –æ–±–ª—ñ–∫–æ–≤–∏–π –∑–∞–ø–∏—Å –ø–æ–∫–∏ –Ω–µ –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–∏–π.\n\n` +
            `üìû –ó–≤–µ—Ä–Ω—ñ—Ç—å—Å—è –¥–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü—ñ—ó: [@Kultup](https://t.me/Kultup)`,
            { parse_mode: 'Markdown' }
          );
          return;
        }
        
        await this.showUserDashboard(chatId, user);
      } else {
        // –õ–æ–≥—É—î–º–æ, —â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∏–π
        logger.warn('–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –≤ –±–∞–∑—ñ –¥–∞–Ω–∏—Ö:', {
          userId,
          userIdString,
          chatId,
          chatIdString,
          usernameFromMsg,
          searchAttempts: [
            'telegramId as String',
            'telegramId as Number',
            "telegramId with '@' prefix / spaces",
            'telegramChatId as String',
            'telegramChatId as Number',
            'telegramUsername containing ID (@1234567890)',
            'telegramUsername (case-insensitive)',
            'test user auto-update (admin/test.com)'
          ]
        });
        
        // –î–æ–¥–∞—Ç–∫–æ–≤–∞ –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞: –ø–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ —Ç–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –æ–Ω–æ–≤–ª—é—î–º–æ telegramId
        try {
          const testUser = await User.findOne({ email: 'kultup@test.com' });
          if (testUser) {
            logger.info('–ó–Ω–∞–π–¥–µ–Ω–æ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ kultup@test.com:', {
              userId_db: testUser._id,
              telegramId: testUser.telegramId,
              telegramIdType: typeof testUser.telegramId,
              telegramChatId: testUser.telegramChatId,
              telegramChatIdType: typeof testUser.telegramChatId,
              isActive: testUser.isActive,
              role: testUser.role,
              expectedTelegramId: userIdString,
              telegramIdMatch: testUser.telegramId === userIdString,
              usernameFromMsg
            });
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –æ–Ω–æ–≤–ª—é—î–º–æ telegramId –¥–ª—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ/–∞–¥–º—ñ–Ω –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞, —è–∫—â–æ:
            // 1. telegramId –≤—ñ–¥—Å—É—Ç–Ω—ñ–π (null/undefined) –ê–ë–û
            // 2. telegramId –Ω–µ —Å–ø—ñ–≤–ø–∞–¥–∞—î –∑ –ø–æ—Ç–æ—á–Ω–∏–º userId –ê–ë–û
            // 3. –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –º–∞—î —Ä–æ–ª—å admin
            const shouldUpdate = !testUser.telegramId || 
                                 testUser.telegramId !== userIdString || 
                                 testUser.role === 'admin';
            
            if (shouldUpdate && (testUser.role === 'admin' || testUser.email === 'kultup@test.com')) {
              logger.info('–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –æ–Ω–æ–≤–ª—é—î–º–æ telegramId –¥–ª—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ/–∞–¥–º—ñ–Ω –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞:', {
                email: testUser.email,
                role: testUser.role,
                oldTelegramId: testUser.telegramId || '–≤—ñ–¥—Å—É—Ç–Ω—ñ–π',
                newTelegramId: userIdString,
                oldTelegramChatId: testUser.telegramChatId || '–≤—ñ–¥—Å—É—Ç–Ω—ñ–π',
                newTelegramChatId: chatIdString,
                reason: !testUser.telegramId ? 'telegramId –≤—ñ–¥—Å—É—Ç–Ω—ñ–π' : 
                        testUser.telegramId !== userIdString ? 'telegramId –Ω–µ —Å–ø—ñ–≤–ø–∞–¥–∞—î' : 
                        '—Ä–æ–ª—å admin'
              });
              
              testUser.telegramId = userIdString;
              testUser.telegramChatId = chatIdString;
              if (usernameFromMsg) {
                testUser.telegramUsername = usernameFromMsg;
              }
              await testUser.save();
              
              logger.info('‚úÖ –î–∞–Ω—ñ Telegram –æ–Ω–æ–≤–ª–µ–Ω–æ –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞:', {
                email: testUser.email,
                telegramId: testUser.telegramId,
                telegramChatId: testUser.telegramChatId
              });
              
              // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –æ–Ω–æ–≤–ª–µ–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
              user = await User.findById(testUser._id)
                .populate('position', 'name')
                .populate('city', 'name');
            } else {
              logger.info('–ù–µ –æ–Ω–æ–≤–ª—é—î–º–æ telegramId –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞:', {
                email: testUser.email,
                reason: '—É–º–æ–≤–∞ –Ω–µ –≤–∏–∫–æ–Ω–∞–Ω–∞',
                shouldUpdate,
                isAdmin: testUser.role === 'admin',
                isTestEmail: testUser.email === 'kultup@test.com'
              });
            }
          } else {
            logger.warn('–¢–µ—Å—Ç–æ–≤–∏–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á kultup@test.com –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –≤ –±–∞–∑—ñ –¥–∞–Ω–∏—Ö');
          }
        } catch (diagError) {
          logger.error('–ü–æ–º–∏–ª–∫–∞ –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∏:', diagError);
        }
        
        // –Ø–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∑–Ω–∞–π–¥–µ–Ω–æ –ø—ñ—Å–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–≥–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è, –æ–±—Ä–æ–±–ª—è—î–º–æ –π–æ–≥–æ
        if (user) {
          // –û–Ω–æ–≤–ª—é—î–º–æ telegramChatId —è–∫—â–æ –≤—ñ–Ω –≤—ñ–¥—Ä—ñ–∑–Ω—è—î—Ç—å—Å—è –∞–±–æ –≤—ñ–¥—Å—É—Ç–Ω—ñ–π
          if (user.telegramChatId !== chatIdString) {
            logger.info('–û–Ω–æ–≤–ª—é—î–º–æ telegramChatId –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ (–ø—ñ—Å–ª—è auto-update):', {
              userId: user._id,
              email: user.email,
              oldChatId: user.telegramChatId,
              newChatId: chatIdString
            });
            user.telegramChatId = chatIdString;
            await user.save();
          }
          
          // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –∞–∫—Ç–∏–≤–Ω–∏–π
          if (!user.isActive) {
            await this.sendMessage(chatId, 
              `üö´ *–î–æ—Å—Ç—É–ø –æ–±–º–µ–∂–µ–Ω–æ*\n\n` +
              `–í–∞—à –æ–±–ª—ñ–∫–æ–≤–∏–π –∑–∞–ø–∏—Å –ø–æ–∫–∏ –Ω–µ –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–∏–π.\n\n` +
              `üìû –ó–≤–µ—Ä–Ω—ñ—Ç—å—Å—è –¥–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü—ñ—ó: [@Kultup](https://t.me/Kultup)`,
              { parse_mode: 'Markdown' }
            );
            return;
          }
          
          await this.showUserDashboard(chatId, user);
        } else {
          // –Ø–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –≤—Å–µ —â–µ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ, –ø–æ–∫–∞–∑—É—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—é
          await this.sendMessage(chatId, 
            `üö´ *–î–æ—Å—Ç—É–ø –æ–±–º–µ–∂–µ–Ω–æ*\n\n` +
            `üëã –í—ñ—Ç–∞—î–º–æ! –î–ª—è –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –±–æ—Ç–∞ –ø–æ—Ç—Ä—ñ–±–Ω–æ –∑–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è –≤ —Å–∏—Å—Ç–µ–º—ñ.\n\n` +
            `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n` +
            `üìû *–ó–≤–µ—Ä–Ω—ñ—Ç—å—Å—è –¥–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–æ—Å—Ç—É–ø—É:* [@Kultup](https://t.me/Kultup)`,
            {
              parse_mode: 'Markdown',
              reply_markup: {
                inline_keyboard: [
                  [{ text: 'üìù –ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è', callback_data: 'register_user' }],
                  [{ text: 'üìû –ó–≤\'—è–∑–∞—Ç–∏—Å—è –∑ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º', url: 'https://t.me/Kultup' }]
                ]
              }
            }
          );
        }
      }
    } catch (error) {
      logger.error('–ü–æ–º–∏–ª–∫–∞ –æ–±—Ä–æ–±–∫–∏ –∫–æ–º–∞–Ω–¥–∏ /start:', {
        error: error.message,
        stack: error.stack,
        chatId,
        userId,
        usernameFromMsg: msg?.from?.username
      });
      await this.sendMessage(chatId, 
        `‚ùå *–ü–æ–º–∏–ª–∫–∞ —Å–∏—Å—Ç–µ–º–∏*\n\n` +
        `–í–∏–Ω–∏–∫–ª–∞ —Ç–µ—Ö–Ω—ñ—á–Ω–∞ –ø–æ–º–∏–ª–∫–∞. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑ —á–µ—Ä–µ–∑ –∫—ñ–ª—å–∫–∞ —Ö–≤–∏–ª–∏–Ω.`
      );
    }
  }

  async showUserDashboard(chatId, user) {
    const welcomeText = 
      `üéâ *–í—ñ—Ç–∞—î–º–æ –≤ —Å–∏—Å—Ç–µ–º—ñ –ø—ñ–¥—Ç—Ä–∏–º–∫–∏!*\n\n` +
      `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n` +
      `üë§ *–ü—Ä–æ—Ñ—ñ–ª—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞:*\n` +
      `üìß Email: \`${user.email}\`\n` +
      `üíº –ü–æ—Å–∞–¥–∞: *${user.position?.name || '–ù–µ –≤–∫–∞–∑–∞–Ω–æ'}*\n` +
      `üèôÔ∏è –ú—ñ—Å—Ç–æ: *${user.city?.name || '–ù–µ –≤–∫–∞–∑–∞–Ω–æ'}*\n\n` +
      `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n` +
      `üéØ *–û–±–µ—Ä—ñ—Ç—å –¥—ñ—é:*`;

    const keyboard = {
      inline_keyboard: [
        [{ text: 'üìã –ú–æ—ó —Ç—ñ–∫–µ—Ç–∏', callback_data: 'my_tickets' }],
        [{ text: 'üìù –°—Ç–≤–æ—Ä–∏—Ç–∏ —Ç—ñ–∫–µ—Ç', callback_data: 'create_ticket' }],
        [{ text: 'üìÑ –°—Ç–≤–æ—Ä–∏—Ç–∏ –∑ —à–∞–±–ª–æ–Ω—É', callback_data: 'create_from_template' }],
        [{ text: 'üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞', callback_data: 'statistics' }]
      ]
    };

    await this.sendMessage(chatId, welcomeText, { reply_markup: keyboard });
  }

  async handleCallbackQuery(callbackQuery) {
    const chatId = callbackQuery.message.chat.id;
    const messageId = callbackQuery.message.message_id;
    const data = callbackQuery.data;
    const userId = callbackQuery.from.id;

    try {
      logger.info('–û–±—Ä–æ–±–∫–∞ callback query:', { userId, data, chatId, messageId });

      // –°–ø–æ—á–∞—Ç–∫—É –ø–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤–∂–µ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–∏–π
      // –ö–æ–Ω–≤–µ—Ä—Ç—É—î–º–æ userId –≤ —Ä—è–¥–æ–∫ –¥–ª—è –ø–æ—à—É–∫—É
      const user = await User.findOne({ 
        $or: [
          { telegramId: String(userId) },
          { telegramId: userId }
        ]
      })
        .populate('position', 'name')
        .populate('city', 'name');
      
      // –Ø–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤–∂–µ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–∏–π, –Ω–µ –¥–æ–∑–≤–æ–ª—è—î–º–æ –ø–æ–≤—Ç–æ—Ä–Ω—É —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—é
      if (user) {
        // –û–±—Ä–æ–±–∫–∞ callback-–∑–∞–ø–∏—Ç—ñ–≤ –¥–ª—è –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤
        if (data === 'register_user') {
          // –Ø–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤–∂–µ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–∏–π, –ø–æ–∫–∞–∑—É—î–º–æ –≥–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é
          await this.showUserDashboard(chatId, user);
          await this.answerCallbackQuery(callbackQuery.id, '–í–∏ –≤–∂–µ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω—ñ');
        return;
      }

        // –Ø–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–∏–π, –æ–±—Ä–æ–±–ª—è—î–º–æ callback –¥–ª—è –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤
      // –í–∏–¥–∞–ª—è—î–º–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ —ñ–Ω–ª–∞–π–Ω –∫–Ω–æ–ø–∫–∞–º–∏
      try {
        await this.deleteMessage(chatId, messageId);
      } catch (deleteError) {
        logger.warn('–ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–¥–∞–ª–∏—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è:', deleteError.message);
      }

      if (data === 'my_tickets') {
        await this.handleMyTicketsCallback(chatId, user);
      } else if (data === 'create_ticket') {
        await this.handleCreateTicketCallback(chatId, user);
      } else if (data === 'create_from_template') {
        await this.handleCreateFromTemplateCallback(chatId, user);
      } else if (data === 'statistics') {
        await this.handleStatisticsCallback(chatId, user);
      } else if (data === 'back') {
        await this.showUserDashboard(chatId, user);
      } else if (data === 'attach_photo') {
        await this.handleAttachPhotoCallback(chatId, user);
      } else if (data === 'skip_photo') {
        await this.handleSkipPhotoCallback(chatId, user);
      } else if (data === 'add_more_photos') {
        await this.handleAddMorePhotosCallback(chatId, user);
      } else if (data === 'finish_ticket') {
        await this.handleFinishTicketCallback(chatId, user);
      } else if (data.startsWith('category_')) {
        const categoryId = data.replace('category_', '');
        await this.handleDynamicCategoryCallback(chatId, user, categoryId);
      } else if (data === 'priority_low') {
           await this.handlePriorityCallback(chatId, user, 'low');
         } else if (data === 'priority_medium') {
           await this.handlePriorityCallback(chatId, user, 'medium');
         } else if (data === 'priority_high') {
           await this.handlePriorityCallback(chatId, user, 'high');
         } else if (data.startsWith('template_')) {
           const templateId = data.replace('template_', '');
           await this.handleTemplateSelectionCallback(chatId, user, templateId);
        } else if (data === 'create_from_template') {
          await this.handleCreateFromTemplateCallback(chatId, user);
        } else {
          await this.answerCallbackQuery(callbackQuery.id, '–ù–µ–≤—ñ–¥–æ–º–∞ –∫–æ–º–∞–Ω–¥–∞');
        }
        return;
      }

      // –Ø–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –Ω–µ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–∏–π, –æ–±—Ä–æ–±–ª—è—î–º–æ callback-–∏ –¥–ª—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó
      if (data === 'register_user') {
        await this.handleUserRegistrationCallback(chatId, userId);
       await this.answerCallbackQuery(callbackQuery.id);
        return;
      }

      // –û–±—Ä–æ–±–∫–∞ callback-–∑–∞–ø–∏—Ç—ñ–≤ –¥–ª—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó (–≤–∏–±—ñ—Ä –º—ñ—Å—Ç–∞ —Ç–∞ –ø–æ—Å–∞–¥–∏)
      if (data.startsWith('city_') || data.startsWith('position_')) {
        logger.info('–í–∏—è–≤–ª–µ–Ω–æ callback –¥–ª—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó (–º—ñ—Å—Ç–æ/–ø–æ—Å–∞–¥–∞):', { userId, data });
        await this.handleRegistrationCallback(chatId, userId, data);
        await this.answerCallbackQuery(callbackQuery.id);
        return;
      }

      // –Ø–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –Ω–µ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–∏–π —ñ —Ü–µ –Ω–µ callback –¥–ª—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó
      await this.answerCallbackQuery(callbackQuery.id, '–í–∏ –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ñ. –í–∏–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ /start –¥–ª—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó.');
    } catch (error) {
      logger.error('–ü–æ–º–∏–ª–∫–∞ –æ–±—Ä–æ–±–∫–∏ callback query:', error);
      await this.answerCallbackQuery(callbackQuery.id, '–í–∏–Ω–∏–∫–ª–∞ –ø–æ–º–∏–ª–∫–∞');
    }
  }

  async handleMyTicketsCallback(chatId, user) {
    try {
      const tickets = await Ticket.find({ createdBy: user._id })
        .sort({ createdAt: -1 })
        .limit(10);

      if (tickets.length === 0) {
        await this.sendMessage(chatId, 
          `üìã *–ú–æ—ó —Ç—ñ–∫–µ—Ç–∏*\n\n` +
          `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n` +
          `üìÑ –£ –≤–∞—Å –ø–æ–∫–∏ —â–æ –Ω–µ–º–∞—î —Ç—ñ–∫–µ—Ç—ñ–≤\n\n` +
          `üí° –°—Ç–≤–æ—Ä—ñ—Ç—å –Ω–æ–≤–∏–π —Ç—ñ–∫–µ—Ç, —â–æ–± –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–æ–ø–æ–º–æ–≥—É!`, {
          reply_markup: {
            inline_keyboard: [[{ text: 'üîô –ù–∞–∑–∞–¥', callback_data: 'back' }]]
          }
        });
        return;
      }

      let text = 
        `üìã *–í–∞—à—ñ —Ç—ñ–∫–µ—Ç–∏*\n\n` +
        `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
      
      const keyboard = [];

      tickets.forEach((ticket, index) => {
        const status = this.getStatusEmoji(ticket.status);
        text += `${index + 1}. ${status} *${ticket.title}*\n`;
        text += `   üìä –°—Ç–∞—Ç—É—Å: *${this.getStatusText(ticket.status)}*\n`;
        text += `   üìÖ –°—Ç–≤–æ—Ä–µ–Ω–æ: \`${ticket.createdAt.toLocaleDateString('uk-UA')}\`\n\n`;
        
        keyboard.push([{
          text: `üìÑ ${ticket.title.substring(0, 30)}...`,
          callback_data: `view_ticket_${ticket._id}`
        }]);
      });

      text += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`;
      keyboard.push([{ text: 'üîô –ù–∞–∑–∞–¥', callback_data: 'back' }]);

      await this.sendMessage(chatId, text, {
        reply_markup: { inline_keyboard: keyboard }
      });
    } catch (error) {
      logger.error('–ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Ç—ñ–∫–µ—Ç—ñ–≤:', error);
      await this.sendMessage(chatId, 
        `‚ùå *–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç—ñ–∫–µ—Ç—ñ–≤*\n\n` +
        `–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Å–ø–∏—Å–æ–∫ —Ç—ñ–∫–µ—Ç—ñ–≤.\n\n` +
        `üîÑ –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑ –∞–±–æ –∑–≤–µ—Ä–Ω—ñ—Ç—å—Å—è –¥–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞: [@Kultup](https://t.me/Kultup)`,
        { parse_mode: 'Markdown' }
      );
    }
  }

  async handleCreateTicketCallback(chatId, user) {
    const session = {
      step: 'title',
      ticketData: {
        createdBy: user._id,
        photos: []
      }
    };
    
    this.userSessions.set(chatId, session);
    
    await this.sendMessage(chatId, 
      `üìù *–°—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–æ–≤–æ–≥–æ —Ç—ñ–∫–µ—Ç—É*\n\n` +
      `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n` +
      `üìã *–ö—Ä–æ–∫ 1/5:* –í–≤–µ–¥—ñ—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Ç—ñ–∫–µ—Ç—É\n\n` +
      `üí° –û–ø–∏—à—ñ—Ç—å –∫–æ—Ä–æ—Ç–∫–æ —Å—É—Ç—å –ø—Ä–æ–±–ª–µ–º–∏`, {
        reply_markup: {
          inline_keyboard: [[{ text: this.getCancelButtonText(), callback_data: 'cancel_ticket' }]]
        }
      }
    );
  }

  async handleCreateFromTemplateCallback(chatId, user) {
    try {
      // –°—Ç–≤–æ—Ä—é—î–º–æ –∞–±–æ –≤—ñ–¥–Ω–æ–≤–ª—é—î–º–æ —Å–µ—Å—ñ—é –¥–ª—è —à–∞–±–ª–æ–Ω–Ω–æ–≥–æ –ø–æ—Ç–æ–∫—É
      let session = this.userSessions.get(chatId);
      if (!session) {
        session = {
          step: 'template_select',
          ticketData: {
            title: '',
            description: '',
            priority: 'medium',
            categoryId: null,
            photos: []
          },
          isTemplate: true
        };
        this.userSessions.set(chatId, session);
      }

      // –û—Ç—Ä–∏–º—É—î–º–æ —à–∞–±–ª–æ–Ω–∏ –¥–ª—è Telegram
      const templates = await TicketTemplate.find({ isActive: true })
        .populate('category', 'name icon color')
        .sort({ title: 1 })
        .limit(10)
        .lean();

      if (templates.length === 0) {
        await this.sendMessage(chatId, 
          `‚ùå *–ù–µ–º–∞—î –¥–æ—Å—Ç—É–ø–Ω–∏—Ö —à–∞–±–ª–æ–Ω—ñ–≤*\n\n` +
          `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n` +
          `üìã –ù–∞—Ä–∞–∑—ñ –Ω–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–∏—Ö —à–∞–±–ª–æ–Ω—ñ–≤ —Ç—ñ–∫–µ—Ç—ñ–≤\n\n` +
          `üë®‚Äçüíº –ó–≤–µ—Ä–Ω—ñ—Ç—å—Å—è –¥–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —à–∞–±–ª–æ–Ω—ñ–≤: [@Kultup](https://t.me/Kultup)`, {
          parse_mode: 'Markdown',
            reply_markup: {
              inline_keyboard: [[{ text: 'üîô –ù–∞–∑–∞–¥', callback_data: 'back' }]]
            }
          }
        );
        return;
      }

      // –ó–±–∏—Ä–∞—î–º–æ –≤—Å—ñ category IDs –¥–ª—è –æ–¥–Ω–æ–≥–æ –∑–∞–ø–∏—Ç—É (—è–∫—â–æ populate –Ω–µ —Å–ø—Ä–∞—Ü—é–≤–∞–≤)
      const categoryIds = new Set();
      templates.forEach(template => {
        if (template.category && typeof template.category === 'object' && !template.category.name && template.category._id) {
          categoryIds.add(template.category._id.toString());
        } else if (!template.category || (typeof template.category === 'object' && !template.category.name)) {
          // –Ø–∫—â–æ category - —Ü–µ ObjectId —Ä—è–¥–æ–∫
          const catId = typeof template.category === 'string' ? template.category : (template.category?._id?.toString() || null);
          if (catId) {
            categoryIds.add(catId);
          }
        }
      });

      // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó –æ–¥–Ω–∏–º –∑–∞–ø–∏—Ç–æ–º, —è–∫—â–æ —î —Ç–∞–∫—ñ, —â–æ –Ω–µ –ø–æ–ø—É–ª—é—é—Ç—å—Å—è
      const categoriesMap = new Map();
      if (categoryIds.size > 0) {
        const categories = await Category.find({ _id: { $in: Array.from(categoryIds).map(id => new mongoose.Types.ObjectId(id)) } })
          .select('name icon color')
          .lean();
        categories.forEach(cat => {
          categoriesMap.set(cat._id.toString(), cat);
        });
      }

      let text = 
        `üìÑ *–û–±–µ—Ä—ñ—Ç—å —à–∞–±–ª–æ–Ω –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç—ñ–∫–µ—Ç—É*\n\n` +
        `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
      const keyboard = [];

      for (const [index, template] of templates.entries()) {
        text += `${index + 1}. üìã *${template.title}*\n`;
        if (template.description) {
          text += `   üìù ${template.description.substring(0, 50)}...\n`;
        }
        // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —ñ—Å–Ω—É—î –∫–∞—Ç–µ–≥–æ—Ä—ñ—è —Ç–∞ —á–∏ –≤–æ–Ω–∞ –ø–æ–ø—É–ª—é—î—Ç—å—Å—è
        let categoryText = '–ù–µ–≤—ñ–¥–æ–º–∞ –∫–∞—Ç–µ–≥–æ—Ä—ñ—è';
        if (template.category) {
          // –Ø–∫—â–æ –∫–∞—Ç–µ–≥–æ—Ä—ñ—è –≤–∂–µ –ø–æ–ø—É–ª—é—î—Ç—å—Å—è –∑ –ø–æ–ª—è–º–∏ name, icon, color
          if (template.category.name) {
            const icon = template.category.icon && template.category.icon.trim() !== '' ? template.category.icon : '';
            categoryText = icon ? `${icon} ${template.category.name}` : template.category.name;
          } else if (template.category._id) {
            // –Ø–∫—â–æ populate –Ω–µ —Å–ø—Ä–∞—Ü—é–≤–∞–≤, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –º–∞–ø—É –∫–∞—Ç–µ–≥–æ—Ä—ñ–π
            const catId = template.category._id.toString();
            const category = categoriesMap.get(catId);
            if (category) {
              const icon = category.icon && category.icon.trim() !== '' ? category.icon : '';
              categoryText = icon ? `${icon} ${category.name}` : category.name;
            } else {
              // –Ø–∫—â–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –≤ –º–∞–ø—ñ, –ø—Ä–æ–±—É—î–º–æ —á–µ—Ä–µ–∑ getCategoryText
              categoryText = await this.getCategoryText(catId);
            }
          } else if (typeof template.category === 'string') {
            // –Ø–∫—â–æ category –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è —è–∫ —Ä—è–¥–æ–∫ (ObjectId)
            const category = categoriesMap.get(template.category);
            if (category) {
              const icon = category.icon && category.icon.trim() !== '' ? category.icon : '';
              categoryText = icon ? `${icon} ${category.name}` : category.name;
            } else {
              categoryText = await this.getCategoryText(template.category);
            }
          }
        } else {
          logger.warn(`–ö–∞—Ç–µ–≥–æ—Ä—ñ—è –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞ –¥–ª—è —à–∞–±–ª–æ–Ω—É ${template._id}`);
        }
        text += `   üè∑Ô∏è ${categoryText} | ‚ö° *${this.getPriorityText(template.priority)}*\n\n`;
        
        keyboard.push([{
          text: `üìÑ ${template.title}`,
          callback_data: `template_${template._id}`
        }]);
      }

      text += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`;
      keyboard.push([{ text: 'üîô –ù–∞–∑–∞–¥', callback_data: 'back' }]);

      await this.sendMessage(chatId, text, {
        reply_markup: { inline_keyboard: keyboard }
      });
    } catch (error) {
      logger.error('–ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —à–∞–±–ª–æ–Ω—ñ–≤:', error);
      await this.sendMessage(chatId, 
        `‚ùå *–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —à–∞–±–ª–æ–Ω—ñ–≤*\n\n` +
        `–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Å–ø–∏—Å–æ–∫ —à–∞–±–ª–æ–Ω—ñ–≤.\n\n` +
        `üîÑ –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑ –∞–±–æ –∑–≤–µ—Ä–Ω—ñ—Ç—å—Å—è –¥–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞: [@Kultup](https://t.me/Kultup)`,
        { parse_mode: 'Markdown' }
      );
    }
  }

  async handleTemplateSelectionCallback(chatId, user, templateId) {
    try {
      const template = await TicketTemplate.findById(templateId).populate('category', 'name');
      
      if (!template || !template.isActive) {
        await this.sendMessage(chatId, 
          `‚ùå *–®–∞–±–ª–æ–Ω –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π*\n\n` +
          `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n` +
          `üìã –®–∞–±–ª–æ–Ω –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –∞–±–æ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∏–π\n\n` +
          `üîÑ –û–±–µ—Ä—ñ—Ç—å —ñ–Ω—à–∏–π —à–∞–±–ª–æ–Ω –∑—ñ —Å–ø–∏—Å–∫—É`, {
            reply_markup: {
              inline_keyboard: [[{ text: 'üîô –ù–∞–∑–∞–¥ –¥–æ —à–∞–±–ª–æ–Ω—ñ–≤', callback_data: 'create_from_template' }]]
            }
          }
        );
        return;
      }

      let session = this.userSessions.get(chatId);
      if (!session) {
        // –Ø–∫—â–æ —Å–µ—Å—ñ—ó –Ω–µ–º–∞—î (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑–∞–π—à–æ–≤ –Ω–∞–ø—Ä—è–º—É —É —à–∞–±–ª–æ–Ω–∏) ‚Äî —Å—Ç–≤–æ—Ä—é—î–º–æ —ó—ó
        session = {
          step: 'template_select',
          ticketData: {
            title: '',
            description: '',
            priority: 'medium',
            categoryId: null,
            photos: []
          },
          isTemplate: true
        };
        this.userSessions.set(chatId, session);
      }

      if (session) {
        // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ ID —à–∞–±–ª–æ–Ω—É —Ç–∞ –ø–µ—Ä–µ—Ö–æ–¥–∏–º–æ –¥–æ –∫—Ä–æ–∫—É —Ñ–æ—Ç–æ, –ø—Ä–æ–ø—É—Å–∫–∞—é—á–∏ –≤–∏–±—ñ—Ä –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç—É
        session.templateId = template._id;
        session.step = 'photo';

        await this.sendMessage(chatId,
          'üì∑ –•–æ—á–µ—Ç–µ –¥–æ–¥–∞—Ç–∏ —Ñ–æ—Ç–æ –¥–æ —Ç—ñ–∫–µ—Ç—É? (–Ω–µ–æ–±–æ–≤\'—è–∑–∫–æ–≤–æ)', {
            reply_markup: {
              inline_keyboard: [
                [{ text: 'üì∑ –ü—Ä–∏–∫—Ä—ñ–ø–∏—Ç–∏ —Ñ–æ—Ç–æ', callback_data: 'template_add_photo' }],
                [{ text: '‚è≠Ô∏è –ü—Ä–æ–ø—É—Å—Ç–∏—Ç–∏', callback_data: 'template_create_without_photo' }],
                [{ text: this.getCancelButtonText(), callback_data: 'cancel_ticket' }]
              ]
            }
          }
        );
      }
    } catch (error) {
      logger.error('–ü–æ–º–∏–ª–∫–∞ –æ–±—Ä–æ–±–∫–∏ —à–∞–±–ª–æ–Ω—É:', error);
      await this.sendMessage(chatId, '–ü–æ–º–∏–ª–∫–∞ –æ–±—Ä–æ–±–∫–∏ —à–∞–±–ª–æ–Ω—É. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.');
    }
  }
  async handleTextMessage(msg) {
    const chatId = msg.chat.id;
    const text = msg.text;
    const userId = msg.from.id;
    const session = this.userSessions.get(chatId);

    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤–∂–µ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–∏–π
    // –ö–æ–Ω–≤–µ—Ä—Ç—É—î–º–æ userId –≤ —Ä—è–¥–æ–∫, –æ—Å–∫—ñ–ª—å–∫–∏ telegramId –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è —è–∫ String
    const existingUser = await User.findOne({ 
      $or: [
        { telegramId: String(userId) },
        { telegramId: userId }
      ]
    })
      .populate('position', 'name')
      .populate('city', 'name');
    
    // –Ø–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–∏–π, –Ω–µ –ø—Ä–æ–≤–æ–¥–∏–º–æ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—é
    if (existingUser) {
      // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ —î –∞–∫—Ç–∏–≤–Ω–∞ —Å–µ—Å—ñ—è –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç—ñ–∫–µ—Ç—É
      if (session) {
        await this.handleTicketCreationStep(chatId, text, session);
        return;
      }
      
      // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ —Ü–µ –≤—ñ–¥–≥—É–∫
      const user = await User.findOne({ telegramChatId: chatId });
      if (user) {
        const feedbackHandled = await this.handleFeedbackMessage(chatId, text, user);
        if (feedbackHandled) {
          return; // –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –æ–±—Ä–æ–±–ª–µ–Ω–æ —è–∫ –≤—ñ–¥–≥—É–∫
        }
      }
      
      // –Ø–∫—â–æ –Ω–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–æ—ó —Å–µ—Å—ñ—ó, –ø–æ–∫–∞–∑—É—î–º–æ –≥–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é
      await this.showUserDashboard(chatId, existingUser);
      return;
    }

    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤ –ø—Ä–æ—Ü–µ—Å—ñ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó
    // –ö–æ–Ω–≤–µ—Ä—Ç—É—î–º–æ userId –≤ —Ä—è–¥–æ–∫ –¥–ª—è –ø–æ—à—É–∫—É
    const pendingRegistration = await PendingRegistration.findOne({ 
      $or: [
        { telegramId: String(userId) },
        { telegramId: userId }
      ]
    });
    if (pendingRegistration) {
      await this.handleRegistrationTextInput(chatId, userId, text, pendingRegistration);
      return;
    }

    // –°–ø–æ—á–∞—Ç–∫—É –ø–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ —Ü–µ –≤—ñ–¥–≥—É–∫
    const user = await User.findOne({ telegramChatId: chatId });
    if (user) {
      const feedbackHandled = await this.handleFeedbackMessage(chatId, text, user);
      if (feedbackHandled) {
        return; // –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –æ–±—Ä–æ–±–ª–µ–Ω–æ —è–∫ –≤—ñ–¥–≥—É–∫
      }
    }

    if (session) {
      await this.handleTicketCreationStep(chatId, text, session);
    } else {
      await this.sendMessage(chatId, '–Ø –Ω–µ —Ä–æ–∑—É–º—ñ—é. –í–∏–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ –º–µ–Ω—é –¥–ª—è –Ω–∞–≤—ñ–≥–∞—Ü—ñ—ó.');
    }
  }

  // –û–±—Ä–æ–±–Ω–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤–∏—Ö –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –ø—ñ–¥ —á–∞—Å —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó
  async handleRegistrationTextInput(chatId, userId, text, pendingRegistration) {
    try {
      const step = pendingRegistration.step;
      let isValid = true;
      let errorMessage = '';

      switch (step) {
        case 'firstName':
          if (this.validateName(text)) {
            pendingRegistration.data.firstName = text.trim();
            pendingRegistration.step = 'lastName';
          } else {
            isValid = false;
            errorMessage = '‚ùå *–ù–µ–∫–æ—Ä–µ–∫—Ç–Ω–µ —ñ–º\'—è*\n\n–Ü–º\'—è –ø–æ–≤–∏–Ω–Ω–æ –º—ñ—Å—Ç–∏—Ç–∏ —Ç—ñ–ª—å–∫–∏ –ª—ñ—Ç–µ—Ä–∏ —Ç–∞ –±—É—Ç–∏ –¥–æ–≤–∂–∏–Ω–æ—é –≤—ñ–¥ 2 –¥–æ 50 —Å–∏–º–≤–æ–ª—ñ–≤.\n\nüí° –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑:';
          }
          break;

        case 'lastName':
          if (this.validateName(text)) {
            pendingRegistration.data.lastName = text.trim();
            pendingRegistration.step = 'email';
          } else {
            isValid = false;
            errorMessage = '‚ùå *–ù–µ–∫–æ—Ä–µ–∫—Ç–Ω–µ –ø—Ä—ñ–∑–≤–∏—â–µ*\n\n–ü—Ä—ñ–∑–≤–∏—â–µ –ø–æ–≤–∏–Ω–Ω–æ –º—ñ—Å—Ç–∏—Ç–∏ —Ç—ñ–ª—å–∫–∏ –ª—ñ—Ç–µ—Ä–∏ —Ç–∞ –±—É—Ç–∏ –¥–æ–≤–∂–∏–Ω–æ—é –≤—ñ–¥ 2 –¥–æ 50 —Å–∏–º–≤–æ–ª—ñ–≤.\n\nüí° –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑:';
          }
          break;

        case 'email':
          if (this.validateEmail(text)) {
            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ email –≤–∂–µ –Ω–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è
            const existingUser = await User.findOne({ email: text.toLowerCase().trim() });
            if (existingUser) {
              isValid = false;
              errorMessage = '‚ùå *Email –≤–∂–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è*\n\n–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑ —Ç–∞–∫–∏–º email –≤–∂–µ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–∏–π –≤ —Å–∏—Å—Ç–µ–º—ñ.\n\nüí° –í–≤–µ–¥—ñ—Ç—å —ñ–Ω—à–∏–π email:';
            } else {
              pendingRegistration.data.email = text.toLowerCase().trim();
              pendingRegistration.step = 'phone';
            }
          } else {
            isValid = false;
            errorMessage = '‚ùå *–ù–µ–∫–æ—Ä–µ–∫—Ç–Ω–∏–π email*\n\n–í–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω—É –µ–ª–µ–∫—Ç—Ä–æ–Ω–Ω—É –∞–¥—Ä–µ—Å—É.\n\nüí° *–ü—Ä–∏–∫–ª–∞–¥:* user@example.com\n\n–°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑:';
          }
          break;

        case 'phone':
          if (this.validatePhone(text)) {
            pendingRegistration.data.phone = text.trim();
            pendingRegistration.step = 'password';
            // –ü—Ä–∏—Ö–æ–≤—É—î–º–æ –∫–ª–∞–≤—ñ–∞—Ç—É—Ä—É –ø—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ–≥–æ –≤–≤–µ–¥–µ–Ω–Ω—è –Ω–æ–º–µ—Ä–∞
            await this.sendMessage(chatId, 
              `‚úÖ *–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É –ø—Ä–∏–π–Ω—è—Ç–æ!*\n\n` +
              `üì± *–ù–æ–º–µ—Ä:* ${text.trim()}\n\n` +
              `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`,
              {
                reply_markup: {
                  remove_keyboard: true
                }
              }
            );
          } else {
            isValid = false;
            errorMessage = '‚ùå *–ù–µ–∫–æ—Ä–µ–∫—Ç–Ω–∏–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É*\n\n–ù–æ–º–µ—Ä –ø–æ–≤–∏–Ω–µ–Ω –º—ñ—Å—Ç–∏—Ç–∏ –≤—ñ–¥ 10 –¥–æ 15 —Ü–∏—Ñ—Ä —Ç–∞ –º–æ–∂–µ –ø–æ—á–∏–Ω–∞—Ç–∏—Å—è –∑ +.\n\nüí° *–ü—Ä–∏–∫–ª–∞–¥:* +380501234567\n\n–°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑:';
          }
          break;

        case 'password':
          if (this.validatePassword(text)) {
            pendingRegistration.data.password = text; // –í —Ä–µ–∞–ª—å–Ω–æ–º—É –ø—Ä–æ–µ–∫—Ç—ñ –ø–æ—Ç—Ä—ñ–±–Ω–æ —Ö–µ—à—É–≤–∞—Ç–∏
            pendingRegistration.step = 'city';
          } else {
            isValid = false;
            errorMessage = '‚ùå *–°–ª–∞–±–∫–∏–π –ø–∞—Ä–æ–ª—å*\n\n–ü–∞—Ä–æ–ª—å –ø–æ–≤–∏–Ω–µ–Ω –º—ñ—Å—Ç–∏—Ç–∏:\n‚Ä¢ –ú—ñ–Ω—ñ–º—É–º 6 —Å–∏–º–≤–æ–ª—ñ–≤\n‚Ä¢ –ü—Ä–∏–Ω–∞–π–º–Ω—ñ –æ–¥–Ω—É –ª—ñ—Ç–µ—Ä—É\n‚Ä¢ –ü—Ä–∏–Ω–∞–π–º–Ω—ñ –æ–¥–Ω—É —Ü–∏—Ñ—Ä—É\n\nüí° *–ü—Ä–∏–∫–ª–∞–¥:* MyPass123\n\n–°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑:';
          }
          break;

        case 'department':
          if (this.validateDepartment(text)) {
            pendingRegistration.data.department = text.trim();
            pendingRegistration.step = 'completed';
          } else {
            isValid = false;
            errorMessage = '‚ùå *–ù–µ–∫–æ—Ä–µ–∫—Ç–Ω–∞ –Ω–∞–∑–≤–∞ –≤—ñ–¥–¥—ñ–ª—É*\n\n–ù–∞–∑–≤–∞ –≤—ñ–¥–¥—ñ–ª—É –ø–æ–≤–∏–Ω–Ω–∞ –±—É—Ç–∏ –¥–æ–≤–∂–∏–Ω–æ—é –≤—ñ–¥ 2 –¥–æ 100 —Å–∏–º–≤–æ–ª—ñ–≤.\n\nüí° –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑:';
          }
          break;

        default:
          await this.sendMessage(chatId, '‚ùå –ü–æ–º–∏–ª–∫–∞ –≤ –ø—Ä–æ—Ü–µ—Å—ñ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó. –°–ø—Ä–æ–±—É–π—Ç–µ –ø–æ—á–∞—Ç–∏ –∑–∞–Ω–æ–≤–æ.');
          return;
      }

      if (isValid) {
        await pendingRegistration.save();
        await this.processRegistrationStep(chatId, userId, pendingRegistration);
      } else {
        await this.sendMessage(chatId, errorMessage);
      }

    } catch (error) {
      logger.error('–ü–æ–º–∏–ª–∫–∞ –æ–±—Ä–æ–±–∫–∏ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ–π–Ω–æ–≥–æ –≤–≤–µ–¥–µ–Ω–Ω—è:', error);
      await this.sendMessage(chatId, 
        '‚ùå *–ü–æ–º–∏–ª–∫–∞*\n\n–í–∏–Ω–∏–∫–ª–∞ —Ç–µ—Ö–Ω—ñ—á–Ω–∞ –ø–æ–º–∏–ª–∫–∞. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑ –∞–±–æ –∑–≤–µ—Ä–Ω—ñ—Ç—å—Å—è –¥–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞: [@Kultup](https://t.me/Kultup)',
        { parse_mode: 'Markdown' }
      );
    }
  }

  // –ú–µ—Ç–æ–¥–∏ –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó
  validateName(name) {
    if (!name || typeof name !== 'string') return false;
    const trimmed = name.trim();
    return trimmed.length >= 2 && trimmed.length <= 50 && /^[a-zA-Z–∞-—è–ê-–Ø—ñ–Ü—ó–á—î–Ñ''\s-]+$/.test(trimmed);
  }

  validateEmail(email) {
    if (!email || typeof email !== 'string') return false;
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email.trim());
  }

  validatePhone(phone) {
    if (!phone || typeof phone !== 'string') return false;
    const phoneRegex = /^\+?[1-9]\d{9,14}$/;
    return phoneRegex.test(phone.replace(/[\s-()]/g, ''));
  }

  validatePassword(password) {
    if (!password || typeof password !== 'string') return false;
    return password.length >= 6 && /[a-zA-Z–∞-—è–ê-–Ø—ñ–Ü—ó–á—î–Ñ]/.test(password) && /\d/.test(password);
  }

  validateDepartment(department) {
    if (!department || typeof department !== 'string') return false;
    const trimmed = department.trim();
    return trimmed.length >= 2 && trimmed.length <= 100;
  }

  async handleTicketCreationStep(chatId, text, session) {
    try {
      switch (session.step) {
        case 'title':
          session.ticketData.title = text;
          session.step = 'description';
          await this.sendMessage(chatId, 
            '–ö—Ä–æ–∫ 2/5: –í–≤–µ–¥—ñ—Ç—å –æ–ø–∏—Å –ø—Ä–æ–±–ª–µ–º–∏:', {
              reply_markup: {
                inline_keyboard: [[{ text: this.getCancelButtonText(), callback_data: 'cancel_ticket' }]]
              }
            }
          );
          break;

        case 'description':
          session.ticketData.description = text;
          session.step = 'photo';
          await this.sendMessage(chatId, 
            '–ö—Ä–æ–∫ 3/5: –ü—Ä–∏–∫—Ä—ñ–ø—ñ—Ç—å —Ñ–æ—Ç–æ (–Ω–µ–æ–±–æ–≤\'—è–∑–∫–æ–≤–æ)\n\n' +
            '–í–∏ –º–æ–∂–µ—Ç–µ –ø—Ä–∏–∫—Ä—ñ–ø–∏—Ç–∏ —Ñ–æ—Ç–æ –¥–ª—è –∫—Ä–∞—â–æ–≥–æ –æ–ø–∏—Å—É –ø—Ä–æ–±–ª–µ–º–∏.', {
              reply_markup: {
                inline_keyboard: [
                  [{ text: 'üì∑ –ü—Ä–∏–∫—Ä—ñ–ø–∏—Ç–∏ —Ñ–æ—Ç–æ', callback_data: 'attach_photo' }],
                  [{ text: '‚è≠Ô∏è –ü—Ä–æ–ø—É—Å—Ç–∏—Ç–∏', callback_data: 'skip_photo' }],
                  [{ text: this.getCancelButtonText(), callback_data: 'cancel_ticket' }]
                ]
              }
            }
          );
          break;

        case 'category':
           // –õ–æ–≥—ñ–∫–∞ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó - –æ—á—ñ–∫—É—î–º–æ callback
           break;

         case 'priority':
           // –õ–æ–≥—ñ–∫–∞ –¥–ª—è –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç—É - –æ—á—ñ–∫—É—î–º–æ callback
           break;
      }
    } catch (error) {
      logger.error('–ü–æ–º–∏–ª–∫–∞ –æ–±—Ä–æ–±–∫–∏ –∫—Ä–æ–∫—É —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç—ñ–∫–µ—Ç—É:', error);
      await this.sendMessage(chatId, '–í–∏–Ω–∏–∫–ª–∞ –ø–æ–º–∏–ª–∫–∞. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.');
    }
  }

  // –û–±—Ä–æ–±–∫–∞ —Ñ–æ—Ç–æ
  async handlePhoto(msg) {
    const chatId = msg.chat.id;
    const session = this.userSessions.get(chatId);

    if (session && session.step === 'photo') {
      await this.handleTicketPhoto(chatId, msg.photo, msg.caption);
    } else {
      await this.sendMessage(chatId, '–§–æ—Ç–æ –º–æ–∂–Ω–∞ –ø—Ä–∏–∫—Ä—ñ–ø–ª—è—Ç–∏ —Ç—ñ–ª—å–∫–∏ –ø—ñ–¥ —á–∞—Å —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç—ñ–∫–µ—Ç—É.');
    }
  }

  async handleTicketPhoto(chatId, photos, caption) {
     try {
       const session = this.userSessions.get(chatId);
       if (!session) return;

       // –ë–µ—Ä–µ–º–æ –Ω–∞–π–±—ñ–ª—å—à–µ —Ñ–æ—Ç–æ
       const photo = photos[photos.length - 1];
       const fileId = photo.file_id;

       // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —Ä–æ–∑–º—ñ—Ä —Ñ–æ—Ç–æ
       const file = await this.bot.getFile(fileId);
       const fileSizeBytes = file.file_size;
       const maxSizeBytes = 20 * 1024 * 1024; // 20MB

       if (fileSizeBytes > maxSizeBytes) {
         await this.sendMessage(chatId, 
           `‚ùå –§–æ—Ç–æ –∑–∞–Ω–∞–¥—Ç–æ –≤–µ–ª–∏–∫–µ!\n\n` +
           `–†–æ–∑–º—ñ—Ä: ${formatFileSize(fileSizeBytes)}\n` +
      `–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∏–π —Ä–æ–∑–º—ñ—Ä: ${formatFileSize(maxSizeBytes)}\n\n` +
           `–ë—É–¥—å –ª–∞—Å–∫–∞, –Ω–∞–¥—ñ—à–ª—ñ—Ç—å —Ñ–æ—Ç–æ –º–µ–Ω—à–æ–≥–æ —Ä–æ–∑–º—ñ—Ä—É.`
         );
         return;
       }

       // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —Ç–∏–ø —Ñ–∞–π–ª—É
       const filePath = file.file_path;
       const fileExtension = path.extname(filePath).toLowerCase();
       const allowedExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.webp'];

       if (!allowedExtensions.includes(fileExtension)) {
         await this.sendMessage(chatId, 
           `‚ùå –ù–µ–ø—ñ–¥—Ç—Ä–∏–º—É–≤–∞–Ω–∏–π —Ç–∏–ø —Ñ–∞–π–ª—É!\n\n` +
           `–ü—ñ–¥—Ç—Ä–∏–º—É–≤–∞–Ω—ñ —Ñ–æ—Ä–º–∞—Ç–∏: JPG, JPEG, PNG, GIF, WebP\n` +
           `–í–∞—à —Ñ–∞–π–ª: ${fileExtension || '–Ω–µ–≤—ñ–¥–æ–º–∏–π'}\n\n` +
           `–ë—É–¥—å –ª–∞—Å–∫–∞, –Ω–∞–¥—ñ—à–ª—ñ—Ç—å —Ñ–æ—Ç–æ —É –ø—ñ–¥—Ç—Ä–∏–º—É–≤–∞–Ω–æ–º—É —Ñ–æ—Ä–º–∞—Ç—ñ.`
         );
         return;
       }

       // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Ñ–æ—Ç–æ
       if (session.ticketData.photos.length >= 5) {
         await this.sendMessage(chatId, 
           `‚ùå –î–æ—Å—è–≥–Ω—É—Ç–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Ñ–æ—Ç–æ!\n\n` +
           `–ú–∞–∫—Å–∏–º—É–º: 5 —Ñ–æ—Ç–æ –Ω–∞ —Ç—ñ–∫–µ—Ç\n` +
           `–ü–æ—Ç–æ—á–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å: ${session.ticketData.photos.length}\n\n` +
           `–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å "–ó–∞–≤–µ—Ä—à–∏—Ç–∏" –¥–ª—è –ø—Ä–æ–¥–æ–≤–∂–µ–Ω–Ω—è.`
         );
         return;
       }
       
       // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —Ç–∞ –∑–±–µ—Ä—ñ–≥–∞—î–º–æ —Ñ–æ—Ç–æ
       const savedPath = await this.downloadTelegramFile(filePath);
       
       // –î–æ–¥–∞—î–º–æ —Ñ–æ—Ç–æ –¥–æ —Å–µ—Å—ñ—ó
       session.ticketData.photos.push({
         fileId: fileId,
         path: savedPath,
         caption: caption || '',
         size: fileSizeBytes,
         extension: fileExtension
       });

       await this.sendMessage(chatId, 
         `‚úÖ –§–æ—Ç–æ –¥–æ–¥–∞–Ω–æ! (${session.ticketData.photos.length}/5)\n\n` +
         `üìè –†–æ–∑–º—ñ—Ä: ${formatFileSize(fileSizeBytes)}\n` +
         `üìÑ –§–æ—Ä–º–∞—Ç: ${fileExtension.toUpperCase()}\n\n` +
         '–•–æ—á–µ—Ç–µ –¥–æ–¥–∞—Ç–∏ —â–µ —Ñ–æ—Ç–æ?', {
           reply_markup: {
               inline_keyboard: [
                 [{ text: 'üì∑ –î–æ–¥–∞—Ç–∏ —â–µ —Ñ–æ—Ç–æ', callback_data: 'add_more_photos' }],
                 [{ text: '‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç–∏', callback_data: 'finish_ticket' }],
                 [{ text: this.getCancelButtonText(), callback_data: 'cancel_ticket' }]
               ]
             }
           }
         );
     } catch (error) {
       logger.error('–ü–æ–º–∏–ª–∫–∞ –æ–±—Ä–æ–±–∫–∏ —Ñ–æ—Ç–æ:', error);
       await this.sendMessage(chatId, '–ü–æ–º–∏–ª–∫–∞ –æ–±—Ä–æ–±–∫–∏ —Ñ–æ—Ç–æ. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.');
     }
   }

  async handleContact(msg) {
    const chatId = msg.chat.id;
    const userId = msg.from.id;

    try {
      // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤–∂–µ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–∏–π
      // –ö–æ–Ω–≤–µ—Ä—Ç—É—î–º–æ userId –≤ —Ä—è–¥–æ–∫, –æ—Å–∫—ñ–ª—å–∫–∏ telegramId –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è —è–∫ String
      const existingUser = await User.findOne({ 
        $or: [
          { telegramId: String(userId) },
          { telegramId: userId }
        ]
      })
        .populate('position', 'name')
        .populate('city', 'name');
      
      // –Ø–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤–∂–µ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–∏–π, –ø–æ–∫–∞–∑—É—î–º–æ –≥–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é
      if (existingUser) {
        await this.showUserDashboard(chatId, existingUser);
        return;
      }

      // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤ –ø—Ä–æ—Ü–µ—Å—ñ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó –Ω–∞ –µ—Ç–∞–ø—ñ phone
      // –ö–æ–Ω–≤–µ—Ä—Ç—É—î–º–æ userId –≤ —Ä—è–¥–æ–∫ –¥–ª—è –ø–æ—à—É–∫—É
      const pendingRegistration = await PendingRegistration.findOne({ 
        $or: [
          { telegramId: String(userId) },
          { telegramId: userId }
        ]
      });
      
      if (!pendingRegistration) {
        await this.sendMessage(chatId, '–í–∏ –Ω–µ –≤ –ø—Ä–æ—Ü–µ—Å—ñ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó. –í–∏–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ /start –¥–ª—è –ø–æ—á–∞—Ç–∫—É.');
        return;
      }

      if (pendingRegistration.step !== 'phone') {
        await this.sendMessage(chatId, '–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É –º–æ–∂–Ω–∞ –ø–æ–¥—ñ–ª–∏—Ç–∏—Å—è —Ç—ñ–ª—å–∫–∏ –Ω–∞ –µ—Ç–∞–ø—ñ –≤–≤–µ–¥–µ–Ω–Ω—è –Ω–æ–º–µ—Ä–∞.');
        return;
      }

      // –û—Ç—Ä–∏–º—É—î–º–æ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É –∑ –∫–æ–Ω—Ç–∞–∫—Ç—É
      const contact = msg.contact;
      if (!contact || !contact.phone_number) {
        await this.sendMessage(chatId, '‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É. –°–ø—Ä–æ–±—É–π—Ç–µ –≤–≤–µ—Å—Ç–∏ –Ω–æ–º–µ—Ä –≤—Ä—É—á–Ω—É.');
        return;
      }

      let phoneNumber = contact.phone_number;

      // –Ø–∫—â–æ –Ω–æ–º–µ—Ä –Ω–µ –ø–æ—á–∏–Ω–∞—î—Ç—å—Å—è –∑ +, –¥–æ–¥–∞—î–º–æ +
      if (!phoneNumber.startsWith('+')) {
        phoneNumber = '+' + phoneNumber;
      }

      // –í–∞–ª—ñ–¥—É—î–º–æ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É
      if (!this.validatePhone(phoneNumber)) {
        await this.sendMessage(chatId, 
          `‚ùå *–ù–µ–∫–æ—Ä–µ–∫—Ç–Ω–∏–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É*\n\n` +
          `–û—Ç—Ä–∏–º–∞–Ω–∏–π –Ω–æ–º–µ—Ä: ${phoneNumber}\n\n` +
          `–ù–æ–º–µ—Ä –ø–æ–≤–∏–Ω–µ–Ω –º—ñ—Å—Ç–∏—Ç–∏ –≤—ñ–¥ 10 –¥–æ 15 —Ü–∏—Ñ—Ä —Ç–∞ –ø–æ—á–∏–Ω–∞—Ç–∏—Å—è –∑ +.\n\n` +
          `üí° –°–ø—Ä–æ–±—É–π—Ç–µ –≤–≤–µ—Å—Ç–∏ –Ω–æ–º–µ—Ä –≤—Ä—É—á–Ω—É:`,
          {
            reply_markup: {
              keyboard: [
                [{
                  text: 'üì± –ü–æ–¥—ñ–ª–∏—Ç–∏—Å—è –Ω–æ–º–µ—Ä–æ–º',
                  request_contact: true
                }]
              ],
              resize_keyboard: true,
              one_time_keyboard: true
            }
          }
        );
        return;
      }

      // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É
      pendingRegistration.data.phone = phoneNumber;
      pendingRegistration.step = 'password';
      await pendingRegistration.save();

      // –ü—Ä–∏—Ö–æ–≤—É—î–º–æ –∫–ª–∞–≤—ñ–∞—Ç—É—Ä—É —ñ –ø–µ—Ä–µ—Ö–æ–¥–∏–º–æ –¥–æ –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ –∫—Ä–æ–∫—É
      await this.sendMessage(chatId, 
        `‚úÖ *–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É –æ—Ç—Ä–∏–º–∞–Ω–æ!*\n\n` +
        `üì± *–ù–æ–º–µ—Ä:* ${phoneNumber}\n\n` +
        `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`,
        {
          reply_markup: {
            remove_keyboard: true
          }
        }
      );

      // –ü–µ—Ä–µ—Ö–æ–¥–∏–º–æ –¥–æ –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ –∫—Ä–æ–∫—É (–ø–∞—Ä–æ–ª—å)
      await this.askForPassword(chatId);

    } catch (error) {
      logger.error('–ü–æ–º–∏–ª–∫–∞ –æ–±—Ä–æ–±–∫–∏ –∫–æ–Ω—Ç–∞–∫—Ç—É:', error);
      await this.sendMessage(chatId, '‚ùå –ü–æ–º–∏–ª–∫–∞ –æ–±—Ä–æ–±–∫–∏ –Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω—É. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.');
    }
  }

  async downloadTelegramFile(filePath) {
    return new Promise((resolve, reject) => {
      const token = process.env.TELEGRAM_BOT_TOKEN;
      const url = `https://api.telegram.org/file/bot${token}/${filePath}`;
      
      // –°—Ç–≤–æ—Ä—é—î–º–æ –ø–∞–ø–∫—É –¥–ª—è —Ñ–æ—Ç–æ —è–∫—â–æ –Ω–µ —ñ—Å–Ω—É—î
      const uploadsDir = path.join(__dirname, '../uploads/telegram-photos');
      if (!fs.existsSync(uploadsDir)) {
        fs.mkdirSync(uploadsDir, { recursive: true });
      }

      const fileName = `${Date.now()}_${path.basename(filePath)}`;
      const localPath = path.join(uploadsDir, fileName);
      const file = fs.createWriteStream(localPath);

      https.get(url, (response) => {
        response.pipe(file);
        file.on('finish', () => {
          file.close();
          resolve(localPath);
        });
      }).on('error', (error) => {
        fs.unlink(localPath, () => {}); // –í–∏–¥–∞–ª—è—î–º–æ —Ñ–∞–π–ª –ø—Ä–∏ –ø–æ–º–∏–ª—Ü—ñ
        reject(error);
      });
    });
   }

   // Callback –æ–±—Ä–æ–±–Ω–∏–∫–∏ –¥–ª—è —Ñ–æ—Ç–æ
  async handleAttachPhotoCallback(chatId, user) {
    await this.sendMessage(chatId, 
      'üì∑ –ù–∞–¥—ñ—à–ª—ñ—Ç—å —Ñ–æ—Ç–æ –¥–ª—è –ø—Ä–∏–∫—Ä—ñ–ø–ª–µ–Ω–Ω—è –¥–æ —Ç—ñ–∫–µ—Ç—É.\n\n' +
      '–í–∏ –º–æ–∂–µ—Ç–µ –¥–æ–¥–∞—Ç–∏ –ø—ñ–¥–ø–∏—Å –¥–æ —Ñ–æ—Ç–æ –¥–ª—è –¥–æ–¥–∞—Ç–∫–æ–≤–æ—ó —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó.'
    );
  }

  async handleSkipPhotoCallback(chatId, user) {
    const session = this.userSessions.get(chatId);
    if (session) {
      session.step = 'category';
      const categoryButtons = await this.generateCategoryButtons();
      const categoriesCount = this.getAllCategories().length;
      const promptText = categoriesCount > 0 ? this.getCategoryPromptText() : '–ù–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–∏—Ö –∫–∞—Ç–µ–≥–æ—Ä—ñ–π. –ó–≤–µ—Ä–Ω—ñ—Ç—å—Å—è –¥–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞: [@Kultup](https://t.me/Kultup)';
      await this.sendMessage(chatId, promptText, {
        parse_mode: 'Markdown',
        reply_markup: {
          inline_keyboard: categoryButtons
        }
      });
    }
  }

  async handleAddMorePhotosCallback(chatId, user) {
    await this.sendMessage(chatId, 
      'üì∑ –ù–∞–¥—ñ—à–ª—ñ—Ç—å —â–µ –æ–¥–Ω–µ —Ñ–æ—Ç–æ –∞–±–æ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å "–ó–∞–≤–µ—Ä—à–∏—Ç–∏" –¥–ª—è –ø—Ä–æ–¥–æ–≤–∂–µ–Ω–Ω—è.'
    );
  }

  async handleFinishTicketCallback(chatId, user) {
    const session = this.userSessions.get(chatId);
    if (session) {
      session.step = 'category';
      const categoryButtons = await this.generateCategoryButtons();
      const categoriesCount = this.getAllCategories().length;
      const promptText = categoriesCount > 0 ? this.getCategoryPromptText() : '–ù–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–∏—Ö –∫–∞—Ç–µ–≥–æ—Ä—ñ–π. –ó–≤–µ—Ä–Ω—ñ—Ç—å—Å—è –¥–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞: [@Kultup](https://t.me/Kultup)';
      await this.sendMessage(chatId, promptText, {
        parse_mode: 'Markdown',
        reply_markup: {
          inline_keyboard: categoryButtons
        }
      });
    }
  }

  async handleCancelTicketCallback(chatId, user) {
    this.userSessions.delete(chatId);
    await this.sendMessage(chatId, 
      `‚ùå *–°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç—ñ–∫–µ—Ç—É —Å–∫–∞—Å–æ–≤–∞–Ω–æ*\n\n` +
      `üîÑ –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ—Å—è –¥–æ –≥–æ–ª–æ–≤–Ω–æ–≥–æ –º–µ–Ω—é`
    );
    await this.showUserDashboard(chatId, user);
  }



  async handleStatisticsCallback(chatId, user) {
    try {
      const totalTickets = await Ticket.countDocuments({ createdBy: user._id });
      const openTickets = await Ticket.countDocuments({ 
        createdBy: user._id, 
        status: { $in: ['open', 'in_progress'] } 
      });
      const closedTickets = await Ticket.countDocuments({ 
        createdBy: user._id, 
        status: 'closed' 
      });

      const text = 
        `üìä *–í–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞*\n\n` +
        `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n` +
        `üìã *–í—Å—å–æ–≥–æ —Ç—ñ–∫–µ—Ç—ñ–≤:* \`${totalTickets}\`\n` +
        `üîì *–í—ñ–¥–∫—Ä–∏—Ç–∏—Ö:* \`${openTickets}\`\n` +
        `‚úÖ *–ó–∞–∫—Ä–∏—Ç–∏—Ö:* \`${closedTickets}\`\n\n` +
        `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`;

      await this.sendMessage(chatId, text, {
        reply_markup: {
          inline_keyboard: [[{ text: 'üîô –ù–∞–∑–∞–¥', callback_data: 'back' }]]
        }
      });
    } catch (error) {
      logger.error('–ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
      await this.sendMessage(chatId, 
        `‚ùå *–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏*\n\n` +
        `–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –¥–∞–Ω—ñ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.\n\n` +
        `üîÑ –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑ –∞–±–æ –∑–≤–µ—Ä–Ω—ñ—Ç—å—Å—è –¥–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞: [@Kultup](https://t.me/Kultup)`,
        { parse_mode: 'Markdown' }
      );
    }
  }

  async answerCallbackQuery(callbackQueryId, text = '') {
    try {
      await this.bot.answerCallbackQuery(callbackQueryId, { text });
    } catch (error) {
      logger.error('–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –Ω–∞ callback query:', error);
    }
  }


  // –û–±—Ä–æ–±–Ω–∏–∫–∏ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä—ñ–π —Ç–∞ –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç—ñ–≤
   async handleCategoryCallback(chatId, user, categoryId) {
     const session = this.userSessions.get(chatId);
     if (session) {
       session.ticketData.categoryId = categoryId;
       session.step = 'priority';
       
       await this.sendMessage(chatId, 
         this.getPriorityPromptText(), {
           reply_markup: {
             inline_keyboard: [
               [{ text: this.getPriorityText('high'), callback_data: 'priority_high' }],
               [{ text: this.getPriorityText('medium'), callback_data: 'priority_medium' }],
               [{ text: this.getPriorityText('low'), callback_data: 'priority_low' }],
               [{ text: this.getCancelButtonText(), callback_data: 'cancel_ticket' }]
             ]
           }
         }
       );
     }
   }

   async handlePriorityCallback(chatId, user, priority) {
     const session = this.userSessions.get(chatId);
     if (session) {
       session.ticketData.priority = priority;
       await this.completeTicketCreation(chatId, user, session);
     }
   }

   async completeTicketCreation(chatId, user, session) {
     try {
       const ticketData = {
         title: session.ticketData.title,
         description: session.ticketData.description,
         category: session.ticketData.categoryId,
         priority: session.ticketData.priority,
         createdBy: user._id,
         city: user.city,
         status: 'open',
         metadata: {
           source: 'telegram'
         },
         attachments: session.ticketData.photos.map(photo => {
           let fileSize = 0;
           try {
             const stats = fs.statSync(photo.path);
             fileSize = stats.size;
           } catch (error) {
             logger.error(`–ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Ä–æ–∑–º—ñ—Ä—É —Ñ–∞–π–ª—É ${photo.path}:`, error);
           }
           
           return {
             filename: path.basename(photo.path),
             originalName: photo.caption || path.basename(photo.path),
             mimetype: 'image/jpeg', // –ú–æ–∂–Ω–∞ –≤–∏–∑–Ω–∞—á–∏—Ç–∏ —Ç–∏–ø —Ñ–∞–π–ª—É –ø—ñ–∑–Ω—ñ—à–µ
             size: fileSize,
             path: photo.path,
             uploadedBy: user._id,
             caption: photo.caption
           };
         })
       };

       const ticket = new Ticket(ticketData);
       await ticket.save();

       // –ó–∞–ø–æ–≤–Ω—é—î–º–æ –¥–∞–Ω—ñ –¥–ª—è WebSocket —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è
       await ticket.populate([
         { path: 'createdBy', select: 'firstName lastName email' },
         { path: 'city', select: 'name region' }
       ]);

       // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ WebSocket —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è –ø—Ä–æ –Ω–æ–≤–∏–π —Ç—ñ–∫–µ—Ç
       try {
         ticketWebSocketService.notifyNewTicket(ticket);
         logger.info('‚úÖ WebSocket —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è –ø—Ä–æ –Ω–æ–≤–∏–π —Ç—ñ–∫–µ—Ç –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ (Telegram)');
       } catch (wsError) {
         logger.error('‚ùå –ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ WebSocket —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è –ø—Ä–æ –Ω–æ–≤–∏–π —Ç—ñ–∫–µ—Ç (Telegram):', wsError);
       }

       // –û—á–∏—â—É—î–º–æ —Å–µ—Å—ñ—é
       this.userSessions.delete(chatId);

      let confirmText = 
        `üéâ *–¢—ñ–∫–µ—Ç —É—Å–ø—ñ—à–Ω–æ —Å—Ç–≤–æ—Ä–µ–Ω–æ!*\n\n` +
        `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n` +
        `üÜî *ID —Ç—ñ–∫–µ—Ç—É:* \`${ticket._id}\`\n\n` +
        `‚è≥ *–û—á—ñ–∫—É–π—Ç–µ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞*\n\n` +
        `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`;

       await this.sendMessage(chatId, confirmText, {
         reply_markup: {
           inline_keyboard: [[{ text: 'üè† –ì–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é', callback_data: 'back' }]]
         }
       });

       logger.info(`–¢—ñ–∫–µ—Ç —Å—Ç–≤–æ—Ä–µ–Ω–æ —á–µ—Ä–µ–∑ Telegram: ${ticket._id} –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–µ–º ${user.email}`);
     } catch (error) {
       logger.error('–ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç—ñ–∫–µ—Ç—É:', error);
       await this.sendMessage(chatId, 
         `‚ùå *–ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç—ñ–∫–µ—Ç—É*\n\n` +
         `–í–∏–Ω–∏–∫–ª–∞ —Ç–µ—Ö–Ω—ñ—á–Ω–∞ –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—ñ —Ç—ñ–∫–µ—Ç—É.\n\n` +
         `üîÑ –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑ –∞–±–æ –∑–≤–µ—Ä–Ω—ñ—Ç—å—Å—è –¥–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞: [@Kultup](https://t.me/Kultup)`,
         { parse_mode: 'Markdown' }
       );
     }
   }

  async getCategoryText(categoryId) {
    try {
      if (typeof categoryId === 'string' && categoryId.length === 24) {
        // ObjectId ‚Äì —à—É–∫–∞—î–º–æ –≤ –ë–î —Ç–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ icon, —è–∫—â–æ –∑–∞–¥–∞–Ω–æ
        const category = await Category.findById(categoryId);
        if (!category) return '–ù–µ–≤—ñ–¥–æ–º–∞ –∫–∞—Ç–µ–≥–æ—Ä—ñ—è';
        const icon = category.icon && category.icon.trim() !== '' ? category.icon : '';
        return icon ? `${icon} ${category.name}` : category.name;
      }

      // –ü—ñ–¥—Ç—Ä–∏–º–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç—É: —à—É–∫–∞—î–º–æ –∫–∞—Ç–µ–≥–æ—Ä—ñ—é –∑–∞ –Ω–∞–∑–≤–æ—é
      const byName = await Category.findByName(categoryId);
      if (byName) {
        const icon = byName.icon && byName.icon.trim() !== '' ? byName.icon : '';
        return icon ? `${icon} ${byName.name}` : byName.name;
      }

      return '–ù–µ–≤—ñ–¥–æ–º–∞ –∫–∞—Ç–µ–≥–æ—Ä—ñ—è';
    } catch (error) {
      logger.error('–ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Ç–µ–∫—Å—Ç—É –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó:', error);
      return '–ù–µ–≤—ñ–¥–æ–º–∞ –∫–∞—Ç–µ–≥–æ—Ä—ñ—è';
    }
  }

  

   // –û–±—Ä–æ–±–Ω–∏–∫–∏ –¥–ª—è —à–∞–±–ª–æ–Ω—ñ–≤
   async handleTemplateAddPhotoCallback(chatId, user) {
     const session = this.userSessions.get(chatId);
     if (session && session.isTemplate) {
       session.step = 'photo';
       await this.sendMessage(chatId, 
         'üì∑ –ù–∞–¥—ñ—à–ª—ñ—Ç—å —Ñ–æ—Ç–æ –¥–ª—è –ø—Ä–∏–∫—Ä—ñ–ø–ª–µ–Ω–Ω—è –¥–æ —Ç—ñ–∫–µ—Ç—É –∑ —à–∞–±–ª–æ–Ω—É.\n\n' +
         '–í–∏ –º–æ–∂–µ—Ç–µ –¥–æ–¥–∞—Ç–∏ –ø—ñ–¥–ø–∏—Å –¥–æ —Ñ–æ—Ç–æ –¥–ª—è –¥–æ–¥–∞—Ç–∫–æ–≤–æ—ó —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó.'
       );
     }
   }

   async handleTemplateCreateWithoutPhotoCallback(chatId, user) {
     const session = this.userSessions.get(chatId);
     if (session && session.isTemplate) {
       await this.completeTemplateTicketCreation(chatId, user, session);
     }
   }

   async completeTemplateTicketCreation(chatId, user, session) {
     try {
       const ticketData = {
         title: session.ticketData.title,
         description: session.ticketData.description,
         category: session.ticketData.categoryId,
         priority: session.ticketData.priority,
         createdBy: user._id,
         city: user.city,
         status: 'open',
         metadata: {
           source: 'telegram',
           templateId: session.templateId
         },
         attachments: session.ticketData.photos.map(photo => {
           let fileSize = 0;
           try {
             const stats = fs.statSync(photo.path);
             fileSize = stats.size;
           } catch (error) {
             logger.error(`–ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Ä–æ–∑–º—ñ—Ä—É —Ñ–∞–π–ª—É ${photo.path}:`, error);
           }
           
           return {
             filename: path.basename(photo.path),
             originalName: photo.caption || path.basename(photo.path),
             mimetype: 'image/jpeg',
             size: fileSize,
             path: photo.path,
             uploadedBy: user._id,
             caption: photo.caption
           };
         })
       };

       // –î–æ–¥–∞—î–º–æ –∫–∞—Å—Ç–æ–º–Ω—ñ –ø–æ–ª—è –∑ —à–∞–±–ª–æ–Ω—É
       if (session.ticketData.customFields && session.ticketData.customFields.length > 0) {
         ticketData.customFields = session.ticketData.customFields;
       }

       // Debug logging
       logger.info('Ticket data before creation:', JSON.stringify(ticketData, null, 2));
       logger.info('Session data:', JSON.stringify(session, null, 2));

       const ticket = new Ticket(ticketData);
       await ticket.save();

       // –û—á–∏—â—É—î–º–æ —Å–µ—Å—ñ—é
       this.userSessions.delete(chatId);

       let confirmText = `‚úÖ –¢—ñ–∫–µ—Ç –∑ —à–∞–±–ª–æ–Ω—É —É—Å–ø—ñ—à–Ω–æ —Å—Ç–≤–æ—Ä–µ–Ω–æ!\n\n` +
         `üìã –ó–∞–≥–æ–ª–æ–≤–æ–∫: ${ticket.title}\n` +
         `üìù –û–ø–∏—Å: ${ticket.description}\n` +
         `üè∑Ô∏è –ö–∞—Ç–µ–≥–æ—Ä—ñ—è: ${await this.getCategoryText(ticket.category)}\n` +
         `‚ö° –ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç: ${this.getPriorityText(ticket.priority)}\n` +
         `üÜî ID —Ç—ñ–∫–µ—Ç—É: ${ticket._id}`;

       if (session.ticketData.photos.length > 0) {
         confirmText += `\nüì∑ –ü—Ä–∏–∫—Ä—ñ–ø–ª–µ–Ω–æ —Ñ–æ—Ç–æ: ${session.ticketData.photos.length}`;
       }

       await this.sendMessage(chatId, confirmText, {
         reply_markup: {
           inline_keyboard: [[{ text: 'üè† –ì–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é', callback_data: 'back' }]]
         }
       });

       logger.info(`–¢—ñ–∫–µ—Ç –∑ —à–∞–±–ª–æ–Ω—É —Å—Ç–≤–æ—Ä–µ–Ω–æ —á–µ—Ä–µ–∑ Telegram: ${ticket._id} –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–µ–º ${user.email}, —à–∞–±–ª–æ–Ω: ${session.templateId}`);
     } catch (error) {
       logger.error('–ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç—ñ–∫–µ—Ç—É –∑ —à–∞–±–ª–æ–Ω—É:', error);
       await this.sendMessage(chatId, '–ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç—ñ–∫–µ—Ç—É –∑ —à–∞–±–ª–æ–Ω—É. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.');
     }
   }


  /**
   * –í—ñ–¥–ø—Ä–∞–≤–∫–∞ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è –ø—Ä–æ –Ω–æ–≤–∏–π —Ç—ñ–∫–µ—Ç –≤ –≥—Ä—É–ø—É
   */
  async sendNewTicketNotificationToGroup(ticket, user) {
    try {
      if (!this.bot) {
        logger.warn('Telegram –±–æ—Ç –Ω–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–∏–π –¥–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è –ø—Ä–æ –Ω–æ–≤–∏–π —Ç—ñ–∫–µ—Ç');
        return;
      }

      const groupChatId = process.env.TELEGRAM_GROUP_CHAT_ID;
      if (!groupChatId) {
        logger.warn('TELEGRAM_GROUP_CHAT_ID –Ω–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
        return;
      }

      await ticket.populate([
        { path: 'createdBy', select: 'firstName lastName email' },
        { path: 'city', select: 'name region' },
        { path: 'category', select: 'name' }
      ]);

      const categoryText = await this.getCategoryText(ticket.category._id);
      const priorityText = this.getPriorityText(ticket.priority);
      const statusText = this.getStatusText(ticket.status);
      
      const message = 
        `üé´ *–ù–æ–≤–∏–π —Ç—ñ–∫–µ—Ç —Å—Ç–≤–æ—Ä–µ–Ω–æ*\n\n` +
        `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n` +
        `üìã *–ó–∞–≥–æ–ª–æ–≤–æ–∫:* ${ticket.title}\n` +
        `üìù *–û–ø–∏—Å:* ${ticket.description || '–ë–µ–∑ –æ–ø–∏—Å—É'}\n\n` +
        `üë§ *–ê–≤—Ç–æ—Ä:* ${ticket.createdBy?.firstName || ''} ${ticket.createdBy?.lastName || ''}\n` +
        `üìß *Email:* \`${ticket.createdBy?.email || '–ù–µ–≤—ñ–¥–æ–º–∏–π'}\`\n` +
        `üèôÔ∏è *–ú—ñ—Å—Ç–æ:* ${ticket.city?.name || '–ù–µ –≤–∫–∞–∑–∞–Ω–æ'}\n` +
        `üè∑Ô∏è *–ö–∞—Ç–µ–≥–æ—Ä—ñ—è:* ${categoryText}\n` +
        `‚ö° *–ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç:* ${priorityText}\n` +
        `üìä *–°—Ç–∞—Ç—É—Å:* ${statusText}\n` +
        `üÜî *ID —Ç—ñ–∫–µ—Ç—É:* \`${ticket._id}\`\n\n` +
        `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`;

      await this.sendMessage(groupChatId, message, { parse_mode: 'Markdown' });
      logger.info('‚úÖ –°–ø–æ–≤—ñ—â–µ–Ω–Ω—è –ø—Ä–æ –Ω–æ–≤–∏–π —Ç—ñ–∫–µ—Ç –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ –≥—Ä—É–ø—É Telegram');
    } catch (error) {
      logger.error('–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è –ø—Ä–æ –Ω–æ–≤–∏–π —Ç—ñ–∫–µ—Ç –≤ –≥—Ä—É–ø—É:', error);
    }
  }

  getStatusText(status) {
    const statusMap = {
      'open': '–í—ñ–¥–∫—Ä–∏—Ç–æ',
      'in_progress': '–í —Ä–æ–±–æ—Ç—ñ',
      'resolved': '–í–∏—Ä—ñ—à–µ–Ω–æ',
      'closed': '–ó–∞–∫—Ä–∏—Ç–æ',
      'pending': '–û—á—ñ–∫—É—î'
    };
    return statusMap[status] || status;
  }

  getStatusEmoji(status) {
    const emojiMap = {
      'open': 'üîì',
      'in_progress': '‚öôÔ∏è',
      'resolved': '‚úÖ',
      'closed': 'üîí',
      'pending': '‚è≥'
    };
    return emojiMap[status] || 'üìã';
  }

  getPriorityText(priority) {
    const priorityMap = {
      'low': 'üü¢ –ù–∏–∑—å–∫–∏–π',
      'medium': 'üü° –°–µ—Ä–µ–¥–Ω—ñ–π',
      'high': 'üî¥ –í–∏—Å–æ–∫–∏–π',
      'urgent': 'üî¥üî¥ –ö—Ä–∏—Ç–∏—á–Ω–∏–π'
    };
    return priorityMap[priority] || priority;
  }

  getCategoryPromptText() {
    return `üè∑Ô∏è *–û–±–µ—Ä—ñ—Ç—å –∫–∞—Ç–µ–≥–æ—Ä—ñ—é —Ç—ñ–∫–µ—Ç—É*\n\n` +
      `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n` +
      `–ö–∞—Ç–µ–≥–æ—Ä—ñ—è –¥–æ–ø–æ–º–æ–∂–µ —à–≤–∏–¥—à–µ –æ–±—Ä–æ–±–∏—Ç–∏ –≤–∞—à –∑–∞–ø–∏—Ç.`;
  }

  getPriorityPromptText() {
    return `‚ö° *–û–±–µ—Ä—ñ—Ç—å –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç —Ç—ñ–∫–µ—Ç—É*\n\n` +
      `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n` +
      `–ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç –≤–∏–∑–Ω–∞—á–∞—î —à–≤–∏–¥–∫—ñ—Å—Ç—å –æ–±—Ä–æ–±–∫–∏ –≤–∞—à–æ–≥–æ –∑–∞–ø–∏—Ç—É.`;
  }

  getCancelButtonText() {
    return '‚ùå –°–∫–∞—Å—É–≤–∞—Ç–∏';
  }

  async generateCategoryButtons() {
    const categories = this.getAllCategories();
    const buttons = [];
    
    for (const category of categories) {
      const icon = category.icon && category.icon.trim() !== '' ? category.icon : '';
      const text = icon ? `${icon} ${category.name}` : category.name;
      buttons.push([{
        text: text,
        callback_data: `category_${category._id}`
      }]);
    }
    
    return buttons;
  }

  getAllCategories() {
    return Array.from(this.categoryCache.values());
  }

  async loadCategories() {
    try {
      const categories = await Category.find({ isActive: true })
        .select('name icon color')
        .sort({ name: 1 })
        .lean();
      
      this.categoryCache.clear();
      categories.forEach(cat => {
        this.categoryCache.set(cat._id.toString(), cat);
      });
      
      logger.debug(`–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ ${categories.length} –∫–∞—Ç–µ–≥–æ—Ä—ñ–π –≤ –∫–µ—à`);
    } catch (error) {
      logger.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–∞—Ç–µ–≥–æ—Ä—ñ–π:', error);
    }
  }

  async loadBotSettings() {
    try {
      this.botSettings = await BotSettings.findOne();
      if (this.botSettings) {
        logger.debug('–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –±–æ—Ç–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ');
      }
    } catch (error) {
      logger.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å –±–æ—Ç–∞:', error);
    }
  }

  async handleDynamicCategoryCallback(chatId, user, categoryId) {
    const session = this.userSessions.get(chatId);
    if (session) {
      session.ticketData.categoryId = categoryId;
      
      // –Ø–∫—â–æ —Ü–µ —à–∞–±–ª–æ–Ω–Ω–∏–π —Ç—ñ–∫–µ—Ç, –ø—Ä–æ–ø—É—Å–∫–∞—î–º–æ –≤–∏–±—ñ—Ä –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç—É
      if (session.isTemplate && session.templateId) {
        const template = await TicketTemplate.findById(session.templateId);
        if (template) {
          session.ticketData.title = template.title;
          session.ticketData.description = template.description;
          session.ticketData.priority = template.priority;
          session.ticketData.categoryId = template.category || categoryId;
          session.step = 'photo';
          
          await this.sendMessage(chatId,
            'üì∑ –•–æ—á–µ—Ç–µ –¥–æ–¥–∞—Ç–∏ —Ñ–æ—Ç–æ –¥–æ —Ç—ñ–∫–µ—Ç—É? (–Ω–µ–æ–±–æ–≤\'—è–∑–∫–æ–≤–æ)', {
              reply_markup: {
                inline_keyboard: [
                  [{ text: 'üì∑ –ü—Ä–∏–∫—Ä—ñ–ø–∏—Ç–∏ —Ñ–æ—Ç–æ', callback_data: 'template_add_photo' }],
                  [{ text: '‚è≠Ô∏è –ü—Ä–æ–ø—É—Å—Ç–∏—Ç–∏', callback_data: 'template_create_without_photo' }],
                  [{ text: this.getCancelButtonText(), callback_data: 'cancel_ticket' }]
                ]
              }
            }
          );
          return;
        }
      }
      
      session.step = 'priority';
      await this.sendMessage(chatId, 
        this.getPriorityPromptText(), {
          reply_markup: {
            inline_keyboard: [
              [{ text: this.getPriorityText('high'), callback_data: 'priority_high' }],
              [{ text: this.getPriorityText('medium'), callback_data: 'priority_medium' }],
              [{ text: this.getPriorityText('low'), callback_data: 'priority_low' }],
              [{ text: this.getCancelButtonText(), callback_data: 'cancel_ticket' }]
            ]
          }
        }
      );
    }
  }

  async handleUserRegistrationCallback(chatId, userId) {
    try {
      // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤–∂–µ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–∏–π
      const existingUser = await User.findOne({ 
        $or: [
          { telegramId: String(userId) },
          { telegramId: userId }
        ]
      });
      
      if (existingUser) {
        await this.sendMessage(chatId, 
          `‚úÖ *–í–∏ –≤–∂–µ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω—ñ!*\n\n` +
          `–í–∞—à –æ–±–ª—ñ–∫–æ–≤–∏–π –∑–∞–ø–∏—Å –≤–∂–µ —ñ—Å–Ω—É—î –≤ —Å–∏—Å—Ç–µ–º—ñ.\n\n` +
          `–í–∏–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ /start –¥–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É –º–µ–Ω—é.`
        );
        return;
      }

      // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ —î –∞–∫—Ç–∏–≤–Ω–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—è
      let pendingRegistration = await PendingRegistration.findOne({ 
        $or: [
          { telegramId: String(userId) },
          { telegramId: userId }
        ]
      });

      if (!pendingRegistration) {
        pendingRegistration = new PendingRegistration({
          telegramId: String(userId),
          telegramChatId: String(chatId),
          step: 'firstName',
          data: {}
        });
        await pendingRegistration.save();
      }

      await this.processRegistrationStep(chatId, userId, pendingRegistration);
    } catch (error) {
      logger.error('–ü–æ–º–∏–ª–∫–∞ –æ–±—Ä–æ–±–∫–∏ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó:', error);
      await this.sendMessage(chatId, 
        '‚ùå *–ü–æ–º–∏–ª–∫–∞*\n\n–í–∏–Ω–∏–∫–ª–∞ —Ç–µ—Ö–Ω—ñ—á–Ω–∞ –ø–æ–º–∏–ª–∫–∞. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑ –∞–±–æ –∑–≤–µ—Ä–Ω—ñ—Ç—å—Å—è –¥–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞: [@Kultup](https://t.me/Kultup)',
        { parse_mode: 'Markdown' }
      );
    }
  }

  async processRegistrationStep(chatId, userId, pendingRegistration) {
    try {
      const step = pendingRegistration.step;
      
      switch (step) {
        case 'firstName':
          await this.sendMessage(chatId, 
            `üìù *–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –≤ —Å–∏—Å—Ç–µ–º—ñ*\n\n` +
            `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n` +
            `üë§ *–ö—Ä–æ–∫ 1/7:* –í–≤–µ–¥—ñ—Ç—å –≤–∞—à–µ —ñ–º'—è\n\n` +
            `üí° –Ü–º'—è –ø–æ–≤–∏–Ω–Ω–æ –º—ñ—Å—Ç–∏—Ç–∏ —Ç—ñ–ª—å–∫–∏ –ª—ñ—Ç–µ—Ä–∏ —Ç–∞ –±—É—Ç–∏ –¥–æ–≤–∂–∏–Ω–æ—é –≤—ñ–¥ 2 –¥–æ 50 —Å–∏–º–≤–æ–ª—ñ–≤.`
          );
          break;
          
        case 'lastName':
          await this.sendMessage(chatId, 
            `‚úÖ *–Ü–º'—è –ø—Ä–∏–π–Ω—è—Ç–æ!*\n\n` +
            `üë§ *–Ü–º'—è:* ${pendingRegistration.data.firstName}\n\n` +
            `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n` +
            `üë§ *–ö—Ä–æ–∫ 2/7:* –í–≤–µ–¥—ñ—Ç—å –≤–∞—à–µ –ø—Ä—ñ–∑–≤–∏—â–µ\n\n` +
            `üí° –ü—Ä—ñ–∑–≤–∏—â–µ –ø–æ–≤–∏–Ω–Ω–æ –º—ñ—Å—Ç–∏—Ç–∏ —Ç—ñ–ª—å–∫–∏ –ª—ñ—Ç–µ—Ä–∏ —Ç–∞ –±—É—Ç–∏ –¥–æ–≤–∂–∏–Ω–æ—é –≤—ñ–¥ 2 –¥–æ 50 —Å–∏–º–≤–æ–ª—ñ–≤.`
          );
          break;
          
        case 'email':
          await this.sendMessage(chatId, 
            `‚úÖ *–ü—Ä—ñ–∑–≤–∏—â–µ –ø—Ä–∏–π–Ω—è—Ç–æ!*\n\n` +
            `üë§ *–ü—Ä—ñ–∑–≤–∏—â–µ:* ${pendingRegistration.data.lastName}\n\n` +
            `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n` +
            `üìß *–ö—Ä–æ–∫ 3/7:* –í–≤–µ–¥—ñ—Ç—å –≤–∞—à—É –µ–ª–µ–∫—Ç—Ä–æ–Ω–Ω—É –∞–¥—Ä–µ—Å—É\n\n` +
            `üí° *–ü—Ä–∏–∫–ª–∞–¥:* user@example.com`
          );
          break;
          
        case 'phone':
          await this.sendMessage(chatId, 
            `‚úÖ *Email –ø—Ä–∏–π–Ω—è—Ç–æ!*\n\n` +
            `üìß *Email:* \`${pendingRegistration.data.email}\`\n\n` +
            `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n` +
            `üì± *–ö—Ä–æ–∫ 4/7:* –í–≤–µ–¥—ñ—Ç—å –≤–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É\n\n` +
            `üí° *–ü—Ä–∏–∫–ª–∞–¥:* +380501234567\n\n` +
            `–ê–±–æ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É –Ω–∏–∂—á–µ, —â–æ–± –ø–æ–¥—ñ–ª–∏—Ç–∏—Å—è –Ω–æ–º–µ—Ä–æ–º:`,
            {
              reply_markup: {
                keyboard: [
                  [{
                    text: 'üì± –ü–æ–¥—ñ–ª–∏—Ç–∏—Å—è –Ω–æ–º–µ—Ä–æ–º',
                    request_contact: true
                  }]
                ],
                resize_keyboard: true,
                one_time_keyboard: true
              }
            }
          );
          break;
          
        case 'password':
          await this.sendMessage(chatId, 
            `‚úÖ *–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É –ø—Ä–∏–π–Ω—è—Ç–æ!*\n\n` +
            `üì± *–ù–æ–º–µ—Ä:* ${pendingRegistration.data.phone}\n\n` +
            `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n` +
            `üîê *–ö—Ä–æ–∫ 5/7:* –í–≤–µ–¥—ñ—Ç—å –ø–∞—Ä–æ–ª—å\n\n` +
            `üí° –ü–∞—Ä–æ–ª—å –ø–æ–≤–∏–Ω–µ–Ω –º—ñ—Å—Ç–∏—Ç–∏:\n` +
            `‚Ä¢ –ú—ñ–Ω—ñ–º—É–º 6 —Å–∏–º–≤–æ–ª—ñ–≤\n` +
            `‚Ä¢ –ü—Ä–∏–Ω–∞–π–º–Ω—ñ –æ–¥–Ω—É –ª—ñ—Ç–µ—Ä—É\n` +
            `‚Ä¢ –ü—Ä–∏–Ω–∞–π–º–Ω—ñ –æ–¥–Ω—É —Ü–∏—Ñ—Ä—É\n\n` +
            `üí° *–ü—Ä–∏–∫–ª–∞–¥:* MyPass123`
          );
          break;
          
        case 'city':
          await this.sendCitySelection(chatId, userId);
          break;
          
        case 'position':
          await this.sendPositionSelection(chatId, userId);
          break;
          
        case 'completed':
          await this.completeRegistration(chatId, userId, pendingRegistration);
          break;
          
        default:
          await this.sendMessage(chatId, '‚ùå –ü–æ–º–∏–ª–∫–∞ –≤ –ø—Ä–æ—Ü–µ—Å—ñ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó. –°–ø—Ä–æ–±—É–π—Ç–µ –ø–æ—á–∞—Ç–∏ –∑–∞–Ω–æ–≤–æ.');
      }
    } catch (error) {
      logger.error('–ü–æ–º–∏–ª–∫–∞ –æ–±—Ä–æ–±–∫–∏ –∫—Ä–æ–∫—É —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó:', error);
      await this.sendMessage(chatId, 
        '‚ùå *–ü–æ–º–∏–ª–∫–∞*\n\n–í–∏–Ω–∏–∫–ª–∞ —Ç–µ—Ö–Ω—ñ—á–Ω–∞ –ø–æ–º–∏–ª–∫–∞. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑ –∞–±–æ –∑–≤–µ—Ä–Ω—ñ—Ç—å—Å—è –¥–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞: [@Kultup](https://t.me/Kultup)',
        { parse_mode: 'Markdown' }
      );
    }
  }

  async sendCitySelection(chatId, userId) {
    try {
      const cities = await City.find({ isActive: true })
        .select('name region')
        .sort({ name: 1 })
        .limit(50)
        .lean();

      if (cities.length === 0) {
        await this.sendMessage(chatId, 
          `‚ùå *–ù–µ–º–∞—î –¥–æ—Å—Ç—É–ø–Ω–∏—Ö –º—ñ—Å—Ç*\n\n` +
          `–ó–≤–µ—Ä–Ω—ñ—Ç—å—Å—è –¥–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞: [@Kultup](https://t.me/Kultup)`,
          { parse_mode: 'Markdown' }
        );
        return;
      }

      const keyboard = [];
      cities.forEach(city => {
        keyboard.push([{
          text: `üèôÔ∏è ${city.name}${city.region ? ` (${city.region})` : ''}`,
          callback_data: `city_${city._id}`
        }]);
      });

      await this.sendMessage(chatId, 
        `‚úÖ *–ü–∞—Ä–æ–ª—å –ø—Ä–∏–π–Ω—è—Ç–æ!*\n\n` +
        `üîê *–ü–∞—Ä–æ–ª—å:* \`********\`\n\n` +
        `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n` +
        `üèôÔ∏è *–ö—Ä–æ–∫ 6/7:* –û–±–µ—Ä—ñ—Ç—å –≤–∞—à–µ –º—ñ—Å—Ç–æ`,
        {
          reply_markup: {
            inline_keyboard: keyboard
          }
        }
      );
    } catch (error) {
      logger.error('–ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Å–ø–∏—Å–∫—É –º—ñ—Å—Ç:', error);
      await this.sendMessage(chatId, '–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–ø–∏—Å–∫—É –º—ñ—Å—Ç. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.');
    }
  }

  async sendPositionSelection(chatId, userId) {
    try {
      const positions = await Position.find({ isActive: true })
        .select('name')
        .sort({ name: 1 })
        .limit(50)
        .lean();

      if (positions.length === 0) {
        await this.sendMessage(chatId, 
          `‚ùå *–ù–µ–º–∞—î –¥–æ—Å—Ç—É–ø–Ω–∏—Ö –ø–æ—Å–∞–¥*\n\n` +
          `–ó–≤–µ—Ä–Ω—ñ—Ç—å—Å—è –¥–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞: [@Kultup](https://t.me/Kultup)`,
          { parse_mode: 'Markdown' }
        );
        return;
      }

      const keyboard = [];
      positions.forEach(position => {
        keyboard.push([{
          text: `üíº ${position.name}`,
          callback_data: `position_${position._id}`
        }]);
      });

      await this.sendMessage(chatId, 
        `‚úÖ *–ú—ñ—Å—Ç–æ –æ–±—Ä–∞–Ω–æ!*\n\n` +
        `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n` +
        `üíº *–ö—Ä–æ–∫ 7/7:* –û–±–µ—Ä—ñ—Ç—å –≤–∞—à—É –ø–æ—Å–∞–¥—É`,
        {
          reply_markup: {
            inline_keyboard: keyboard
          }
        }
      );
    } catch (error) {
      logger.error('–ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Å–ø–∏—Å–∫—É –ø–æ—Å–∞–¥:', error);
      await this.sendMessage(chatId, '–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–ø–∏—Å–∫—É –ø–æ—Å–∞–¥. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.');
    }
  }

  async handleRegistrationCallback(chatId, userId, data) {
    try {
      const pendingRegistration = await PendingRegistration.findOne({ 
        $or: [
          { telegramId: String(userId) },
          { telegramId: userId }
        ]
      });

      if (!pendingRegistration) {
        await this.sendMessage(chatId, '–í–∏ –Ω–µ –≤ –ø—Ä–æ—Ü–µ—Å—ñ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó. –í–∏–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ /start –¥–ª—è –ø–æ—á–∞—Ç–∫—É.');
        return;
      }

      if (data.startsWith('city_')) {
        const cityId = data.replace('city_', '');
        pendingRegistration.data.city = cityId;
        pendingRegistration.step = 'position';
        await pendingRegistration.save();
        await this.processRegistrationStep(chatId, userId, pendingRegistration);
      } else if (data.startsWith('position_')) {
        const positionId = data.replace('position_', '');
        pendingRegistration.data.position = positionId;
        pendingRegistration.step = 'completed';
        await pendingRegistration.save();
        await this.processRegistrationStep(chatId, userId, pendingRegistration);
      }
    } catch (error) {
      logger.error('–ü–æ–º–∏–ª–∫–∞ –æ–±—Ä–æ–±–∫–∏ callback —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó:', error);
      await this.sendMessage(chatId, '–ü–æ–º–∏–ª–∫–∞ –æ–±—Ä–æ–±–∫–∏ –≤–∏–±–æ—Ä—É. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.');
    }
  }

  async completeRegistration(chatId, userId, pendingRegistration) {
    try {
      const { firstName, lastName, email, phone, password, city, position } = pendingRegistration.data;

      // –°—Ç–≤–æ—Ä—é—î–º–æ –Ω–æ–≤–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
      const user = new User({
        firstName,
        lastName,
        email,
        phone,
        password, // –í —Ä–µ–∞–ª—å–Ω–æ–º—É –ø—Ä–æ–µ–∫—Ç—ñ –ø–æ—Ç—Ä—ñ–±–Ω–æ —Ö–µ—à—É–≤–∞—Ç–∏
        city,
        position,
        telegramId: String(userId),
        telegramChatId: String(chatId),
        telegramUsername: pendingRegistration.telegramUsername,
        isActive: false, // –ü–æ—Ç—Ä–µ–±—É—î –∞–∫—Ç–∏–≤–∞—Ü—ñ—ó –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º
        registrationStatus: 'pending'
      });

      await user.save();
      
      // –í–∏–¥–∞–ª—è—î–º–æ —Ç–∏–º—á–∞—Å–æ–≤—É —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—é
      await PendingRegistration.deleteOne({ _id: pendingRegistration._id });

      await this.sendMessage(chatId, 
        `üéâ *–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!*\n\n` +
        `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n` +
        `‚úÖ –í–∞—à –æ–±–ª—ñ–∫–æ–≤–∏–π –∑–∞–ø–∏—Å —Å—Ç–≤–æ—Ä–µ–Ω–æ.\n\n` +
        `‚è≥ *–û—á—ñ–∫—É–π—Ç–µ –∞–∫—Ç–∏–≤–∞—Ü—ñ—ó*\n\n` +
        `–í–∞—à –æ–±–ª—ñ–∫–æ–≤–∏–π –∑–∞–ø–∏—Å –ø–æ—Ç—Ä–µ–±—É—î –∞–∫—Ç–∏–≤–∞—Ü—ñ—ó –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.\n\n` +
        `üìû –ó–≤–µ—Ä–Ω—ñ—Ç—å—Å—è –¥–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü—ñ—ó: [@Kultup](https://t.me/Kultup)\n\n` +
        `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`,
        { parse_mode: 'Markdown' }
      );

      logger.info(`–ù–æ–≤–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—è —á–µ—Ä–µ–∑ Telegram: ${email} (${userId})`);
    } catch (error) {
      logger.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó:', error);
      await this.sendMessage(chatId, 
        '‚ùå *–ü–æ–º–∏–ª–∫–∞*\n\n–í–∏–Ω–∏–∫–ª–∞ —Ç–µ—Ö–Ω—ñ—á–Ω–∞ –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ñ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑ –∞–±–æ –∑–≤–µ—Ä–Ω—ñ—Ç—å—Å—è –¥–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞: [@Kultup](https://t.me/Kultup)',
        { parse_mode: 'Markdown' }
      );
    }
  }

  async askForPassword(chatId) {
    await this.sendMessage(chatId, 
      `üîê *–ö—Ä–æ–∫ 5/7:* –í–≤–µ–¥—ñ—Ç—å –ø–∞—Ä–æ–ª—å\n\n` +
      `üí° –ü–∞—Ä–æ–ª—å –ø–æ–≤–∏–Ω–µ–Ω –º—ñ—Å—Ç–∏—Ç–∏:\n` +
      `‚Ä¢ –ú—ñ–Ω—ñ–º—É–º 6 —Å–∏–º–≤–æ–ª—ñ–≤\n` +
      `‚Ä¢ –ü—Ä–∏–Ω–∞–π–º–Ω—ñ –æ–¥–Ω—É –ª—ñ—Ç–µ—Ä—É\n` +
      `‚Ä¢ –ü—Ä–∏–Ω–∞–π–º–Ω—ñ –æ–¥–Ω—É —Ü–∏—Ñ—Ä—É\n\n` +
      `üí° *–ü—Ä–∏–∫–ª–∞–¥:* MyPass123`
    );
  }

  async handleFeedbackMessage(chatId, text, user) {
    // Placeholder for feedback handling
    // This can be implemented based on your requirements
    return false;
  }
}

module.exports = TelegramService;