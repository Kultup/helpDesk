const Groq = require('groq-sdk');
const logger = require('../utils/logger');
const BotSettings = require('../models/BotSettings');
const GroqApiUsage = require('../models/GroqApiUsage');
const slaLearningService = require('./slaLearningService');
const fs = require('fs');

class GroqService {
  constructor() {
    this.client = null;
    this.settings = null;
    this.adminTelegramId = '6070910226'; // ID адміна для сповіщень
  }

  async initialize() {
    try {
      this.settings = await BotSettings.findOne({ key: 'default' });

      if (!this.settings?.groqApiKey) {
        logger.warn('Groq API ключ не налаштовано');
        return false;
      }

      if (!this.settings.aiEnabled) {
        logger.info('AI асистент вимкнено в налаштуваннях');
        return false;
      }

      this.client = new Groq({
        apiKey: this.settings.groqApiKey
      });

      logger.info('✅ Groq AI сервіс ініціалізовано');
      return true;
    } catch (error) {
      logger.error('Помилка ініціалізації Groq сервісу:', error);
      return false;
    }
  }

  async getAIResponse(userMessage, conversationHistory = [], context = {}) {
    try {
      if (!this.client) {
        await this.initialize();
      }

      if (!this.client) {
        return null;
      }

      let systemPrompt = this.settings.aiSystemPrompt;
      
      if (!systemPrompt) {
        systemPrompt = `
Ви - інтелектуальний асистент системи HelpDesk (@Kultup_bot). Ваша мета - допомагати користувачам вирішувати технічні питання та надавати інформацію про їхні заявки.

ОСНОВНІ ПРАВИЛА:
1. МОВА: Спілкуйтеся виключно українською мовою. Якщо користувач пише іншою мовою (англійська, російська тощо) - відповідайте українською, але розумійте суть запиту.
2. ПЕРЕКЛАД: Якщо користувач просить створити заявку іншою мовою, перекладіть опис проблеми на українську перед створенням, але в дужках залиште оригінал.
3. ТОН: Будьте ввічливим, професійним, лаконічним та емпатичним.
4. БАЗА ЗНАНЬ: Якщо у контексті є інформація з бази знань (Knowledge Base), ВИКОРИСТОВУЙТЕ її для відповіді. Це перевірена інформація.

ФУНКЦІОНАЛ БОТА (що ви можете порадити):
- 📝 Створити заявку: Команда /create або просто описати проблему (текстом чи голосом).
- 📋 Мої заявки: Команда /tickets - перегляд списку створених заявок та їх статусу.
- 🏠 Головне меню: Команда /start або /menu - повернення до початкового екрану.
- 📞 Контакти: Бот має кнопку "Поділитися контактом" для реєстрації.
- 🎤 Голосові: Бот розуміє голосові повідомлення та перетворює їх на текст.
- 📸 Фото: Можна додавати фото до заявок при створенні.

ЯК ВІДПОВІДАТИ:
- Якщо користувач повідомляє про проблему (наприклад, "не працює принтер"):
  1. Спочатку перевірте, чи є рішення в БАЗІ ЗНАНЬ (надається в контексті). Якщо є - дайте коротку інструкцію.
  2. Якщо рішення немає, попросіть деталі або запропонуйте створити заявку (/create).
  
- Якщо користувач запитує статус:
  1. Використовуйте надану вам інформацію про тікети (з контексту).
  2. Якщо інформації немає, порадьте використати команду /tickets.

- Якщо користувач хоче поговорити з людиною:
  1. Порадьте звернутися до адміністратора @Kultup.

ОБМЕЖЕННЯ:
- Ви НЕ можете прямо змінювати статус заявок, закривати їх чи видаляти.
- Ви НЕ можете змінювати паролі користувачів.
- Ви НЕ бачите особистих повідомлень інших користувачів.
- Не вигадуйте неіснуючі функції (наприклад, "зателефонувати через бота").

ПРИКЛАДИ ВІДПОВІДЕЙ:
- Користувач: "Не працює інтернет"
  Ви: (Якщо є в базі знань) "Згідно з інструкцією, спробуйте перезавантажити роутер Cisco (кнопка ззаду). Якщо не допоможе - створіть заявку."
  (Якщо немає) "Спробуйте перезавантажити роутер. Якщо не допоможе, я можу створити заявку. Опишіть детальніше, де саме немає інтернету, або введіть /create."
- Користувач: "My printer is broken"
  Ви: "Я розумію, що у вас зламався принтер. Спробуйте перевірити підключення. Якщо не допоможе, створіть заявку командою /create."
`;
      }
      
      const AIKnowledge = require('../models/AIKnowledge');
      let kbContext = '';
      try {
        // Пошук по текстовому індексу (за наявності), fallback на regex
        const q = userMessage.trim();
        let docs = [];
        if (q.length > 3) {
          try {
            docs = await AIKnowledge.find({ isActive: true, $text: { $search: q } })
              .sort({ score: { $meta: 'textScore' }, updatedAt: -1 })
              .limit(3);
          } catch (_err) {
            const keywords = q.split(' ').filter(w => w.length > 3).slice(0, 5);
            if (keywords.length > 0) {
              const regex = new RegExp(keywords.join('|'), 'i');
              docs = await AIKnowledge.find({ isActive: true, $or: [{ title: regex }, { content: regex }, { tags: regex }] }).limit(3);
            }
          }
        }
        if (docs.length > 0) {
          kbContext = `\n\nДОВІДКОВА ІНФОРМАЦІЯ З AI ЗНАНЬ (використай це для відповіді):\n`;
          docs.forEach(doc => {
            const snippet = typeof doc.content === 'string' ? doc.content.substring(0, 500) : '';
            kbContext += `--- ${doc.title} ---\n${snippet}...\n\n`;
          });
        }
      } catch (kbError) {
        logger.error('Помилка пошуку AI знань:', kbError);
      }

      if (context.tickets && context.tickets.length > 0) {
        const ticketsInfo = context.tickets.map(t => 
          `- Тікет №${t.ticketNumber || t._id}: "${t.title}" (Статус: ${t.status}, Створено: ${new Date(t.createdAt).toLocaleDateString('uk-UA')})`
        ).join('\n');
        
        systemPrompt += `\n\nІнформація про тікети користувача:\n${ticketsInfo}\n\nЯкщо користувач запитує про статус своїх заявок, використовуй ці дані.`;
      }
      
      if (kbContext) {
          systemPrompt += kbContext;
      }

      const messages = [
        {
          role: 'system',
          content: systemPrompt
        },
        ...conversationHistory,
        {
          role: 'user',
          content: userMessage
        }
      ];

      const chatCompletion = await this.client.chat.completions.create({
        messages: messages,
        model: this.settings.groqModel || 'llama-3.3-70b-versatile',
        temperature: 0.7,
        max_tokens: 1024,
        top_p: 1,
        stream: false
      });

      const response = chatCompletion.choices[0]?.message?.content;

      if (!response) {
        logger.warn('Groq повернув порожню відповідь');
        return null;
      }

      // Трекінг використання API
      await this.trackApiUsage(
        this.settings.groqModel || 'llama-3.3-70b-versatile', 
        chatCompletion,
        { tokensUsed: chatCompletion.usage?.total_tokens || 0 }
      );

      return response;
    } catch (error) {
      logger.error('Помилка отримання відповіді від Groq:', error);
      return null;
    }
  }

  /**
   * Аналізує намір користувача та витягує дані для тікета
   */
  async analyzeIntent(userMessage) {
    try {
      if (!this.client) {
        await this.initialize();
      }

      if (!this.client) {
        return { isTicketIntent: false };
      }

      const systemPrompt = `
        Ви - аналізатор намірів користувача для системи HelpDesk. 
        Ваше завдання - точно проаналізувати повідомлення користувача та визначити, чи повідомляє він про проблему.
        
        ⚠️ УКРАЇНСЬКА СПЕЦИФІКА - ЦЕ НЕ IT ПРОБЛЕМИ:
        🚫 "Немає світла" / "Відключили світло" / "Вимкнули світло" / "Відсутнє електроживлення"
           → isTicketIntent = FALSE (це форс-мажор, не IT проблема!)
        
        🚫 "Не працює інтернет через світло" / "Комп'ютер не працює через світло"
           → isTicketIntent = FALSE (причина - відключення електрики)
        
        🚫 "Коли дадуть світло?" / "Коли буде світло?"
           → isTicketIntent = FALSE (це не до IT підтримки)
        
        ✅ "Після повернення світла сервер не запустився" → isTicketIntent = TRUE
        ✅ "Не працює UPS" → isTicketIntent = TRUE
        ✅ "Потрібен генератор" → isTicketIntent = TRUE
        
        ВАЖЛИВО:
        1. Заголовок (title) - КОРОТКИЙ опис проблеми (3-10 слів)
        2. Опис (description) - ДЕТАЛЬНИЙ, НЕ може дублювати заголовок! Має містити що саме не працює
        3. НЕ вигадуйте проблеми або деталі, яких немає в повідомленні
        4. МОВА: Якщо вхідний текст не українською, ПЕРЕКЛАДІТЬ на українську
        
        ⚖️ БАЛАНС: "Достатньо" VS "Ідеально"
        
        🎯 ОБОВ'ЯЗКОВІ ДЕТАЛІ ДЛЯ ТИПОВИХ ПРОБЛЕМ:
        
        🖨️ ПРИНТЕР (потрібно мінімум 3 з 4):
        ✓ Модель/виробник (HP, Canon...)
        ✓ Що САМЕ не працює (не вмикається / не друкує / застряг папір / помилка)
        ✓ Індикатори (червоний, жовтий, блимає...)
        ✓ Текст помилки (E3, Paper Jam...)
        
        💻 КОМП'ЮТЕР (потрібно мінімум 2 з 3):
        ✓ Що САМЕ не так (гальмує / не вмикається / зависає / синій екран)
        ✓ Коли почалося (сьогодні / після оновлення / після перезавантаження)
        ✓ Які програми (всі / Excel / браузер)
        
        🌐 ІНТЕРНЕТ (потрібно мінімум 2 з 3):
        ✓ Де немає (весь офіс / одне робоче місце / WiFi)
        ✓ Що саме (зовсім немає / дуже повільно / періодично пропадає)
        ✓ Коли почалося (сьогодні з ранку / зараз тільки / вчора)
        
        ⚠️ ПРАВИЛО: Для принтера, комп'ютера, інтернету - завжди needsMoreInfo = true якщо немає мінімуму деталей!
        
        📱 ІНШЕ ОБЛАДНАННЯ:
        - Якщо є БАЗОВА інформація (що зламалось + 1-2 деталі) → needsMoreInfo = false
        
        Доступні пріоритети: "low", "medium", "high", "urgent"
        
        Поверніть відповідь ТІЛЬКИ у форматі JSON:
        {
          "isTicketIntent": boolean, // FALSE якщо це не IT проблема (наприклад: немає світла)
          "title": string | null,
          "description": string | null,
          "priority": string | null,
          "confidence": number,
          "category": string | null, // Hardware, Software, Network, Access, Other
          "sentiment": string | null, // positive, neutral, negative
          "ticketType": string | null, // incident (зламалося), request (потрібно щось нове)
          "needsMoreInfo": boolean, // true якщо опису недостатньо для створення тікета
          "missingInfo": string[], // що треба уточнити ["модель пристрою", "коли виникла проблема", тощо]
          "rejectionReason": string | null // Якщо isTicketIntent=false, вкажіть чому (наприклад: "Це не IT проблема - відключення електроенергії")
        }
        
        Приклади:
        
        ❌ ЗАНАДТО МАЛО (needsMoreInfo = true):
        - "не працює" -> КРИТИЧНО мало! Що саме?
        - "проблема" -> КРИТИЧНО мало! Яка проблема?
        - "Не працює принтер" -> Мало! Яка модель? Що саме не працює? Індикатори?
        - "Принтер HP" -> Мало! Що саме з ним не так?
        - "Комп'ютер гальмує" -> Мало! Які програми? Коли почалося?
        - "Немає інтернету" -> Мало! Де саме? Коли почалося?
        
        ⚠️ МАЛО ДЛЯ ПРИНТЕРА (needsMoreInfo = true):
        - "Не друкує принтер HP" -> 
           needsMoreInfo: true, 
           missingInfo: ["що саме не працює - взагалі не вмикається чи не друкує", "чи горять індикатори або є помилка на екрані"]
        
        ✅ ДОСТАТНЬО ДЛЯ ПРИНТЕРА (needsMoreInfo = false):
        - "Принтер HP не друкує, горить червоний індикатор" ->
           title: "Не друкує принтер HP",
           description: "Принтер HP перестав друкувати, горить червоний індикатор",
           needsMoreInfo: false (модель + проблема + індикатор = 3 деталі!)
        
        ✅ ДОСТАТНЬО ДЛЯ КОМП'ЮТЕРА (needsMoreInfo = false):
        - "Комп'ютер гальмує після оновлення Windows" ->
           title: "Комп'ютер гальмує після оновлення",
           description: "Комп'ютер почав гальмувати після оновлення Windows",
           needsMoreInfo: false (проблема + час = 2 деталі!)
        
        ✅ ДОСТАТНЬО ДЛЯ ІНТЕРНЕТУ (needsMoreInfo = false):
        - "Немає інтернету в бухгалтерії з ранку" ->
           title: "Немає інтернету в бухгалтерії",
           description: "В бухгалтерії відсутнє інтернет-з'єднання з ранку",
           needsMoreInfo: false (місце + час = 2 деталі!)
        
        ✅✅ ВІДМІННО (needsMoreInfo = false):
        - "HP LaserJet не друкує, на екрані помилка E3, індикатор червоний" ->
           title: "HP LaserJet не друкує - помилка E3",
           description: "Принтер HP LaserJet перестав друкувати. На екрані відображається помилка E3, індикатор світиться червоним кольором",
           needsMoreInfo: false,
           category: "Hardware"
        
        💡 ПРАВИЛО: Для принтера/комп'ютера/інтернету потрібно БІЛЬШЕ деталей, ніж просто "що зламалось"!
        
        🚫 НЕ IT ПРОБЛЕМИ (isTicketIntent = false):
        - "Не має світла" ->
           isTicketIntent: false,
           rejectionReason: "Це не IT проблема. Відключення електроенергії - форс-мажор. Якщо після повернення світла щось не працює - звертайтесь."
        
        - "Немає світла в офісі" ->
           isTicketIntent: false,
           rejectionReason: "Це не технічна проблема, а відсутність електроживлення. Зачекайте поки дадуть світло."
        
        - "Коли дадуть світло?" ->
           isTicketIntent: false,
           rejectionReason: "На жаль, це не залежить від IT підтримки. Слідкуйте за графіками відключень."
      `;

      const chatCompletion = await this.client.chat.completions.create({
        messages: [
          { role: 'system', content: systemPrompt },
          { role: 'user', content: userMessage }
        ],
        model: 'llama-3.3-70b-versatile', // Використовуємо потужнішу модель для кращої точності
        temperature: 0.1, // Низька температура для стабільності JSON
        response_format: { type: 'json_object' }
      });

      const responseText = chatCompletion.choices[0]?.message?.content;
      if (!responseText) {return { isTicketIntent: false };}

      const result = JSON.parse(responseText);
      logger.info('Результат аналізу наміру AI:', result);
      
      // Трекінг використання API
      await this.trackApiUsage('llama-3.3-70b-versatile', chatCompletion, {
        tokensUsed: chatCompletion.usage?.total_tokens || 0
      });
      
      return result;
    } catch (error) {
      logger.error('Помилка аналізу наміру через Groq:', error);
      return { isTicketIntent: false };
    }
  }

  /**
   * Генерує ОДНЕ природне уточнююче питання (покроковий збір)
   * @param {string} title - Заголовок проблеми
   * @param {string[]} missingInfo - Список того, що треба уточнити
   * @param {string} category - Категорія проблеми
   * @param {string} lastUserMessage - Остання відповідь користувача
   * @param {Array} conversationHistory - Історія діалогу
   * @param {number} currentRound - Поточний раунд питань
   * @returns {Promise<string>} - Природне питання
   */
  async generateNextQuestion(title, missingInfo = [], category = null, lastUserMessage = '', conversationHistory = [], currentRound = 1) {
    try {
      if (!this.client) {
        await this.initialize();
      }

      if (!this.client) {
        return '📝 Розкажіть, будь ласка, що саме не працює?';
      }

      const systemPrompt = `
Ви - дружній асистент корпоративної технічної підтримки. Ведете ПРИРОДНИЙ ДІАЛОГ з працівником компанії.

🎯 ВАША МЕТА: Задати ОДНЕ наступне питання для з'ясування робочої проблеми.

⚠️ КОНТЕКСТ: Це КОРПОРАТИВНА система HelpDesk
- Всі заявки - РОБОЧІ (офісні комп'ютери, офісні принтери, робочі програми)
- НЕ питайте про "домашній чи офісний" - все офісне!
- НЕ питайте про особисті пристрої
- Орієнтуйтесь на робоче обладнання компанії

ПРАВИЛА ЖИВОГО СПІЛКУВАННЯ:
1. ✅ Спочатку ВІДРЕАГУЙТЕ на попередню відповідь (якщо є):
   - "Зрозумів!", "Ага, ясно", "Добре", "Дякую", "Так-так"
   
2. ✅ Потім задайте ОДНЕ конкретне питання
   
3. ✅ Будьте природними:
   - НЕ: "📝 Уточніть, будь ласка: • Питання 1? • Питання 2?"
   - ТАК: "Зрозумів! Який саме принтер не працює?"
   
4. ✅ Використовуйте емодзі, але не переборщуйте (1-2 макс)

5. ✅ Варіюйте формулювання:
   - "А що саме...", "Скажіть, будь ласка...", "Уточніть..."
   - "Коли це почалося?", "Де це відбувається?", "Що написано..."
   
6. ✅ Корисні уточнення для офісу:
   - Який кабінет/відділ?
   - Яка модель/марка обладнання?
   - Коли почалося? (сьогодні, після оновлення...)
   - Що саме не працює?

СТРУКТУРА ВІДПОВІДІ:
[Реакція на попереднє] + [Одне питання]

ПРИКЛАДИ:

Користувач: "Не працює принтер"
Ви: "Зрозумів! Який саме принтер? HP чи Canon?"

Користувач: "HP LaserJet"
Ви: "Добре. Що саме відбувається - він взагалі не вмикається чи не друкує?"

Користувач: "Не друкує, горить червоний індикатор"
Ви: "Ага. А на екрані принтера щось написано?"

Користувач: "Комп'ютер гальмує"
Ві: "Розумію. Коли це почалося - сьогодні чи після оновлення?"

Користувач: "Немає інтернету"
Ви: "Зрозумів! У якому кабінеті немає зв'язку?"

⚠️ НЕ ПИШІТЬ СПИСКИ ПИТАНЬ! ТІЛЬКИ ОДНЕ ПИТАННЯ!
⚠️ НЕ ПИТАЙТЕ ПРО ДОМАШНІ РЕЧІ - ЦЕ ОФІСНА СИСТЕМА!
`;

      // Формуємо контекст діалогу
      let conversationContext = `Проблема: ${title}\nКатегорія: ${category || 'Невідома'}\n\n`;
      
      if (conversationHistory.length > 0) {
        conversationContext += `ДІАЛОГ:\n`;
        conversationHistory.slice(-4).forEach(msg => {
          if (msg.role === 'user') {
            conversationContext += `Користувач: ${msg.content}\n`;
          } else {
            conversationContext += `Ви: ${msg.content}\n`;
          }
        });
      }
      
      if (lastUserMessage) {
        conversationContext += `\nОстання відповідь користувача: "${lastUserMessage}"\n`;
      }
      
      conversationContext += `\nЩо ще треба уточнити: ${missingInfo.join(', ')}`;

      const chatCompletion = await this.client.chat.completions.create({
        messages: [
          { role: 'system', content: systemPrompt },
          { role: 'user', content: conversationContext }
        ],
        model: this.settings.groqModel || 'llama-3.3-70b-versatile',
        temperature: 0.7, // Вища температура для більш природного діалогу
        max_tokens: 150
      });

      // Трекінг використання API
      await this.trackApiUsage(
        this.settings.groqModel || 'llama-3.3-70b-versatile',
        chatCompletion,
        { tokensUsed: chatCompletion.usage?.total_tokens || 0 }
      );

      const response = chatCompletion.choices[0]?.message?.content?.trim() || 
        '📝 Розкажіть, будь ласка, більше деталей про проблему?';
      
      return response;
    } catch (error) {
      logger.error('Помилка генерації питання:', error);
      const randomResponses = [
        'Розкажіть, будь ласка, що саме відбувається?',
        'Уточніть, коли це почалося?',
        'Що саме не працює?'
      ];
      return randomResponses[Math.floor(Math.random() * randomResponses.length)];
    }
  }

  async reloadSettings() {
    try {
      this.settings = await BotSettings.findOne({ key: 'default' });

      if (this.settings?.groqApiKey && this.settings.aiEnabled) {
        this.client = new Groq({
          apiKey: this.settings.groqApiKey
        });
        logger.info('✅ Налаштування Groq оновлено');
        return true;
      } else {
        this.client = null;
        logger.info('Groq AI вимкнено');
        return false;
      }
    } catch (error) {
      logger.error('Помилка перезавантаження налаштувань Groq:', error);
      return false;
    }
  }

  isEnabled() {
    return this.client !== null && this.settings?.aiEnabled === true;
  }

  /**
   * Аналізує тікет та надає рекомендації
   * @param {Object} ticket - Об'єкт тікета з полями title, description, status, priority, comments, history
   * @param {Object} context - Додатковий контекст (користувач, місто, заклад тощо)
   * @returns {Promise<Object>} - Результат аналізу з рекомендаціями
   */
  async analyzeTicket(ticket, _context = {}) {
    try {
      if (!this.client) {
        await this.initialize();
      }

      if (!this.client) {
        return null;
      }

      // 🎓 НАВЧАННЯ: Отримуємо статистику подібних тікетів
      const learningData = await slaLearningService.getRecommendedSLA(ticket);
      logger.info('📊 Історичні дані для аналізу тікета:', {
        hasLearning: learningData.hasLearning,
        recommendedHours: learningData.recommendedHours,
        confidence: learningData.confidence,
        similarTickets: learningData.basedOn?.similarTickets
      });

      // Формуємо секцію з історичними даними для AI
      let historicalDataSection = '';
      if (learningData.hasLearning) {
        historicalDataSection = `
════════════════════════════════════════════════════════════════════════════
📊 ІСТОРИЧНІ ДАНІ (НАВЧАННЯ НА РЕАЛЬНИХ ТІКЕТАХ)
════════════════════════════════════════════════════════════════════════════
✅ Знайдено ${learningData.basedOn.similarTickets} подібних вирішених тікетів!

РЕАЛЬНА СТАТИСТИКА ВИКОНАННЯ:
• Середній час виконання: ${learningData.basedOn.averageActual} год
• Медіана (найтиповіший час): ${learningData.basedOn.medianActual} год
• Діапазон: ${learningData.basedOn.range}
• Точність попередніх прогнозів: ${learningData.basedOn.previousAccuracy}

🎯 РЕКОМЕНДАЦІЯ НА ОСНОВІ ДАНИХ:
SLA: ${learningData.recommendedHours} год (впевненість ${learningData.confidence}%)
Обгрунтування: ${learningData.reason}

⚠️ ВАЖЛИВО: Ця рекомендація базується на РЕАЛЬНИХ даних, а не теоретичних!
Використайте це значення, якщо воно близьке до вашого аналізу.
════════════════════════════════════════════════════════════════════════════
`;
      } else {
        historicalDataSection = `
════════════════════════════════════════════════════════════════════════════
📊 ІСТОРИЧНІ ДАНІ
════════════════════════════════════════════════════════════════════════════
❌ Недостатньо історичних даних для цього типу проблеми
Причина: ${learningData.reason}

⚠️ Використовуйте стандартну таблицю SLA та реальні приклади нижче.
════════════════════════════════════════════════════════════════════════════
`;
      }

      const systemPrompt = `
Ви - експерт-аналітик системи HelpDesk з можливістю НАВЧАННЯ НА РЕАЛЬНИХ ДАНИХ.
Ваше завдання - проаналізувати заявку (тікет) та надати корисні рекомендації для її вирішення.

${historicalDataSection}

ОСНОВНІ ЗАВДАННЯ:
1. Проаналізувати опис проблеми та визначити ймовірну причину
2. Запропонувати кроки для діагностики та вирішення
3. Визначити, чи потрібна додаткова інформація від користувача
4. Оцінити правильність встановленого пріоритету
5. Запропонувати категорію/підкатегорію, якщо не вказано
6. Надати рекомендації щодо призначення відповідального (якщо не призначено)
7. 🎓 ВРАХУВАТИ ІСТОРИЧНІ ДАНІ (якщо є) для точного прогнозу SLA

ФОРМАТ ВІДПОВІДІ (JSON):
{
  "summary": "Короткий опис проблеми та її суть",
  "rootCause": "Ймовірна причина проблеми",
  "diagnosticSteps": ["Крок 1", "Крок 2", "Крок 3"],
  "solutionSteps": ["Рішення 1", "Рішення 2"],
  "requiredInfo": ["Яка інформація потрібна від користувача"],
  "priorityAssessment": {
    "current": "low|medium|high|urgent",
    "recommended": "low|medium|high|urgent",
    "reason": "Чому рекомендовано змінити пріоритет"
  },
  "categoryRecommendation": {
    "category": "Hardware|Software|Network|Access|Other",
    "subcategory": "Конкретна підкатегорія",
    "reason": "Чому ця категорія"
  },
  "assignmentRecommendation": {
    "shouldAssign": true|false,
    "reason": "Чому потрібно/не потрібно призначати"
  },
  "slaRecommendation": {
    "hours": 24,
    "reason": "ОБОВ'ЯЗКОВО вкажіть: 1) Чи використали історичні дані (якщо є) 2) Яка складність 3) Який пріоритет 4) Обгрунтування. Приклад: 'На основі 15 подібних тікетів (середній час 2.5 год) + середня складність + пріоритет medium → SLA 4 години'",
    "basedOnHistory": true|false,
    "confidence": "high|medium|low"
  },
  "estimatedComplexity": "low|medium|high",
  "estimatedTime": "Оцінка часу на вирішення",
  "relatedIssues": ["Можливі пов'язані проблеми"],
  "preventiveMeasures": ["Заходи для запобігання подібним проблемам"]
}

ВАЖЛИВО:
- Будьте конкретними та практичними
- Використовуйте технічну термінологію, але зрозумілу
- Якщо інформації недостатньо, вкажіть це
- Не вигадуйте проблеми, яких немає в описі
- МОВА: Відповідайте українською мовою

КРИТЕРІЇ ОЦІНКИ СКЛАДНОСТІ (на основі реальних даних індустрії):

════════════════════════════════════════════════════════════════════════════
🟢 LOW (Низька складність) - L1 Support | РЕАЛЬНИЙ ДОСВІД СИСАДМІНІВ
════════════════════════════════════════════════════════════════════════════
📊 БЕНЧМАРК: 15-60 хв чистої роботи | SLA: 4-8 год (враховує чергу, переключення)

⚠️ РЕАЛЬНІСТЬ: Чистий час виконання ≠ SLA час
   - Якщо сисадмін вільний зараз: 15-30 хв
   - Якщо є черга з 5-10 тікетів: +2-4 год очікування
   - Якщо сисадмін на зустрічі: +1-2 год
   - Якщо обідня перерва: +1 год
   
💡 ПРАВИЛО: LOW завдання = 1 год ЧИСТОЇ роботи максимум

┌─────────────────────────────────────────────────────────────────────────┐
│ ✓ Скидання пароля / розблокування акаунта Active Directory             │
│   └─ Чиста робота: 5-10 хвилин (знайти користувача в AD, розблокувати)│
│   └─ SLA реалістично: 2-4 години (якщо ви не єдиний запит)            │
│   └─ urgent = 1 год, high = 2 год, medium = 4 год, low = 24 год       │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│ ✓ Принтер не друкує (застряг папір, закінчився тонер)                 │
│   └─ Чиста робота: 10-20 хв (дійти до принтера, витягнути папір)      │
│   └─ Якщо в іншому кабінеті/поверсі: +10-15 хв на дорогу              │
│   └─ SLA: medium = 4 год (час дійти + можливо інші завдання)          │
│   └─ Якщо тонер треба замовити: +24-48 год                            │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│ ✓ Додати користувача в AD групу / дати доступ до мережевої папки      │
│   └─ Чиста робота: 5-15 хв (знайти групу, додати, перевірити)         │
│   └─ БЕЗ узгодження: high = 2 год, medium = 4 год                      │
│   └─ З узгодженням керівника: +8-24 год (чекаємо підтвердження)       │
│   └─ З узгодженням безпеки/compliance: +24-48 год                     │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│ ✓ Підключити ноутбук до корпоративного WiFi                           │
│   └─ Чиста робота: 10-20 хв (ввести сертифікат/пароль, перевірити)   │
│   └─ Якщо треба дійти до користувача: +15-30 хв                       │
│   └─ SLA: medium = 4 год, low = 8 год                                 │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│ ✓ "Як зробити X в Excel/Word?" (консультація)                         │
│   └─ Чиста робота: 10-30 хв (показати, пояснити)                      │
│   └─ Дистанційно через TeamViewer/AnyDesk: 15-25 хв                   │
│   └─ Особисто: +10-20 хв на дорогу                                    │
│   └─ SLA: low = 24 год (не критично), medium = 8 год                  │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│ ✓ Замінити мишку/клавіатуру (несправна)                               │
│   └─ Чиста робота: 5-10 хв (витягнути зі складу, підключити)          │
│   └─ Якщо є на складі: medium = 4 год                                 │
│   └─ Якщо треба привезти з іншого офісу: +4-8 год                     │
│   └─ Якщо треба купити: +24-48 год (заявка→бухгалтерія→закупівля)    │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│ ✓ Налаштувати підпис в Outlook                                         │
│   └─ Чиста робота: 5-10 хв (створити підпис, вставити лого)           │
│   └─ SLA: low = 24 год, medium = 8 год                                │
└─────────────────────────────────────────────────────────────────────────┘

════════════════════════════════════════════════════════════════════════════
🟡 MEDIUM (Середня складність) - L2 Support | РЕАЛЬНИЙ ДОСВІД
════════════════════════════════════════════════════════════════════════════
📊 БЕНЧМАРК: 1-6 год чистої роботи | SLA: 8-48 год (з урахуванням реальності)

⚠️ РЕАЛЬНІСТЬ: 
   - Діагностика часто займає 50% часу
   - Гуглити рішення: +30-60 хв
   - Перезавантаження, очікування оновлень: +30-90 хв
   - Якщо проблема незнайома: ×1.5-2 до часу
   
💡 ПРАВИЛО: MEDIUM = від 1 до 6 годин ЧИСТОЇ роботи

┌─────────────────────────────────────────────────────────────────────────┐
│ ✓ "Комп'ютер гальмує" (повільний ПК)                                  │
│   └─ Діагностика: 30-60 хв (Task Manager, диски, RAM, автозагрузка)   │
│   └─ Очистка: 30-60 хв (видалити сміття, дефрагментація SSD не треба) │
│   └─ Оптимізація: 30-60 хв (відключити непотрібне, оновити драйвери)  │
│   └─ ЧИСТА РОБОТА: 2-3 години                                          │
│   └─ SLA: medium = 12 год (може знадобитися час на діагностику)       │
│   └─ Якщо треба переустанавливати Windows: це вже HIGH = 24-48 год    │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│ ✓ Встановити Microsoft Office / Adobe Acrobat                         │
│   └─ Завантаження: 15-30 хв (залежить від інтернету)                  │
│   └─ Встановлення: 20-40 хв (автоматична інсталяція)                  │
│   └─ Налаштування: 15-30 хв (активація, базові налаштування)          │
│   └─ ЧИСТА РОБОТА: 1-1.5 години                                        │
│   └─ SLA: medium = 12 год, low = 24 год (якщо не горить)              │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│ ✓ Встановити 1С:Підприємство / M.E.Doc / складне бухгалтерське ПЗ     │
│   └─ Завантаження + встановлення: 1-2 год                             │
│   └─ Налаштування БД, підключення: 1-2 год                            │
│   └─ Тестування + навчання користувача: 1-2 год                       │
│   └─ ЧИСТА РОБОТА: 3-6 годин                                           │
│   └─ SLA: medium = 24 год (складне ПЗ), high = 12 год якщо критично   │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│ ✓ "Немає інтернету на моєму комп'ютері" (інші працюють)               │
│   └─ Діагностика: 20-40 хв (ipconfig, ping, tracert, драйвери мережі) │
│   └─ Пошук рішення: 30-60 хв (гугл, переустановка драйвера, кабель)   │
│   └─ Вирішення: 30-90 хв (залежно від причини)                        │
│   └─ ЧИСТА РОБОТА: 1.5-3 години                                        │
│   └─ SLA: high = 8 год (критично для роботи), medium = 12 год         │
│   └─ Якщо проблема в провайдері/роутері офісу: це вже HIGH + urgent   │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│ ✓ Налаштувати принтер в мережі (щоб всі бачили)                       │
│   └─ Налаштування принтера: 30-45 хв (статичний IP, спільний доступ)  │
│   └─ Встановлення на ПК користувачів: 15-20 хв на ПК × N комп'ютерів  │
│   └─ Тестування: 15-30 хв                                              │
│   └─ ЧИСТА РОБОТА: 1-3 години (залежно від кількості ПК)              │
│   └─ SLA: medium = 12 год, low = 24 год                               │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│ ✓ Outlook не відправляє пошту / проблеми з поштою                     │
│   └─ Діагностика: 30-60 хв (перевірка налаштувань, логи, тест)        │
│   └─ Пошук проблеми: 30-90 хв (SMTP, порти, SSL, пароль, антивірус)   │
│   └─ Вирішення: 30-60 хв (виправити налаштування, пересоздати профіль)│
│   └─ ЧИСТА РОБОТА: 1.5-3.5 години                                      │
│   └─ SLA: high = 8 год (пошта критична), medium = 12 год              │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│ ✓ Відновити файли з backup (випадково видалені)                       │
│   └─ Знайти backup: 15-30 хв (перевірити дату, наявність файлів)      │
│   └─ Відновлення малих файлів (до 1GB): 30-60 хв                      │
│   └─ Відновлення великих файлів (10-100GB): 2-8 годин                 │
│   └─ ЧИСТА РОБОТА: 1-9 годин (залежить від розміру)                   │
│   └─ SLA: high = 12 год (малі), medium = 24 год (великі)              │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│ ✓ Налаштувати VPN для віддаленої роботи (OpenVPN, WireGuard)          │
│   └─ Створення конфігурації: 20-40 хв                                 │
│   └─ Встановлення клієнта на ПК: 20-30 хв                             │
│   └─ Налаштування + тестування: 30-60 хв                              │
│   └─ Інструктаж користувача: 15-30 хв                                 │
│   └─ ЧИСТА РОБОТА: 1.5-2.5 години                                      │
│   └─ SLA: high = 12 год (якщо віддалений працівник), medium = 24 год  │
└─────────────────────────────────────────────────────────────────────────┘

════════════════════════════════════════════════════════════════════════════
🔴 HIGH (Висока складність) - L3 / Senior SysAdmin | РЕАЛЬНИЙ ДОСВІД
════════════════════════════════════════════════════════════════════════════
📊 БЕНЧМАРК: 4-24+ год чистої роботи | SLA: 24-120 год (може розтягтися на дні)

⚠️ РЕАЛЬНІСТЬ:
   - Діагностика може зайняти 50-70% часу
   - Очікування запчастин/постачальників: +24-72 год
   - Backup перед втручанням: +1-3 год
   - Тестування після: +2-4 год
   - Документація: +1-2 год
   
💡 ПРАВИЛО: HIGH = більше 6 годин роботи АБО потрібні запчастини/постачальники

┌─────────────────────────────────────────────────────────────────────────┐
│ ✓ "Комп'ютер не вмикається" (чорний екран, не стартує)                │
│   └─ Діагностика: 1-3 год (тестування: БЖ, RAM, мат.плата, HDD, CPU)  │
│   └─ Ремонт/заміна: 2-4 год (залежно що зламалось)                    │
│   └─ Переустановка Windows (якщо зміна HDD/SSD): +4-6 год             │
│   └─ ЧИСТА РОБОТА: 3-13 годин                                          │
│   └─ SLA: urgent = 8 год (якщо є запчастини), high = 24 год           │
│   └─ Якщо треба замовити запчастини: +24-72 год очікування            │
│   └─ Якщо на гарантії (треба везти в СЦ): +72-168 год                 │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│ ✓ Переустановити Windows з нуля (чистий install)                      │
│   └─ Backup даних користувача: 30-120 хв (залежно від обсягу)         │
│   └─ Переустановка Windows: 40-90 хв (залежно від HDD/SSD)            │
│   └─ Оновлення Windows: 60-180 хв (сотні апдейтів, перезавантаження)  │
│   └─ Драйвери: 30-60 хв (чіпсет, відео, мережа, звук тощо)            │
│   └─ Встановлення ПЗ: 60-180 хв (Office, 1С, браузери, PDF тощо)      │
│   └─ Налаштування + перенос даних: 60-120 хв                          │
│   └─ ЧИСТА РОБОТА: 5-12 годин (це РЕАЛЬНО довго!)                     │
│   └─ SLA: medium = 48 год, high = 24 год (якщо критично)              │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│ ✓ "Сервер не відповідає" / "1С не працює" (P1 Incident!)              │
│   └─ ТЕРМІНОВА РЕАКЦІЯ: 15-30 хв (дістатися до серверної)             │
│   └─ Діагностика: 30-120 хв (логи, монітори, мережа, диски, процеси)  │
│   └─ Вирішення: 1-8 годин (залежить від проблеми)                     │
│   └─ Варіанти: перезавантаження (15 хв), відновлення служби (30 хв),  │
│        відновлення з backup (2-6 год), заміна заліза (4-12 год)       │
│   └─ ЧИСТА РОБОТА: 2-12+ годин                                         │
│   └─ SLA: urgent = 4-8 год (весь офіс стоїть!)                        │
│   └─ За ITIL P1: відповідь протягом 1 години, цільове вирішення 4-8 год│
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│ ✓ Заміна HDD на SSD + клонування системи                              │
│   └─ Backup: 30-60 хв (на всяк випадок)                               │
│   └─ Клонування: 1-4 год (залежить від розміру даних)                 │
│   └─ Фізична заміна: 20-40 хв (розібрати ноут/ПК, замінити, зібрати)  │
│   └─ Тестування: 30-60 хв (завантаження, перевірка всього)            │
│   └─ ЧИСТА РОБОТА: 2.5-6 годин                                         │
│   └─ SLA: medium = 24 год, low = 48 год (не термінове покращення)     │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│ ✓ "Вірус на комп'ютері" / Ransomware / Malware                        │
│   └─ Ізоляція від мережі: 5-10 хв (НЕГАЙНО!)                          │
│   └─ Діагностика: 30-90 хв (сканування, аналіз процесів)              │
│   └─ Видалення: 1-3 год (антивіруси, ручне видалення)                 │
│   └─ Перевірка: 60-120 хв (глибоке сканування)                        │
│   └─ Якщо не вдається видалити: переустановка Windows (+6-10 год)     │
│   └─ Ransomware: можливо НЕМОЖЛИВО відновити → backup (+2-8 год)      │
│   └─ ЧИСТА РОБОТА: 3-15 годин                                          │
│   └─ SLA: urgent = 8 год (розповсюджується!), high = 12 год           │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│ ✓ "Немає інтернету В УСЬОМУ ОФІСІ" (роутер, комутатор, провайдер)     │
│   └─ Діагностика: 30-90 хв (пінг провайдера, роутер, комутатор, кабелі)│
│   └─ Якщо проблема в роутері/комутаторі: 1-4 год (налаштування/заміна)│
│   └─ Якщо проблема у провайдера: 4-48 годин (ЧЕКАЄМО їх!)             │
│   └─ Якщо зламався роутер і треба новий: +4-24 год (купити/привезти)  │
│   └─ ЧИСТА РОБОТА: 2-6 годин (без провайдера)                         │
│   └─ SLA: urgent = 8 год, але РЕАЛЬНО залежить від провайдера         │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│ ✓ Налаштувати новий Windows Server / Linux Server                     │
│   └─ Встановлення ОС: 1-2 год                                          │
│   └─ Налаштування AD/DNS/DHCP: 2-4 год                                │
│   └─ Налаштування мережі, firewall: 1-3 год                           │
│   └─ Встановлення ролей (File Server, Print Server): 2-4 год          │
│   └─ Налаштування backup: 1-2 год                                     │
│   └─ Тестування: 2-4 год                                               │
│   └─ Документація: 1-2 год                                             │
│   └─ ЧИСТА РОБОТА: 10-21 година (декілька днів!)                      │
│   └─ SLA: low = 120 год (5 днів, можна робити поступово)              │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│ ✓ База даних SQL не працює / пошкоджена                               │
│   └─ Діагностика: 1-3 год (логи, статус, цілісність)                  │
│   └─ Спроба відновлення: 2-6 годин                                     │
│   └─ Відновлення з backup: 2-8 годин (залежно від розміру БД)         │
│   └─ ЧИСТА РОБОТА: 5-17 годин                                          │
│   └─ SLA: urgent = 8 год (критична БД), high = 24 год                 │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│ ✓ Міграція поштового серверу / файлового серверу                      │
│   └─ Підготовка нового серверу: 4-8 год                               │
│   └─ Копіювання даних: 4-24 год (залежить від ТБ)                     │
│   └─ Налаштування + тестування: 4-8 год                               │
│   └─ Переключення користувачів: 2-4 год                               │
│   └─ ЧИСТА РОБОТА: 14-44 години (робиться НА ВИХІДНИХ!)               │
│   └─ SLA: low = 120-168 год (планується заздалегідь)                  │
└─────────────────────────────────────────────────────────────────────────┘

════════════════════════════════════════════════════════════════════════════
📊 ТАБЛИЦЯ SLA (на основі ITIL та індустрійних бенчмарків)
════════════════════════════════════════════════════════════════════════════

ПРАВИЛА:
✓ Повертайте ТІЛЬКИ конкретне число годин (ціле або дробове), НЕ діапазон
✓ Приклади ПРАВИЛЬНО: "hours": 1, "hours": 2, "hours": 0.5, "hours": 24
✗ Приклади НЕПРАВИЛЬНО: "hours": "30 хвилин - 1 година"

ФОРМУЛА: Складність × Пріоритет = SLA (години)

┌──────────┬────────────┬────────────┬────────────┐
│ Пріоритет│ LOW сложн. │ MEDIUM     │ HIGH       │
├──────────┼────────────┼────────────┼────────────┤
│ urgent   │ 1 год      │ 4 год      │ 8 год      │
│ high     │ 4 год      │ 12 год     │ 24 год     │
│ medium   │ 8 год      │ 24 год     │ 48 год     │
│ low      │ 48 год     │ 72 год     │ 120 год    │
└──────────┴────────────┴────────────┴────────────┘

════════════════════════════════════════════════════════════════════════════
💡 ПРИКЛАДИ РЕАЛЬНИХ РОЗРАХУНКІВ (копіюйте цю логіку!)
════════════════════════════════════════════════════════════════════════════

🔹 "Забув пароль"
   Складність: LOW (скидання пароля - 15-30 хв за бенчмарком)
   Пріоритет: low → SLA: 48 год
   Якщо urgent: 1 год

🔹 "Не працює принтер" (застряг папір)
   Складність: LOW (заміна паперу - 20-45 хв)
   Пріоритет: medium → SLA: 8 год

🔹 "Принтер не друкує в мережі"
   Складність: MEDIUM (налаштування мережі - 1-2 год)
   Пріоритет: medium → SLA: 24 год

🔹 "Повільний комп'ютер"
   Складність: MEDIUM (діагностика + оптимізація - 1-2 год)
   Пріоритет: medium → SLA: 24 год
   Якщо потрібна переустановка Windows: HIGH складність → 48 год

🔹 "Проблеми з інтернетом" (немає з'єднання)
   Складність: MEDIUM (діагностика 30-60 хв + вирішення 2-4 год)
   Пріоритет: high → SLA: 12 год
   Якщо залучений провайдер: +24 год = 36 год

🔹 "Комп'ютер не вмикається"
   Складність: HIGH (діагностика 1-2 год + можлива заміна заліза)
   Пріоритет: urgent → SLA: 8 год
   Якщо є запчастини на складі: можна 4-6 год

🔹 "Потрібно встановити 1С"
   Складність: MEDIUM (складне ПЗ - 3-6 год за бенчмарком)
   Пріоритет: low → SLA: 72 год

🔹 "Віруси на комп'ютері"
   Складність: HIGH (базове видалення 2-4 год, повне відновлення 8-24 год)
   Пріоритет: high → SLA: 24 год
   Пріоритет: urgent → SLA: 8 год

🔹 "Налаштувати WiFi"
   Складність: LOW (підключення - 20-40 хв)
   Пріоритет: medium → SLA: 8 год

🔹 "Сервер не відповідає"
   Складність: HIGH (критична інфраструктура, P1 incident)
   Пріоритет: urgent → SLA: 8 год
   За ITIL для P1: відповідь протягом 1 години

🔹 "Потрібен доступ до папки"
   Складність: LOW (надання доступу - 15-30 хв)
   Пріоритет: high → SLA: 4 год
   Якщо потрібне узгодження керівника: +24 год = 28 год

🔹 "Потрібна нова мишка"
   Складність: LOW (заміна - 20-30 хв)
   Пріоритет: medium → SLA: 8 год
   Якщо потрібна доставка з іншого офісу: +4-8 год = 12-16 год

🔹 "Налаштувати пошту в Outlook"
   Складність: LOW (базове налаштування - 20-40 хв)
   Пріоритет: medium → SLA: 8 год
   Якщо складні проблеми IMAP/SMTP: MEDIUM → 24 год

════════════════════════════════════════════════════════════════════════════
🇺🇦 УКРАЇНСЬКІ РЕАЛІЇ ТА ОСОБЛИВІ ВИПАДКИ
════════════════════════════════════════════════════════════════════════════

┌─────────────────────────────────────────────────────────────────────────┐
│ ⚡ "Відключили світло" (без UPS/генератора)                            │
│   └─ Вирішення: ЧЕКАЄМО поки дадуть світло                            │
│   └─ SLA: не застосовується (форс-мажор)                              │
│   └─ Якщо є UPS: потрібно правильно вимкнути сервери (30-60 хв)       │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│ ⚡ Після повернення світла сервер не запустився                        │
│   └─ HIGH complexity, urgent = 8 год                                   │
│   └─ Перевірка обладнання + діагностика: 1-3 год                      │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│ 💰 "Потрібно узгодити закупівлю з бухгалтерією"                       │
│   └─ +24-48 год до будь-якого SLA (якщо треба щось купити)            │
│   └─ В кінці місяця/кварталу: може затягтися до +72-120 год           │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│ 📦 "Доставка Новою Поштою з Києва"                                     │
│   └─ По Україні: +24-48 год                                            │
│   └─ В обласний центр: +24 год                                         │
│   └─ В село: +48-72 год                                                │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│ 🏢 "Сисадмін їде в інший офіс/філію"                                  │
│   └─ В межах міста: +1-2 год на дорогу туди-назад                     │
│   └─ В інше місто: +4-8 год (дорога + робота)                         │
│   └─ Додати до SLA час на дорогу!                                     │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│ 🔧 "Старе обладнання" (ПК 2010-2015 років)                            │
│   └─ Все працює ПОВІЛЬНІШЕ: ×1.5-2 до базового часу                   │
│   └─ Встановлення Windows: може зайняти 8-10 годин замість 4-6        │
│   └─ Оновлення Windows: може "висіти" годинами                        │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│ 🌐 "Провайдер не відповідає" (Укртелеком, Київстар тощо)              │
│   └─ Заявка в підтримку провайдера: відповідь через 2-4 год           │
│   └─ Виїзд техніка провайдера: +24-48 год (якщо не SLA з ними)        │
│   └─ Вихідні: провайдер може не працювати (+72 год)                   │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│ 📝 М.Е.Doc, ЄЦП, Приват24 для бухгалтерії                             │
│   └─ MEDIUM complexity, high = 12 год (специфічне українське ПЗ)      │
│   └─ Проблеми з ключами ЄЦП: може зайняти ДЕНЬ (проблеми з АЦСК)      │
│   └─ Якщо треба їхати в АЦСК: +4-8 год                                │
└─────────────────────────────────────────────────────────────────────────┘

════════════════════════════════════════════════════════════════════════════
📚 РОЗШИРЕНА БАЗА ПРИКЛАДІВ (додаткові 72 сценарії)
════════════════════════════════════════════════════════════════════════════

┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ 🟢 КАТЕГОРІЯ: ОБЛІКОВІ ЗАПИСИ ТА ДОСТУП (LOW complexity)              ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
1️⃣  "Забув пароль від Windows"
    LOW + low = 48 год | LOW + high = 4 год | LOW + urgent = 1 год

2️⃣  "Не можу зайти в систему (акаунт заблокований)"
    LOW + high = 4 год | LOW + urgent = 1 год

3️⃣  "Потрібен доступ до спільної папки на сервері"
    LOW + high = 4 год | Якщо потрібне узгодження: +24 год = 28 год

4️⃣  "Не працює Active Directory автентифікація"
    MEDIUM + urgent = 4 год (проблема на стороні сервера)

5️⃣  "Створити новий email акаунт для співробітника"
    LOW + medium = 8 год

6️⃣  "Змінити права доступу до CRM системи"
    LOW + medium = 8 год | Якщо адміністратор CRM зайнятий: +4 год

7️⃣  "Відновити доступ до 1С після звільнення і повернення"
    LOW + high = 4 год

8️⃣  "Налаштувати VPN для віддаленої роботи"
    MEDIUM + high = 12 год (перше налаштування + інструктаж)

9️⃣  "Не працює двофакторна автентифікація"
    LOW + high = 4 год

🔟 "Потрібен доступ до принтера в мережі"
    LOW + medium = 8 год

┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ 🖨️ КАТЕГОРІЯ: ПРИНТЕРИ (LOW-MEDIUM complexity)                        ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
1️⃣1️⃣ "Принтер не друкує (застряг папір)"
    LOW + medium = 8 год

1️⃣2️⃣ "Принтер друкує блідо (потрібен тонер)"
    LOW + low = 48 год | Якщо термінова потреба: medium = 8 год

1️⃣3️⃣ "Принтер не видно в мережі"
    MEDIUM + high = 12 год (налаштування мережі)

1️⃣4️⃣ "Підключити новий принтер до комп'ютера"
    LOW + medium = 8 год

1️⃣5️⃣ "Налаштувати сканування на email"
    MEDIUM + medium = 24 год (налаштування SMTP на принтері)

1️⃣6️⃣ "Принтер друкує смугами (проблема з друкуючою головкою)"
    LOW + medium = 8 год (чистка, калібрування)

1️⃣7️⃣ "Встановити драйвер принтера на всі комп'ютери відділу"
    MEDIUM + low = 72 год (масове встановлення, можна автоматизувати)

┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ 🌐 КАТЕГОРІЯ: ІНТЕРНЕТ ТА МЕРЕЖА (MEDIUM-HIGH complexity)             ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
1️⃣8️⃣ "Немає інтернету на комп'ютері (інші працюють)"
    MEDIUM + high = 12 год

1️⃣9️⃣ "Немає інтернету в усьому офісі"
    HIGH + urgent = 8 год | Якщо проблема у провайдера: +24-48 год

2️⃣0️⃣ "Повільний інтернет (низька швидкість)"
    MEDIUM + high = 12 год (діагностика, провайдер)

2️⃣1️⃣ "Не працює WiFi"
    MEDIUM + high = 12 год | Якщо роутер зламався: HIGH = 24 год

2️⃣2️⃣ "Не можу підключитися до WiFi (інші підключаються)"
    LOW + medium = 8 год (проблема з пристроєм)

2️⃣3️⃣ "Потрібно розширити WiFi покриття в офісі"
    HIGH + low = 120 год (встановлення обладнання, налаштування)

2️⃣4️⃣ "Налаштувати статичний IP адрес"
    LOW + medium = 8 год

2️⃣5️⃣ "Проблеми з VPN (не підключається)"
    MEDIUM + high = 12 год

2️⃣6️⃣ "Налаштувати мережеві папки для відділу"
    MEDIUM + medium = 24 год

2️⃣7️⃣ "Роутер постійно перезавантажується"
    HIGH + urgent = 8 год (заміна обладнання)

┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ 💻 КАТЕГОРІЯ: КОМП'ЮТЕРИ ТА НОУТБУКИ (MEDIUM-HIGH complexity)         ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
2️⃣8️⃣ "Комп'ютер працює повільно"
    MEDIUM + medium = 24 год | Якщо потрібна переустановка: HIGH = 48 год

2️⃣9️⃣ "Комп'ютер не вмикається"
    HIGH + urgent = 8 год | Якщо потрібна заміна заліза: +24-72 год

3️⃣0️⃣ "Синій екран смерті (BSOD)"
    HIGH + urgent = 8 год (діагностика + можлива переустановка)

3️⃣1️⃣ "Комп'ютер зависає"
    MEDIUM + high = 12 год (діагностика, оптимізація)

3️⃣2️⃣ "Не працює звук"
    LOW + medium = 8 год (драйвери, налаштування)

3️⃣3️⃣ "Не працює веб-камера"
    LOW + medium = 8 год

3️⃣4️⃣ "Потрібно більше оперативної пам'яті (upgrade RAM)"
    MEDIUM + low = 72 год | Якщо є на складі: medium = 24 год

3️⃣5️⃣ "Замінити жорсткий диск на SSD"
    HIGH + medium = 48 год (заміна + клонування/переустановка + налаштування)

3️⃣6️⃣ "Ноутбук не заряджається"
    MEDIUM + high = 12 год | Якщо потрібна заміна блоку живлення: +4-8 год

3️⃣7️⃣ "Розбився екран ноутбука"
    HIGH + high = 24 год | Якщо потрібне замовлення екрану: +72-168 год

3️⃣8️⃣ "Клавіатура ноутбука не працює (декілька клавіш)"
    MEDIUM + high = 12 год | Заміна клавіатури: HIGH + 24-48 год

3️⃣9️⃣ "Перегрівається ноутбук"
    MEDIUM + medium = 24 год (чистка, заміна термопасти)

4️⃣0️⃣ "Потрібен новий комп'ютер (старий не відповідає вимогам)"
    HIGH + low = 120 год (узгодження, закупівля, налаштування)

┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ 📦 КАТЕГОРІЯ: ПРОГРАМНЕ ЗАБЕЗПЕЧЕННЯ (LOW-HIGH complexity)            ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
4️⃣1️⃣ "Встановити Microsoft Office"
    MEDIUM + medium = 24 год

4️⃣2️⃣ "Встановити Adobe Photoshop"
    MEDIUM + medium = 24 год

4️⃣3️⃣ "Встановити 1С:Підприємство"
    HIGH + medium = 48 год (складне ПЗ + налаштування + навчання)

4️⃣4️⃣ "Оновити Windows (критичне оновлення безпеки)"
    MEDIUM + urgent = 4 год

4️⃣5️⃣ "Програма вилітає/крашиться"
    MEDIUM + high = 12 год (діагностика, переустановка)

4️⃣6️⃣ "Не відкриваються файли Excel"
    LOW + high = 4 год (асоціації файлів, відновлення Office)

4️⃣7️⃣ "Переустановити Windows"
    HIGH + medium = 48 год (4-8 год робота + налаштування + встановлення ПЗ)

4️⃣8️⃣ "Налаштувати антивірус для всього відділу"
    MEDIUM + medium = 24 год

4️⃣9️⃣ "Ліцензія програми закінчилася"
    LOW + high = 4 год | Якщо потрібна закупівля: +24-72 год

5️⃣0️⃣ "Як користуватися Excel (навчання)"
    LOW + low = 48 год | Якщо urgent: 1 год (швидка консультація)

┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ 🦠 КАТЕГОРІЯ: БЕЗПЕКА ТА ВІРУСИ (HIGH complexity)                     ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
5️⃣1️⃣ "Комп'ютер заражений вірусом"
    HIGH + urgent = 8 год (ізоляція + видалення + перевірка)

5️⃣2️⃣ "Підозра на шкідливе ПЗ"
    MEDIUM + high = 12 год (сканування, аналіз)

5️⃣3️⃣ "Ransomware атака (файли зашифровані)"
    HIGH + urgent = 8 год | Відновлення: може до 72 год

5️⃣4️⃣ "Антивірус виявив загрозу"
    MEDIUM + high = 12 год

5️⃣5️⃣ "Фішинговий email (клікнув на посилання)"
    HIGH + urgent = 8 год (зміна паролів, перевірка системи)

┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ 🖱️ КАТЕГОРІЯ: ПЕРИФЕРІЯ (LOW complexity)                              ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
5️⃣6️⃣ "Не працює мишка"
    LOW + medium = 8 год | Якщо є на складі: можна 1-2 год

5️⃣7️⃣ "Клавіатура не працює"
    LOW + high = 4 год

5️⃣8️⃣ "Потрібна нова гарнітура (навушники + мікрофон)"
    LOW + medium = 8 год | Якщо треба замовити: +24-48 год

5️⃣9️⃣ "Монітор не показує зображення"
    MEDIUM + high = 12 год (кабель/відеокарта/монітор)

6️⃣0️⃣ "Потрібен другий монітор"
    LOW + low = 48 год | Якщо є на складі + urgent: 4 год

┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ 🗄️ КАТЕГОРІЯ: СЕРВЕРИ ТА ІНФРАСТРУКТУРА (HIGH complexity)            ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
6️⃣1️⃣ "Сервер не відповідає"
    HIGH + urgent = 8 год (P1 incident за ITIL)

6️⃣2️⃣ "База даних недоступна"
    HIGH + urgent = 8 год

6️⃣3️⃣ "Налаштувати новий сервер"
    HIGH + low = 120 год (встановлення, налаштування, тестування)

6️⃣4️⃣ "Backup не працює"
    HIGH + urgent = 8 год (критично для безпеки даних)

6️⃣5️⃣ "Потрібно відновити файли з backup"
    MEDIUM + high = 12 год | Великі обсяги: HIGH = 24 год

6️⃣6️⃣ "Налаштувати RAID масив"
    HIGH + medium = 48 год

6️⃣7️⃣ "Диск сервера майже повний"
    HIGH + urgent = 8 год (очистка + можлива розширення)

┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ 📧 КАТЕГОРІЯ: EMAIL (LOW-MEDIUM complexity)                            ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
6️⃣8️⃣ "Не приходять листи"
    MEDIUM + high = 12 год (перевірка налаштувань, спам фільтрів)

6️⃣9️⃣ "Не можу відправити email з вкладенням"
    LOW + medium = 8 год (ліміт розміру, налаштування)

7️⃣0️⃣ "Листи потрапляють в спам"
    MEDIUM + high = 12 год (SPF, DKIM, DMARC налаштування)

7️⃣1️⃣ "Налаштувати підпис в Outlook"
    LOW + low = 48 год | Якщо потрібно терміново: 4 год

7️⃣2️⃣ "Скринька переповнена"
    LOW + medium = 8 год (очистка, архівування)

════════════════════════════════════════════════════════════════════════════
⚠️ КОРИГУВАЛЬНІ ФАКТОРИ
════════════════════════════════════════════════════════════════════════════
+ Доставка обладнання з іншого офісу/складу: +4-8 годин
+ Узгодження з керівництвом/третьою стороною: +24 години
+ Очікування запчастин від постачальника: +24-72 години
+ Залучення зовнішнього провайдера (інтернет, телеком): +24-48 годин
+ Проблема неясна, потрібна глибока діагностика: ×1.5 до базового SLA
+ Проста проблема з відомим рішенням: можна зменшити SLA на 25-50%

════════════════════════════════════════════════════════════════════════════
🎯 АЛГОРИТМ ВИЗНАЧЕННЯ SLA (З НАВЧАННЯМ!)
════════════════════════════════════════════════════════════════════════════
1. ✅ СПОЧАТКУ перевірте ІСТОРИЧНІ ДАНІ (якщо є в промпті вище)
   - Якщо є дані про ${learningData.basedOn?.similarTickets || 0}+ подібних тікетів → використайте їх!
   - Рекомендоване SLA з історії: ${learningData.recommendedHours || 'немає'} год
   - Впевненість: ${learningData.confidence || 0}%
   - Якщо впевненість >70% → використайте рекомендоване SLA
   - Якщо впевненість 40-70% → порівняйте з таблицею, виберіть ближче
   - Якщо впевненість <40% → використайте стандартну таблицю

2. Якщо НЕМАЄ історичних даних → використовуйте стандартний алгоритм:
   a) Прочитайте опис проблеми
   b) Визначте ТИП проблеми (пароль/принтер/мережа/обладнання/ПЗ/сервер)
   c) Знайдіть ПОДІБНИЙ ПРИКЛАД вище
   d) Визначте СКЛАДНІСТЬ (LOW/MEDIUM/HIGH) на основі бенчмарків
   e) Врахуйте ПРІОРИТЕТ з тікета
   f) Використайте ТАБЛИЦЮ для базового SLA
   g) Застосуйте КОРИГУВАЛЬНІ ФАКТОРИ якщо потрібно

3. Поверніть КОНКРЕТНЕ ЧИСЛО годин

💡 КЛЮЧОВЕ: Історичні дані = РЕАЛЬНИЙ досвід, а не теорія! Довіряйте їм більше ніж таблиці!
`;

      // Формуємо контекст тікета
      const ticketContext = `
АНАЛІЗ ЗАЯВКИ:

Заголовок: ${ticket.title || 'Не вказано'}
Опис: ${ticket.description || 'Не вказано'}
Статус: ${ticket.status || 'Не вказано'}
Пріоритет: ${ticket.priority || 'Не вказано'}
Тип: ${ticket.type || 'Не вказано'}
Категорія: ${ticket.subcategory || 'Не вказано'}
Створено: ${ticket.createdAt ? new Date(ticket.createdAt).toLocaleString('uk-UA') : 'Не вказано'}
${ticket.dueDate ? `Термін виконання: ${new Date(ticket.dueDate).toLocaleString('uk-UA')}` : ''}
${ticket.createdBy ? `Автор: ${ticket.createdBy.firstName || ''} ${ticket.createdBy.lastName || ''}` : ''}
${ticket.city ? `Місто: ${ticket.city.name || ''}` : ''}

${ticket.comments && ticket.comments.length > 0 ? `
КОМЕНТАРІ (${ticket.comments.length}):
${ticket.comments.map((c, i) => `${i + 1}. ${c.content} (${c.author?.firstName || 'Невідомо'} ${c.author?.lastName || ''}, ${new Date(c.createdAt).toLocaleString('uk-UA')})`).join('\n')}
` : ''}

${ticket.history && ticket.history.length > 0 ? `
ІСТОРІЯ ЗМІН:
${ticket.history.slice(-5).map(h => `- ${h.action}: ${h.changes || ''} (${new Date(h.timestamp).toLocaleString('uk-UA')})`).join('\n')}
` : ''}
`;

      const chatCompletion = await this.client.chat.completions.create({
        messages: [
          { role: 'system', content: systemPrompt },
          { role: 'user', content: ticketContext }
        ],
        model: this.settings.groqModel || 'llama-3.3-70b-versatile',
        temperature: 0.3, // Низька температура для більш точного аналізу
        max_tokens: 2048,
        response_format: { type: 'json_object' }
      });

      const responseText = chatCompletion.choices[0]?.message?.content;
      if (!responseText) {
        logger.warn('Groq повернув порожню відповідь при аналізі тікета');
        return null;
      }

      // Трекінг використання API
      await this.trackApiUsage(
        this.settings.groqModel || 'llama-3.3-70b-versatile',
        chatCompletion,
        { tokensUsed: chatCompletion.usage?.total_tokens || 0 }
      );

      try {
        const result = JSON.parse(responseText);
        logger.info('Результат AI аналізу тікета:', { ticketId: ticket._id || ticket.id, result });
        return result;
      } catch (parseError) {
        logger.error('Помилка парсингу JSON відповіді від Groq:', parseError);
        logger.error('Відповідь від Groq:', responseText);
        return null;
      }
    } catch (error) {
      logger.error('Помилка аналізу тікета через Groq:', error);
      logger.error('Деталі помилки:', { 
        message: error.message, 
        stack: error.stack,
        ticketId: ticket?._id || ticket?.id 
      });
      return null;
    }
  }

  /**
   * Аналізує заявки (тікети) системи та надає інсайти
   * @param {Array} tickets - Масив тікетів для аналізу
   * @param {Object} analyticsData - Дані аналітики (статистика, тренди, метрики)
   * @param {Object} context - Додатковий контекст (дата діапазон, фільтри)
   * @returns {Promise<Object>} - Результат аналізу з інсайтами та рекомендаціями
   */
  async analyzeAnalytics(tickets = [], analyticsData = {}, context = {}) {
    try {
      if (!this.client) {
        await this.initialize();
      }

      if (!this.client) {
        return null;
      }

      const systemPrompt = `
Ви - експерт-аналітик системи HelpDesk. Ваше завдання - проаналізувати ЗАЯВКИ (ТІКЕТИ) системи та надати корисні інсайти та рекомендації для покращення роботи.

ОСНОВНІ ЗАВДАННЯ:
1. Проаналізувати описи заявок та виявити типові проблеми
2. Виявити проблемні зони та тренди на основі реальних заявок
3. Оцінити якість описів заявок та коментарів
4. Виявити повторювані проблеми та патерни
5. Запропонувати конкретні рекомендації для покращення обробки заявок
6. Визначити пріоритетні напрямки для оптимізації на основі аналізу заявок
7. Виявити аномалії або незвичайні патерни в заявках

ФОРМАТ ВІДПОВІДІ (JSON):
{
  "summary": "Короткий огляд стану заявок системи на основі аналізу реальних заявок",
  "keyInsights": ["Інсайт 1", "Інсайт 2", "Інсайт 3"],
  "commonProblems": [
    {
      "title": "Назва типової проблеми",
      "description": "Опис проблеми на основі аналізу заявок",
      "frequency": "Кількість подібних заявок",
      "examples": ["Приклад заявки 1", "Приклад заявки 2"],
      "recommendation": "Рекомендація для вирішення"
    }
  ],
  "qualityAnalysis": {
    "descriptionQuality": "Оцінка якості описів заявок (good|average|poor)",
    "descriptionIssues": ["Проблеми з описами заявок"],
    "commentQuality": "Оцінка якості коментарів та рішень (good|average|poor)",
    "commentIssues": ["Проблеми з коментарями"]
  },
  "trends": {
    "positive": ["Позитивні тренди на основі заявок"],
    "negative": ["Негативні тренди на основі заявок"],
    "neutral": ["Нейтральні спостереження"]
  },
  "problems": [
    {
      "title": "Назва проблеми",
      "description": "Опис проблеми на основі аналізу заявок",
      "severity": "low|medium|high|critical",
      "impact": "Вплив на систему",
      "recommendation": "Рекомендація для вирішення"
    }
  ],
  "recommendations": [
    {
      "category": "Категорія (performance|process|resources|quality|training)",
      "title": "Назва рекомендації",
      "description": "Детальний опис на основі аналізу заявок",
      "priority": "low|medium|high",
      "expectedImpact": "Очікуваний ефект"
    }
  ],
  "metrics": {
    "performance": "Оцінка продуктивності (good|average|poor)",
    "efficiency": "Оцінка ефективності (good|average|poor)",
    "quality": "Оцінка якості заявок (good|average|poor)",
    "overall": "Загальна оцінка (good|average|poor)"
  },
  "actionItems": [
    {
      "title": "Назва дії",
      "description": "Що потрібно зробити на основі аналізу заявок",
      "priority": "low|medium|high|urgent",
      "timeline": "Оцінка часу виконання"
    }
  ],
  "predictions": [
    "Прогноз 1 на основі аналізу заявок",
    "Прогноз 2"
  ]
}

ВАЖЛИВО:
- Будьте конкретними та практичними
- Використовуйте дані для підтвердження висновків
- Надавайте дії, які можна виконати
- МОВА: Відповідайте українською мовою
- Фокусуйтеся на покращенні продуктивності та якості
`;

      // Формуємо контекст з реальними заявками
      const ticketsSample = tickets.slice(0, 50); // Аналізуємо до 50 заявок для економії токенів
      
      const ticketsContext = ticketsSample.map((ticket, index) => {
        const comments = ticket.comments && ticket.comments.length > 0 
          ? ticket.comments.slice(0, 3).map(c => `  - ${c.content?.substring(0, 200)}`).join('\n')
          : '  (немає коментарів)';
        
        return `
ЗАЯВКА #${index + 1}:
- Заголовок: ${ticket.title || 'Не вказано'}
- Опис: ${(ticket.description || 'Не вказано').substring(0, 500)}
- Статус: ${ticket.status || 'Не вказано'}
- Пріоритет: ${ticket.priority || 'Не вказано'}
- Тип: ${ticket.type || 'Не вказано'}
- Категорія: ${ticket.subcategory || 'Не вказано'}
- Місто: ${ticket.city?.name || 'Не вказано'}
- Створено: ${ticket.createdAt ? new Date(ticket.createdAt).toLocaleDateString('uk-UA') : 'Не вказано'}
- Вирішено: ${ticket.resolvedAt ? new Date(ticket.resolvedAt).toLocaleDateString('uk-UA') : 'Не вирішено'}
- Час вирішення: ${ticket.metrics?.resolutionTime ? `${Math.round(ticket.metrics.resolutionTime)} год` : 'Н/Д'}
- Коментарі (останні 3):
${comments}
`;
      }).join('\n---\n');

      const analyticsContext = `
АНАЛІЗ ЗАЯВОК (ТІКЕТІВ) СИСТЕМИ:

Період: ${context.startDate || 'Не вказано'} - ${context.endDate || 'Не вказано'}

ЗАГАЛЬНА СТАТИСТИКА:
- Всього заявок: ${analyticsData?.overview?.totalTickets || 0}
- Проаналізовано заявок: ${ticketsSample.length}
- Відкритих: ${analyticsData?.ticketsByStatus?.find(s => s._id === 'open')?.count || 0}
- В процесі: ${analyticsData?.ticketsByStatus?.find(s => s._id === 'in_progress')?.count || 0}
- Вирішених: ${analyticsData?.ticketsByStatus?.find(s => s._id === 'resolved')?.count || 0}
- Закритих: ${analyticsData?.ticketsByStatus?.find(s => s._id === 'closed')?.count || 0}

ПРІОРИТЕТИ:
- Низький: ${analyticsData?.ticketsByPriority?.find(p => p._id === 'low')?.count || 0}
- Середній: ${analyticsData?.ticketsByPriority?.find(p => p._id === 'medium')?.count || 0}
- Високий: ${analyticsData?.ticketsByPriority?.find(p => p._id === 'high')?.count || 0}

ПРОДУКТИВНІСТЬ:
- Середній час вирішення: ${analyticsData?.avgResolutionTime || 0} годин
- Коефіцієнт вирішення: ${analyticsData?.overview?.totalTickets > 0 
  ? Math.round(((analyticsData?.ticketsByStatus?.find(s => s._id === 'resolved')?.count || 0) / analyticsData.overview.totalTickets) * 100) 
  : 0}%

${ticketsContext}

ВАЖЛИВО: Проаналізуйте саме ЗАЯВКИ вище. Виявіть:
1. Типові проблеми та їх описи
2. Якість описів заявок (чи достатньо деталей)
3. Повторювані проблеми
4. Ефективність вирішення (чи є коментарі з рішеннями)
5. Патерни в заявках (які типи проблем найчастіші)
`;

      const chatCompletion = await this.client.chat.completions.create({
        messages: [
          { role: 'system', content: systemPrompt },
          { role: 'user', content: analyticsContext }
        ],
        model: this.settings.groqModel || 'llama-3.3-70b-versatile',
        temperature: 0.4, // Середня температура для балансу креативності та точності
        max_tokens: 2048,
        response_format: { type: 'json_object' }
      });

      const responseText = chatCompletion.choices[0]?.message?.content;
      if (!responseText) {
        logger.warn('Groq повернув порожню відповідь при аналізі аналітики');
        return null;
      }

      // Трекінг використання API
      await this.trackApiUsage(
        this.settings.groqModel || 'llama-3.3-70b-versatile',
        chatCompletion,
        { tokensUsed: chatCompletion.usage?.total_tokens || 0 }
      );

      const result = JSON.parse(responseText);
      logger.info('Результат AI аналізу аналітики:', { result });
      return result;
    } catch (error) {
      logger.error('Помилка аналізу аналітики через Groq:', error);
      return null;
    }
  }

  /**
   * Генерує AI звіт на основі статистики та заявок
   * @param {Array} tickets - Масив тікетів за період
   * @param {Object} analyticsData - Дані аналітики
   * @param {Object} context - Контекст (дата діапазон, тип звіту)
   * @returns {Promise<Object>} - Згенерований звіт
   */
  async generateReport(tickets = [], analyticsData = {}, context = {}) {
    try {
      if (!this.client) {
        await this.initialize();
      }

      if (!this.client) {
        return null;
      }

      const reportType = context.reportType || 'general'; // general, weekly, monthly, detailed

      const systemPrompt = `
Ви - професійний аналітик системи HelpDesk. Ваше завдання - створити детальний текстовий звіт на основі аналізу заявок та статистики.

ТИП ЗВІТУ: ${reportType === 'weekly' ? 'Тижневий звіт' : reportType === 'monthly' ? 'Місячний звіт' : reportType === 'detailed' ? 'Детальний звіт' : 'Загальний звіт'}

ФОРМАТ ЗВІТУ (текстовий, структурований):
1. ВСТУП
   - Короткий огляд періоду
   - Загальна статистика

2. ОСНОВНІ ПОКАЗНИКИ
   - Кількість заявок
   - Статистика по статусах
   - Статистика по пріоритетах
   - Продуктивність

3. АНАЛІЗ ЗАЯВОК
   - Типові проблеми
   - Найчастіші категорії
   - Тренди та патерни

4. ПРОДУКТИВНІСТЬ
   - Середній час вирішення
   - Коефіцієнт вирішення
   - Ефективність роботи

5. ВИСНОВКИ ТА РЕКОМЕНДАЦІЇ
   - Ключові висновки
   - Рекомендації для покращення
   - Пріоритетні напрямки

ВАЖЛИВО:
- Використовуйте конкретні цифри та факти
- Будьте професійними та об'єктивними
- Надавайте практичні рекомендації
- МОВА: Українська
- СТИЛЬ: Діловий, структурований
`;

      const ticketsSample = tickets.slice(0, 30);
      const ticketsContext = ticketsSample.map((ticket, index) => {
        return `Заявка #${index + 1}: "${ticket.title}" - ${ticket.status} (${ticket.priority}) - ${ticket.city?.name || 'Невідомо'}`;
      }).join('\n');

      const reportContext = `
ПЕРІОД ЗВІТУ: ${context.startDate || 'Не вказано'} - ${context.endDate || 'Не вказано'}

ЗАГАЛЬНА СТАТИСТИКА:
- Всього заявок: ${analyticsData?.overview?.totalTickets || 0}
- Відкритих: ${analyticsData?.ticketsByStatus?.find(s => s._id === 'open')?.count || 0}
- В процесі: ${analyticsData?.ticketsByStatus?.find(s => s._id === 'in_progress')?.count || 0}
- Вирішених: ${analyticsData?.ticketsByStatus?.find(s => s._id === 'resolved')?.count || 0}
- Закритих: ${analyticsData?.ticketsByStatus?.find(s => s._id === 'closed')?.count || 0}

ПРІОРИТЕТИ:
- Низький: ${analyticsData?.ticketsByPriority?.find(p => p._id === 'low')?.count || 0}
- Середній: ${analyticsData?.ticketsByPriority?.find(p => p._id === 'medium')?.count || 0}
- Високий: ${analyticsData?.ticketsByPriority?.find(p => p._id === 'high')?.count || 0}

ПРОДУКТИВНІСТЬ:
- Середній час вирішення: ${analyticsData?.avgResolutionTime ? Math.round(analyticsData.avgResolutionTime) : 0} годин
- Коефіцієнт вирішення: ${analyticsData?.overview?.totalTickets > 0 
  ? Math.round(((analyticsData?.ticketsByStatus?.find(s => s._id === 'resolved')?.count || 0) / analyticsData.overview.totalTickets) * 100) 
  : 0}%

ПРИКЛАДИ ЗАЯВОК (${ticketsSample.length} з ${tickets.length}):
${ticketsContext}

${analyticsData?.topCities && analyticsData.topCities.length > 0 ? `
ТОП МІСТА:
${analyticsData.topCities.slice(0, 5).map((city, i) => 
  `${i + 1}. ${city.cityName || 'Невідомо'}: ${city.count} заявок`
).join('\n')}
` : ''}

Створіть детальний професійний звіт на основі цих даних. Використовуйте конкретні цифри, виявіть тренди та надайте практичні рекомендації.
`;

      const chatCompletion = await this.client.chat.completions.create({
        messages: [
          { role: 'system', content: systemPrompt },
          { role: 'user', content: reportContext }
        ],
        model: this.settings.groqModel || 'llama-3.3-70b-versatile',
        temperature: 0.5, // Середня температура для балансу структурованості та креативності
        max_tokens: 3000, // Більше токенів для детального звіту
        stream: false
      });

      const reportText = chatCompletion.choices[0]?.message?.content;
      if (!reportText) {
        logger.warn('Groq повернув порожню відповідь при генерації звіту');
        return null;
      }

      // Трекінг використання API
      await this.trackApiUsage(
        this.settings.groqModel || 'llama-3.3-70b-versatile',
        chatCompletion,
        { tokensUsed: chatCompletion.usage?.total_tokens || 0 }
      );

      return {
        report: reportText,
        generatedAt: new Date().toISOString(),
        period: {
          start: context.startDate,
          end: context.endDate
        },
        statistics: {
          totalTickets: analyticsData?.overview?.totalTickets || 0,
          analyzedTickets: ticketsSample.length
        }
      };
    } catch (error) {
      logger.error('Помилка генерації AI звіту:', error);
      return null;
    }
  }

  /**
   * Генерує FAQ статті на основі аналізу заявок та коментарів
   * @param {Array} tickets - Масив тікетів для аналізу
   * @param {Object} options - Опції генерації (minFrequency, maxItems)
   * @returns {Promise<Array>} - Масив згенерованих FAQ статей
   */
  async generateFAQ(tickets = [], options = {}) {
    try {
      if (!this.client) {
        await this.initialize();
      }

      if (!this.client) {
        return null;
      }

      const minFrequency = options.minFrequency || 2; // Мінімальна кількість подібних заявок
      const maxItems = options.maxItems || 20; // Максимальна кількість FAQ

      const systemPrompt = `
Ви - експерт зі створення FAQ (Часті питання) для системи HelpDesk. Ваше завдання - проаналізувати заявки та коментарі та створити корисні FAQ статті.

ЗАВДАННЯ:
1. Виявити найчастіші питання/проблеми на основі аналізу заявок
2. Створити чіткі питання та відповіді
3. Використати рішення з коментарів для формулювання відповідей
4. Групувати подібні питання
5. Створити структуровані FAQ статті

ФОРМАТ ВІДПОВІДІ (JSON):
{
  "faqItems": [
    {
      "question": "Точне формулювання питання українською мовою",
      "answer": "Детальна відповідь на основі аналізу заявок та коментарів",
      "category": "Категорія (Hardware|Software|Network|Access|Other|General)",
      "tags": ["тег1", "тег2"],
      "frequency": 5, // Кількість подібних заявок
      "examples": ["Приклад заявки 1", "Приклад заявки 2"], // Приклади заявок
      "priority": "high|medium|low" // Пріоритет на основі частоти
    }
  ],
  "summary": "Короткий опис згенерованих FAQ",
  "totalQuestions": 15, // Загальна кількість питань
  "categories": ["Hardware", "Software", "Network"] // Список категорій
}

ВАЖЛИВО:
- Питання мають бути конкретними та зрозумілими
- Відповіді мають бути практичними та корисними
- Використовуйте реальні рішення з коментарів
- МОВА: Українська
- Мінімальна частота для включення: ${minFrequency} заявок
- Максимум ${maxItems} FAQ статей
`;

      // Формуємо контекст з заявками та коментарями
      const ticketsWithComments = tickets
        .filter(t => t.comments && t.comments.length > 0)
        .slice(0, 100); // Аналізуємо до 100 заявок з коментарями

      const ticketsContext = ticketsWithComments.map((ticket, index) => {
        const comments = ticket.comments
          .filter(c => !c.isInternal) // Тільки публічні коментарі
          .map(c => c.content)
          .join(' | ');
        
        return `
ЗАЯВКА #${index + 1}:
- Заголовок: ${ticket.title || 'Не вказано'}
- Опис: ${(ticket.description || 'Не вказано').substring(0, 300)}
- Категорія: ${ticket.subcategory || 'Не вказано'}
- Статус: ${ticket.status}
- Коментарі з рішеннями: ${comments.substring(0, 500)}
`;
      }).join('\n---\n');

      const analysisContext = `
АНАЛІЗ ЗАЯВОК ДЛЯ ГЕНЕРАЦІЇ FAQ:

Всього заявок проаналізовано: ${ticketsWithComments.length}
Всього заявок в системі: ${tickets.length}

ЗАЯВКИ З КОМЕНТАРЯМИ (рішеннями):
${ticketsContext || 'Немає заявок з коментарями'}

ЗАВДАННЯ:
1. Виявіть найчастіші питання/проблеми
2. Створіть чіткі FAQ статті з питаннями та відповідями
3. Використайте рішення з коментарів для формулювання відповідей
4. Групуйте подібні питання
5. Вкажіть категорії та теги

Створіть корисні FAQ статті на основі цих даних. Включіть тільки питання, які зустрічаються принаймні ${minFrequency} рази.
`;

      const chatCompletion = await this.client.chat.completions.create({
        messages: [
          { role: 'system', content: systemPrompt },
          { role: 'user', content: analysisContext }
        ],
        model: this.settings.groqModel || 'llama-3.3-70b-versatile',
        temperature: 0.4, // Середня температура для балансу структурованості та креативності
        max_tokens: 4000, // Більше токенів для багатьох FAQ
        response_format: { type: 'json_object' }
      });

      const responseText = chatCompletion.choices[0]?.message?.content;
      if (!responseText) {
        logger.warn('Groq повернув порожню відповідь при генерації FAQ');
        return null;
      }

      const result = JSON.parse(responseText);
      
      // Трекінг використання API
      await this.trackApiUsage(
        this.settings.groqModel || 'llama-3.3-70b-versatile',
        chatCompletion,
        { tokensUsed: chatCompletion.usage?.total_tokens || 0 }
      );
      
      // Фільтруємо FAQ за мінімальною частотою
      if (result.faqItems) {
        result.faqItems = result.faqItems
          .filter(item => item.frequency >= minFrequency)
          .slice(0, maxItems);
        result.totalQuestions = result.faqItems.length;
      }

      logger.info('Результат AI генерації FAQ:', { 
        totalFAQ: result.faqItems?.length || 0,
        categories: result.categories || []
      });

      return result;
    } catch (error) {
      logger.error('Помилка генерації FAQ через Groq:', error);
      return null;
    }
  }

  /**
   * Транскрибує аудіофайл за допомогою Groq Whisper
   */
  async transcribeAudio(filePath) {
    try {
      if (!this.client) {
        await this.initialize();
      }

      if (!this.client) {
        return null;
      }

      const transcription = await this.client.audio.transcriptions.create({
        file: fs.createReadStream(filePath),
        model: 'whisper-large-v3',
        response_format: 'json',
        language: 'uk' // Пріоритет для української
      });

      // Трекінг використання (аудіо)
      await this.trackApiUsage('whisper-large-v3', null, { audioSeconds: 30 }); // Приблизна оцінка

      return transcription.text;
    } catch (error) {
      logger.error('Помилка транскрибації аудіо через Groq:', error);
      return null;
    }
  }

  /**
   * Відстеження використання Groq API та перевірка лімітів
   */
  async trackApiUsage(model, response = null, extraData = {}) {
    try {
      const usage = await GroqApiUsage.getTodayUsage();
      
      // Оновлюємо статистику використання
      const tokensUsed = response?.usage?.total_tokens || extraData.tokensUsed || 0;
      const audioSeconds = extraData.audioSeconds || 0;
      
      await usage.updateUsage(model, { tokensUsed, audioSeconds });
      
      // Оновлюємо ліміти з headers (якщо є response)
      if (response?.headers) {
        await usage.updateRateLimits(response.headers);
        
        // Перевіряємо чи потрібно сповіщення
        const notificationData = usage.shouldNotify();
        
        if (notificationData) {
          await this.sendLimitNotification(notificationData, usage);
        }
      } else {
        // Groq SDK не повертає headers - використовуємо дефолтні ліміти для безкоштовного плану
        // Free Tier: 14,400 RPD (requests per day), 7,000 RPM (tokens per minute)
        const defaultLimits = {
          'x-ratelimit-remaining-requests': usage.rateLimits?.remainingRequests || 14400,
          'x-ratelimit-remaining-tokens': usage.rateLimits?.remainingTokens || 7000,
          'x-ratelimit-limit-requests': 14400,
          'x-ratelimit-limit-tokens': 7000
        };
        
        // Віднімаємо використані ресурси
        defaultLimits['x-ratelimit-remaining-requests'] -= 1;
        defaultLimits['x-ratelimit-remaining-tokens'] -= tokensUsed;
        
        await usage.updateRateLimits(defaultLimits);
        
        logger.debug('Використано fallback ліміти (SDK не повертає headers)');
      }
      
      logger.debug('API usage tracked', { 
        model, 
        tokensUsed, 
        audioSeconds,
        remainingRequests: usage.rateLimits?.remainingRequests,
        remainingTokens: usage.rateLimits?.remainingTokens
      });
    } catch (error) {
      logger.error('Помилка трекінгу API використання:', error);
    }
  }

  /**
   * Відправка сповіщення адміну про наближення до ліміту
   */
  async sendLimitNotification(notificationData, usage) {
    try {
      const { level, requestsPercentage, tokensPercentage, remainingRequests, remainingTokens } = notificationData;
      
      let message = '';
      let emoji = '';
      
      if (level === 'critical') {
        emoji = '🚨';
        message = `${emoji} <b>КРИТИЧНО! Ліміт Groq API майже вичерпано!</b>\n\n`;
      } else {
        emoji = '⚠️';
        message = `${emoji} <b>Попередження: Ліміт Groq API</b>\n\n`;
      }
      
      message += `📊 <b>Статус на сьогодні:</b>\n`;
      message += `├ Залишилось запитів: <b>${remainingRequests}</b> (${requestsPercentage}%)\n`;
      message += `├ Залишилось токенів: <b>${remainingTokens}</b> (${tokensPercentage}%)\n`;
      message += `└ Оновлення: ${usage.rateLimits?.resetRequests || 'невідомо'}\n\n`;
      
      const llamaUsage = usage.modelUsage?.['llama-3.3-70b-versatile'] || {};
      const whisperUsage = usage.modelUsage?.['whisper-large-v3'] || {};
      
      message += `🤖 <b>Використання моделей:</b>\n`;
      message += `├ LLaMA 3.3 70B: ${llamaUsage.requestsCount || 0} запитів, ${llamaUsage.tokensUsed || 0} токенів\n`;
      message += `└ Whisper: ${whisperUsage.requestsCount || 0} запитів, ${whisperUsage.audioSecondsUsed || 0} сек\n\n`;
      
      if (level === 'critical') {
        message += `💡 <b>Рекомендації:</b>\n`;
        message += `• Розглянути покупку Developer Plan\n`;
        message += `• Тимчасово обмежити AI функції\n`;
        message += `• Перевірити ліміти: https://console.groq.com/settings/limits`;
      } else {
        message += `💡 Слідкуйте за використанням API протягом дня.`;
      }
      
      // Відправка через telegramService
      const telegramService = require('./telegramServiceInstance');
      await telegramService.sendMessage(this.adminTelegramId, message, {
        parse_mode: 'HTML'
      });
      
      // Позначаємо що сповіщення відправлено
      await usage.markNotified(level);
      
      logger.info(`${emoji} Сповіщення про ліміт API відправлено адміну`, { level, requestsPercentage, tokensPercentage });
    } catch (error) {
      logger.error('Помилка відправки сповіщення про ліміт:', error);
    }
  }

  /**
   * Отримати статистику використання API
   */
  async getUsageStats(days = 7) {
    try {
      const startDate = new Date();
      startDate.setDate(startDate.getDate() - days);
      startDate.setHours(0, 0, 0, 0);
      
      const stats = await GroqApiUsage.find({
        date: { $gte: startDate }
      }).sort({ date: -1 });
      
      return stats;
    } catch (error) {
      logger.error('Помилка отримання статистики API:', error);
      return [];
    }
  }
}

module.exports = new GroqService();
